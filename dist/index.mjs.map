{"version":3,"sources":["../src/dom/styles.ts","../src/toolbar/toolbar.ts","../src/dom/candidates.ts","../src/dom/format.ts","../src/core/sanitizeURL.ts","../src/core/history.ts","../src/core/formatActions.ts","../src/dom/handlers.ts","../src/core/editor.ts"],"sourcesContent":["/**\r\n * Inject CSS styles into the document for editor UI\r\n *\r\n * Adds styling for:\r\n * - `.editor-editable-element`: Dashed outline for hoverable elements\r\n * - `.editor-active-element`: Solid green outline for active editing element\r\n *\r\n * Uses a style ID to prevent duplicate injections\r\n *\r\n * @param doc - Document to inject styles into\r\n */\r\nimport {\r\n  STYLE_ID,\r\n  CLASS_EDITABLE,\r\n  CLASS_ACTIVE,\r\n  HOVER_OUTLINE,\r\n  ACTIVE_OUTLINE,\r\n  TOOLBAR_ID,\r\n  TOOLBAR_BG,\r\n  TOOLBAR_BORDER,\r\n  BUTTON_BORDER,\r\n  BUTTON_ACTIVE_BG,\r\n  BUTTON_BG,\r\n  BUTTON_COLOR,\r\n  INFO_COLOR,\r\n} from \"../core/constants\";\r\n\r\nexport function injectStyles(doc: Document): void {\r\n  const styleId = STYLE_ID;\r\n  let styleEl = doc.getElementById(styleId) as HTMLStyleElement | null;\r\n  const css = `\r\n.${CLASS_EDITABLE}{outline:2px dashed ${HOVER_OUTLINE};cursor:text}\r\n.${CLASS_ACTIVE}{outline:2px solid ${ACTIVE_OUTLINE};cursor:text}\r\n#${TOOLBAR_ID}{\r\n  position: sticky;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  z-index: 9999;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 8px 12px;\r\n  background: ${TOOLBAR_BG};\r\n  border-bottom: 1px solid ${TOOLBAR_BORDER};\r\n  font-family: inherit;\r\n  box-shadow: 0 6px 18px rgba(2,6,23,0.08);\r\n  backdrop-filter: blur(6px);\r\n}\r\n#${TOOLBAR_ID} button{\r\n  padding: 6px 8px;\r\n  border: 1px solid ${BUTTON_BORDER};\r\n  background: ${BUTTON_BG};\r\n  color: ${BUTTON_COLOR};\r\n  border-radius: 8px;\r\n  font-weight: 500;\r\n  cursor: pointer;\r\n  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;\r\n  outline: none;\r\n  margin-right: 2px;\r\n}\r\n#${TOOLBAR_ID} button[aria-pressed=\"true\"]{\r\n  background: ${BUTTON_ACTIVE_BG};\r\n  font-weight: 600;\r\n  box-shadow: 0 6px 12px rgba(99,102,241,0.12);\r\n}\r\n#${TOOLBAR_ID} button:hover:not(:disabled){\r\n  transform: translateY(-2px);\r\n  box-shadow: 0 8px 20px rgba(2,6,23,0.08);\r\n}\r\n#${TOOLBAR_ID} select, #${TOOLBAR_ID} input[type=\"color\"]{\r\n  padding: 6px 8px;\r\n  border-radius: 8px;\r\n  border: 1px solid ${BUTTON_BORDER};\r\n  background: #fff;\r\n  font-family: inherit;\r\n}\r\n#${TOOLBAR_ID} span{\r\n  margin-left: 16px;\r\n  color: ${INFO_COLOR};\r\n  font-size: 90%;\r\n}\r\n\r\n/* Grouping and separators */\r\n#${TOOLBAR_ID} .toolbar-group{\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n#${TOOLBAR_ID} .toolbar-sep{\r\n  width: 1px;\r\n  height: 28px;\r\n  background: rgba(15,23,42,0.06);\r\n  margin: 0 8px;\r\n  border-radius: 1px;\r\n}\r\n#${TOOLBAR_ID} .toolbar-spacer{\r\n  flex: 1 1 auto;\r\n}\r\n#${TOOLBAR_ID} button svg{\r\n  width: 16px;\r\n  height: 16px;\r\n  display: block;\r\n  /* Default: use stroke icons (outline) so they look like Phosphor regular */\r\n  fill: none;\r\n  stroke: currentColor;\r\n  stroke-width: 1.6;\r\n}\r\n\r\n/* Active/pressed: switch to filled appearance */\r\n#${TOOLBAR_ID} button[aria-pressed=\"true\"] svg{\r\n  fill: currentColor;\r\n  stroke: none;\r\n}\r\n\r\n/* Focus and accessibility */\r\n#${TOOLBAR_ID} button:focus{\r\n  outline: none;\r\n  box-shadow: 0 0 0 4px rgba(99,102,241,0.12);\r\n}\r\n\r\n/* Disabled state */\r\n#${TOOLBAR_ID} button:disabled{\r\n  opacity: 0.48;\r\n  cursor: not-allowed;\r\n}\r\n`;\r\n  if (!styleEl) {\r\n    styleEl = doc.createElement(\"style\");\r\n    styleEl.id = styleId;\r\n    doc.head.appendChild(styleEl);\r\n  }\r\n  styleEl.textContent = css;\r\n}\r\n","/**\r\n * Inject and render the formatting toolbar into the document\r\n *\r\n * Creates a sticky toolbar with:\r\n * - Text formatting buttons (Bold, Italic, Underline)\r\n * - Font and size selectors\r\n * - Undo/Redo buttons\r\n * - Link insertion button\r\n * - Color pickers (text and highlight)\r\n * - Text alignment buttons\r\n * - Selected element info display\r\n *\r\n * The toolbar is re-injected on every selection change to update state\r\n * (this is optimized for small toolbar size and few state changes)\r\n *\r\n * @param doc - Document to inject toolbar into\r\n * @param options - Toolbar configuration and callbacks\r\n */\r\nimport {\r\n  TOOLBAR_ID,\r\n  LABEL_BOLD,\r\n  LABEL_ITALIC,\r\n  LABEL_UNDERLINE,\r\n  LABEL_STRIKETHROUGH,\r\n  LABEL_UNDO,\r\n  LABEL_REDO,\r\n  LABEL_LINK,\r\n  LABEL_ALIGN_LEFT,\r\n  LABEL_ALIGN_CENTER,\r\n  LABEL_ALIGN_RIGHT,\r\n  FONT_OPTIONS,\r\n  SIZE_OPTIONS,\r\n  FORMAT_OPTIONS,\r\n  PALETTE_SVG,\r\n} from \"../core/constants\";\r\n\r\nexport function injectToolbar(\r\n  doc: Document,\r\n  options: {\r\n    onCommand: (command: string, value?: string) => void;\r\n    canUndo: () => boolean;\r\n    canRedo: () => boolean;\r\n    onUndo: () => void;\r\n    onRedo: () => void;\r\n    getFormatState: () => {\r\n      bold: boolean;\r\n      italic: boolean;\r\n      underline: boolean;\r\n    };\r\n    getSelectedElementInfo: () => string | null;\r\n  }\r\n) {\r\n  const existing = doc.getElementById(TOOLBAR_ID);\r\n  if (existing) existing.remove();\r\n\r\n  const toolbar = doc.createElement(\"div\");\r\n  toolbar.id = TOOLBAR_ID;\r\n  // Accessibility: expose as a toolbar region and provide a readable label\r\n  toolbar.setAttribute(\"role\", \"toolbar\");\r\n  toolbar.setAttribute(\"aria-label\", \"Rich text editor toolbar\");\r\n\r\n  // Styling moved to injected stylesheet (see src/dom/styles.ts)\r\n\r\n  function makeButton(\r\n    label: string,\r\n    title: string,\r\n    command: string,\r\n    value?: string,\r\n    isActive?: boolean,\r\n    disabled?: boolean\r\n  ) {\r\n    const btn = doc.createElement(\"button\");\r\n    btn.type = \"button\";\r\n    // If caller provided an HTML label (e.g. \"<i>I</i>\"), render it as HTML.\r\n    // Otherwise set textContent for safety.\r\n    if (label && label.trim().startsWith(\"<\")) {\r\n      btn.innerHTML = label;\r\n    } else {\r\n      btn.textContent = label;\r\n    }\r\n    btn.title = title;\r\n    // Accessibility: aria-label + keyboard focusability + pressed state\r\n    btn.setAttribute(\"aria-label\", title);\r\n    if (typeof isActive !== \"undefined\")\r\n      btn.setAttribute(\"aria-pressed\", String(!!isActive));\r\n    btn.tabIndex = 0;\r\n    // Visual appearance handled by stylesheet; use ARIA pressed for active state\r\n    if (disabled) btn.disabled = true;\r\n    btn.onclick = () => options.onCommand(command, value);\r\n    // Keyboard activation: Enter or Space should trigger\r\n    btn.addEventListener(\"keydown\", (ev) => {\r\n      if (ev.key === \"Enter\" || ev.key === \" \") {\r\n        ev.preventDefault();\r\n        btn.click();\r\n      }\r\n    });\r\n    return btn;\r\n  }\r\n\r\n  function makeSelect(\r\n    title: string,\r\n    command: string,\r\n    optionsList: { label: string; value: string }[]\r\n  ) {\r\n    const select = doc.createElement(\"select\");\r\n    select.title = title;\r\n    select.setAttribute(\"aria-label\", title);\r\n    // Select styling handled in stylesheet\r\n    select.appendChild(new Option(title, \"\", true, true));\r\n    for (const opt of optionsList) {\r\n      select.appendChild(new Option(opt.label, opt.value));\r\n    }\r\n    select.onchange = (e) => {\r\n      const val = (e.target as HTMLSelectElement).value;\r\n      options.onCommand(command, val);\r\n      select.selectedIndex = 0;\r\n    };\r\n    return select;\r\n  }\r\n\r\n  function makeColorInput(title: string, command: string) {\r\n    const label = doc.createElement(\"label\");\r\n    label.title = title;\r\n    label.setAttribute(\"aria-label\", title);\r\n    label.className = \"color-input-label\";\r\n    // Palette icon (inline SVG) placed before the native color input\r\n    // const icon = doc.createElement(\"span\");\r\n    // icon.className = \"color-palette-icon\";\r\n    // icon.innerHTML = PALETTE_SVG;\r\n    const input = doc.createElement(\"input\");\r\n    input.type = \"color\";\r\n    input.className = \"toolbar-color-input\";\r\n    input.onchange = (e) => {\r\n      options.onCommand(command, (e.target as HTMLInputElement).value);\r\n    };\r\n    // label.appendChild(icon);\r\n    label.appendChild(input);\r\n    return label;\r\n  }\r\n\r\n  const format = options.getFormatState();\r\n  // Helpers: group wrapper and separator element\r\n  function makeGroup() {\r\n    const g = doc.createElement(\"div\");\r\n    g.className = \"toolbar-group\";\r\n    return g;\r\n  }\r\n\r\n  function makeSep() {\r\n    const s = doc.createElement(\"div\");\r\n    s.className = \"toolbar-sep\";\r\n    return s;\r\n  }\r\n\r\n  // Section 1: Undo / Redo\r\n  const undoBtn = makeButton(\r\n    LABEL_UNDO,\r\n    \"Undo\",\r\n    \"undo\",\r\n    undefined,\r\n    false,\r\n    !options.canUndo()\r\n  );\r\n  // Undo/Redo are handled by the history module â€” call handlers directly\r\n  undoBtn.onclick = () => options.onUndo();\r\n\r\n  const redoBtn = makeButton(\r\n    LABEL_REDO,\r\n    \"Redo\",\r\n    \"redo\",\r\n    undefined,\r\n    false,\r\n    !options.canRedo()\r\n  );\r\n  redoBtn.onclick = () => options.onRedo();\r\n\r\n  const grp1 = makeGroup();\r\n  grp1.appendChild(undoBtn);\r\n  grp1.appendChild(redoBtn);\r\n  toolbar.appendChild(grp1);\r\n  toolbar.appendChild(makeSep());\r\n\r\n  // Section 2: Format, Font & Size\r\n  const grp2 = makeGroup();\r\n  grp2.appendChild(makeSelect(\"Format\", \"formatBlock\", FORMAT_OPTIONS));\r\n  grp2.appendChild(makeSelect(\"Font\", \"fontName\", FONT_OPTIONS));\r\n  grp2.appendChild(makeSelect(\"Size\", \"fontSize\", SIZE_OPTIONS));\r\n  toolbar.appendChild(grp2);\r\n  toolbar.appendChild(makeSep());\r\n\r\n  // Section 3: Bold, Italic, Underline, Strikethrough\r\n  const grp3 = makeGroup();\r\n  grp3.appendChild(\r\n    makeButton(LABEL_BOLD, \"Bold\", \"bold\", undefined, format.bold)\r\n  );\r\n  grp3.appendChild(\r\n    makeButton(LABEL_ITALIC, \"Italic\", \"italic\", undefined, format.italic)\r\n  );\r\n  grp3.appendChild(\r\n    makeButton(\r\n      LABEL_UNDERLINE,\r\n      \"Underline\",\r\n      \"underline\",\r\n      undefined,\r\n      format.underline\r\n    )\r\n  );\r\n  grp3.appendChild(makeButton(LABEL_STRIKETHROUGH, \"Strikethrough\", \"strike\"));\r\n  toolbar.appendChild(grp3);\r\n  toolbar.appendChild(makeSep());\r\n\r\n  // Section 4: Alignment\r\n  const grp4 = makeGroup();\r\n  grp4.appendChild(makeButton(LABEL_ALIGN_LEFT, \"Align left\", \"align\", \"left\"));\r\n  grp4.appendChild(\r\n    makeButton(LABEL_ALIGN_CENTER, \"Align center\", \"align\", \"center\")\r\n  );\r\n  grp4.appendChild(\r\n    makeButton(LABEL_ALIGN_RIGHT, \"Align right\", \"align\", \"right\")\r\n  );\r\n  toolbar.appendChild(grp4);\r\n  toolbar.appendChild(makeSep());\r\n\r\n  // Section 5: Colors\r\n  const grp5 = makeGroup();\r\n  grp5.appendChild(makeColorInput(\"Text color\", \"foreColor\"));\r\n  grp5.appendChild(makeColorInput(\"Highlight color\", \"hiliteColor\"));\r\n  toolbar.appendChild(grp5);\r\n  toolbar.appendChild(makeSep());\r\n\r\n  // Section 6: Link\r\n  const grp6 = makeGroup();\r\n  grp6.appendChild(makeButton(LABEL_LINK, \"Insert link\", \"link\"));\r\n  toolbar.appendChild(grp6);\r\n\r\n  // const info = doc.createElement(\"span\");\r\n  // // Info styles moved to stylesheet\r\n  // info.textContent = options.getSelectedElementInfo()\r\n  //   ? `Selected: ${options.getSelectedElementInfo()}`\r\n  //   : \"Click any highlighted element to edit\";\r\n  // toolbar.appendChild(info);\r\n\r\n  // Keyboard navigation for toolbar (ArrowLeft/ArrowRight/Home/End)\r\n  toolbar.addEventListener(\"keydown\", (e) => {\r\n    const focusable = Array.from(\r\n      toolbar.querySelectorAll<HTMLElement>(\"button, select, input, [tabindex]\")\r\n    ).filter((el) => !el.hasAttribute(\"disabled\"));\r\n    if (!focusable.length) return;\r\n    const idx = focusable.indexOf(document.activeElement as HTMLElement);\r\n    if (e.key === \"ArrowRight\") {\r\n      e.preventDefault();\r\n      const next =\r\n        focusable[Math.min(focusable.length - 1, Math.max(0, idx + 1))];\r\n      next?.focus();\r\n    } else if (e.key === \"ArrowLeft\") {\r\n      e.preventDefault();\r\n      const prev = focusable[Math.max(0, idx - 1)] || focusable[0];\r\n      prev?.focus();\r\n    } else if (e.key === \"Home\") {\r\n      e.preventDefault();\r\n      focusable[0].focus();\r\n    } else if (e.key === \"End\") {\r\n      e.preventDefault();\r\n      focusable[focusable.length - 1].focus();\r\n    }\r\n  });\r\n\r\n  doc.body.insertBefore(toolbar, doc.body.firstChild);\r\n}\r\n","/**\r\n * Check if an element can be edited\r\n *\r\n * Valid elements: Text container tags (p, div, section, etc.)\r\n * Invalid elements: HTML structure tags, inputs, scripts, styles\r\n *\r\n * @param el - Element to check\r\n * @returns True if element is a valid editable candidate\r\n */\r\nexport function isEditableCandidate(el: HTMLElement | null): boolean {\r\n  if (!el) return false;\r\n  const tag = el.tagName;\r\n  const DISALLOWED = [\r\n    \"HTML\",\r\n    \"HEAD\",\r\n    \"BODY\",\r\n    \"SCRIPT\",\r\n    \"STYLE\",\r\n    \"LINK\",\r\n    \"META\",\r\n    \"NOSCRIPT\",\r\n  ];\r\n  if (DISALLOWED.includes(tag)) return false;\r\n  if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return false;\r\n  return true;\r\n}\r\n","/**\r\n * Compute the current formatting state of selected text\r\n *\r\n * Detects bold, italic, and underline formatting based on:\r\n * - DOM element tags (strong, em, u)\r\n * - CSS computed styles (fontWeight, fontStyle, textDecoration)\r\n *\r\n * @param doc - Document context\r\n * @returns Object with boolean flags for bold, italic, underline\r\n */\r\nexport function computeFormatState(doc: Document): {\r\n  bold: boolean;\r\n  italic: boolean;\r\n  underline: boolean;\r\n} {\r\n  try {\r\n    const s = doc.getSelection();\r\n    let el: HTMLElement | null = null;\r\n    if (s && s.anchorNode)\r\n      el =\r\n        s.anchorNode.nodeType === Node.ELEMENT_NODE\r\n          ? (s.anchorNode as HTMLElement)\r\n          : (s.anchorNode.parentElement as HTMLElement);\r\n    if (!el) return { bold: false, italic: false, underline: false };\r\n    const computed = doc.defaultView?.getComputedStyle(el) as\r\n      | CSSStyleDeclaration\r\n      | undefined;\r\n    const bold = !!(\r\n      el.closest(\"strong, b\") ||\r\n      (computed &&\r\n        (computed.fontWeight === \"700\" || Number(computed.fontWeight) >= 700))\r\n    );\r\n    const italic = !!(\r\n      el.closest(\"em, i\") ||\r\n      (computed && computed.fontStyle === \"italic\")\r\n    );\r\n    const underline = !!(\r\n      el.closest(\"u\") ||\r\n      (computed && (computed.textDecorationLine || \"\").includes(\"underline\"))\r\n    );\r\n    return { bold, italic, underline };\r\n  } catch (err) {\r\n    return { bold: false, italic: false, underline: false };\r\n  }\r\n}\r\n\r\n/**\r\n * Get a human-readable label for an element\r\n *\r\n * Format: `tagname#id.class`\r\n * Example: `p#intro.highlight` or `div.container`\r\n *\r\n * @param el - HTML element to label\r\n * @returns Label string or null if element is null\r\n */\r\nexport function getElementLabel(el: HTMLElement | null): string | null {\r\n  if (!el) return null;\r\n  const id = el.id ? `#${el.id}` : \"\";\r\n  const cls = el.className ? `.${String(el.className).split(\" \")[0]}` : \"\";\r\n  const tag = el.tagName.toLowerCase();\r\n  return `${tag}${id}${cls}`;\r\n}\r\n","export function sanitizeURL(url: string): string {\r\n  if (!url) return \"\";\r\n  const trimmed = url.trim();\r\n  if (!trimmed) return \"\";\r\n  if (\r\n    trimmed.toLowerCase().startsWith(\"javascript:\") ||\r\n    trimmed.toLowerCase().startsWith(\"data:\")\r\n  ) {\r\n    console.warn(\"Blocked potentially dangerous URL protocol\");\r\n    return \"\";\r\n  }\r\n  if (!trimmed.startsWith(\"http\") && !trimmed.startsWith(\"#\")) {\r\n    return \"https://\" + trimmed;\r\n  }\r\n  return trimmed;\r\n}\r\n","import {\r\n  _getDoc,\r\n  _getUndoStack,\r\n  _getRedoStack,\r\n  _setUndoStack,\r\n  _setRedoStack,\r\n} from \"./state\";\r\nimport { sanitizeHtml } from \"../utils/sanitize\";\r\nimport { injectStyles } from \"../dom/styles\";\r\n\r\nexport function handleUndo() {\r\n  try {\r\n    const doc = _getDoc();\r\n    if (!doc) {\r\n      console.warn(\r\n        \"[rich-html-editor] handleUndo called before initialization\"\r\n      );\r\n      return;\r\n    }\r\n    if (_getUndoStack().length < 2) return;\r\n    const undoStack = _getUndoStack();\r\n    const redoStack = _getRedoStack();\r\n    const current = undoStack.pop()!;\r\n    redoStack.push(current);\r\n    const prev = undoStack[undoStack.length - 1];\r\n    if (!doc.documentElement) {\r\n      throw new Error(\"Document is missing documentElement\");\r\n    }\r\n    const safe = sanitizeHtml(prev.replace(/^<!doctype html>\\n?/i, \"\"), doc);\r\n    doc.documentElement.innerHTML = safe;\r\n    // Re-inject editor styles that were removed when the document HTML\r\n    // was replaced, and trigger a selectionchange so the toolbar is\r\n    // re-rendered by the existing selectionchange handler.\r\n    injectStyles(doc);\r\n    try {\r\n      doc.dispatchEvent(new Event(\"selectionchange\"));\r\n    } catch (err) {\r\n      /* ignore dispatch errors */\r\n    }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Undo failed:\", message);\r\n  }\r\n}\r\n\r\nexport function handleRedo() {\r\n  try {\r\n    const doc = _getDoc();\r\n    if (!doc) {\r\n      console.warn(\r\n        \"[rich-html-editor] handleRedo called before initialization\"\r\n      );\r\n      return;\r\n    }\r\n    if (!_getRedoStack().length) return;\r\n    const undoStack = _getUndoStack();\r\n    const redoStack = _getRedoStack();\r\n    const next = redoStack.pop()!;\r\n    undoStack.push(next);\r\n    if (!doc.documentElement) {\r\n      throw new Error(\"Document is missing documentElement\");\r\n    }\r\n    const safeNext = sanitizeHtml(\r\n      next.replace(/^<!doctype html>\\n?/i, \"\"),\r\n      doc\r\n    );\r\n    doc.documentElement.innerHTML = safeNext;\r\n    // Re-inject styles and notify listeners so toolbar/styles are restored\r\n    injectStyles(doc);\r\n    try {\r\n      doc.dispatchEvent(new Event(\"selectionchange\"));\r\n    } catch (err) {\r\n      /* ignore dispatch errors */\r\n    }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Redo failed:\", message);\r\n  }\r\n}\r\n","import { _getDoc, pushStandaloneSnapshot } from \"./state\";\r\nimport { sanitizeHtml } from \"../utils/sanitize\";\r\nimport { sanitizeURL } from \"./sanitizeURL\";\r\n\r\nexport function handleToolbarCommand(command: string, value?: string) {\r\n  try {\r\n    const doc = _getDoc();\r\n    if (!doc) {\r\n      console.warn(\r\n        \"[rich-html-editor] handleToolbarCommand called before initialization\"\r\n      );\r\n      return;\r\n    }\r\n    if (command === \"undo\") return; // delegated to history module\r\n    if (command === \"redo\") return; // delegated to history module\r\n    if (command === \"link\") {\r\n      const url = window.prompt(\"Enter URL (https://...):\", \"https://\");\r\n      if (url) {\r\n        const sanitized = sanitizeURL(url);\r\n        if (sanitized) applyStandaloneCommand(\"link\", sanitized);\r\n      }\r\n      return;\r\n    }\r\n    applyStandaloneCommand(command, value);\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Command handler failed:\", message);\r\n  }\r\n}\r\n\r\nexport function applyStandaloneCommand(command: string, value?: string) {\r\n  try {\r\n    const doc = _getDoc();\r\n    if (!doc) {\r\n      console.warn(\r\n        \"[rich-html-editor] applyStandaloneCommand called before initialization\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (command === \"bold\") wrapSelectionWithElement(doc, \"strong\");\r\n    else if (command === \"italic\") wrapSelectionWithElement(doc, \"em\");\r\n    else if (command === \"underline\") wrapSelectionWithElement(doc, \"u\");\r\n    else if (command === \"strike\") wrapSelectionWithElement(doc, \"s\");\r\n    else if (command === \"fontName\")\r\n      wrapSelectionWithElement(doc, \"span\", { fontFamily: value as any });\r\n    else if (command === \"fontSize\") {\r\n      // Accept numeric font-size values (e.g. \"12\", \"16\") and apply as px.\r\n      const raw = value || \"14\";\r\n      const n = parseInt(raw, 10);\r\n      const sz = Number.isFinite(n) ? `${n}px` : raw;\r\n      wrapSelectionWithElement(doc, \"span\", { fontSize: sz as any });\r\n    } else if (command === \"link\") {\r\n      const sel = doc.getSelection();\r\n      if (!sel || !sel.rangeCount) return;\r\n      const range = sel.getRangeAt(0);\r\n      const content = range.extractContents();\r\n      const a = doc.createElement(\"a\");\r\n      a.href = sanitizeURL(value || \"#\");\r\n      a.appendChild(content);\r\n      range.insertNode(a);\r\n    } else if (command === \"foreColor\")\r\n      wrapSelectionWithElement(doc, \"span\", { color: value as any });\r\n    else if (command === \"hiliteColor\")\r\n      wrapSelectionWithElement(doc, \"span\", { backgroundColor: value as any });\r\n    else if (command === \"align\") {\r\n      const sel = doc.getSelection();\r\n      const node = sel?.anchorNode || null;\r\n      const block = findBlockAncestor(node);\r\n      if (block) block.style.textAlign = value || \"left\";\r\n      else wrapSelectionWithElement(doc, \"div\", { textAlign: value as any });\r\n    } else if (command === \"formatBlock\") {\r\n      // Change block-level element to selected tag (p, h1..h6)\r\n      const sel = doc.getSelection();\r\n      const node = sel?.anchorNode || null;\r\n      const block = findBlockAncestor(node);\r\n      const tag = (value || \"p\").toLowerCase();\r\n      if (block && block.parentElement) {\r\n        // Replace existing block with new block of desired tag\r\n        const newEl = doc.createElement(tag);\r\n        // Preserve inline styles?\r\n        newEl.className = (block as HTMLElement).className || \"\";\r\n        while (block.firstChild) newEl.appendChild(block.firstChild);\r\n        block.parentElement.replaceChild(newEl, block);\r\n      } else {\r\n        // Wrap selection in the block tag\r\n        wrapSelectionWithElement(doc, tag);\r\n      }\r\n    }\r\n    pushStandaloneSnapshot();\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Apply command failed:\", message);\r\n  }\r\n}\r\n\r\nfunction wrapSelectionWithElement(\r\n  doc: Document,\r\n  tagName: string,\r\n  style?: Partial<CSSStyleDeclaration>\r\n): void {\r\n  const sel = doc.getSelection();\r\n  if (!sel) return;\r\n  if (!sel.rangeCount) return;\r\n  const range = sel.getRangeAt(0);\r\n  if (range.collapsed) {\r\n    const el = doc.createElement(tagName);\r\n    if (style) Object.assign(el.style, style as any);\r\n    const zw = doc.createTextNode(\"\\u200B\");\r\n    el.appendChild(zw);\r\n    range.insertNode(el);\r\n    const newRange = doc.createRange();\r\n    newRange.setStart(zw, 1);\r\n    newRange.collapse(true);\r\n    sel.removeAllRanges();\r\n    sel.addRange(newRange);\r\n    return;\r\n  }\r\n  const content = range.extractContents();\r\n  const wrapper = doc.createElement(tagName);\r\n  if (style) Object.assign(wrapper.style, style as any);\r\n  wrapper.appendChild(content);\r\n  range.insertNode(wrapper);\r\n  sel.removeAllRanges();\r\n  const newRange = doc.createRange();\r\n  newRange.selectNodeContents(wrapper);\r\n  sel.addRange(newRange);\r\n}\r\n\r\nfunction findBlockAncestor(node: Node | null): HTMLElement | null {\r\n  let n = node as Node | null;\r\n  const BLOCKS = [\r\n    \"P\",\r\n    \"DIV\",\r\n    \"SECTION\",\r\n    \"ARTICLE\",\r\n    \"LI\",\r\n    \"TD\",\r\n    \"BLOCKQUOTE\",\r\n    \"H1\",\r\n    \"H2\",\r\n    \"H3\",\r\n    \"H4\",\r\n    \"H5\",\r\n    \"H6\",\r\n  ];\r\n  while (n) {\r\n    if (n.nodeType === Node.ELEMENT_NODE) {\r\n      const el = n as HTMLElement;\r\n      if (BLOCKS.includes(el.tagName)) return el;\r\n    }\r\n    n = n.parentNode;\r\n  }\r\n  return null;\r\n}\r\n","import {\r\n  _getCurrentEditable,\r\n  _setCurrentEditable,\r\n  pushStandaloneSnapshot,\r\n  _getDoc,\r\n  _getUndoStack,\r\n  _getRedoStack,\r\n} from \"../core/state\";\r\nimport { isEditableCandidate } from \"./candidates\";\r\nimport { injectToolbar } from \"../toolbar/toolbar\";\r\nimport { computeFormatState, getElementLabel } from \"./format\";\r\nimport { handleToolbarCommand, handleUndo, handleRedo } from \"../core/commands\";\r\nimport { CLASS_ACTIVE } from \"../core/constants\";\r\n\r\n/**\r\n * Attach DOM event handlers to the document\r\n *\r\n * Handles:\r\n * - Click: Enables editing on valid elements\r\n * - Selection change: Updates toolbar state\r\n * - Input: Creates undo/redo snapshots\r\n *\r\n * @param doc - Document to attach handlers to\r\n */\r\nexport function attachStandaloneHandlers(doc: Document) {\r\n  doc.addEventListener(\r\n    \"click\",\r\n    (e) => {\r\n      const target = e.target as HTMLElement;\r\n      if (!isEditableCandidate(target)) return;\r\n      if (_getCurrentEditable() && _getCurrentEditable() !== target) {\r\n        _getCurrentEditable()?.removeAttribute(\"contenteditable\");\r\n        _getCurrentEditable()?.classList.remove(CLASS_ACTIVE);\r\n      }\r\n      _setCurrentEditable(target);\r\n      target.classList.add(CLASS_ACTIVE);\r\n      target.setAttribute(\"contenteditable\", \"true\");\r\n      target.focus();\r\n    },\r\n    true\r\n  );\r\n  doc.addEventListener(\"selectionchange\", () => {\r\n    injectToolbar(doc, {\r\n      onCommand: handleToolbarCommand,\r\n      canUndo: () => _getUndoStack().length > 1,\r\n      canRedo: () => _getRedoStack().length > 0,\r\n      onUndo: handleUndo,\r\n      onRedo: handleRedo,\r\n      getFormatState: () => computeFormatState(doc),\r\n      getSelectedElementInfo: () => getElementLabel(_getCurrentEditable()),\r\n    });\r\n  });\r\n  doc.addEventListener(\"input\", () => pushStandaloneSnapshot(), true);\r\n\r\n  // Keyboard shortcuts for common formatting and undo/redo\r\n  doc.addEventListener(\r\n    \"keydown\",\r\n    (e) => {\r\n      const meta = e.ctrlKey || e.metaKey;\r\n      if (!meta) return;\r\n      const key = e.key.toLowerCase();\r\n      // Bold: Ctrl/Cmd+B\r\n      if (key === \"b\") {\r\n        e.preventDefault();\r\n        handleToolbarCommand(\"bold\");\r\n        return;\r\n      }\r\n      // Italic: Ctrl/Cmd+I\r\n      if (key === \"i\") {\r\n        e.preventDefault();\r\n        handleToolbarCommand(\"italic\");\r\n        return;\r\n      }\r\n      // Underline: Ctrl/Cmd+U\r\n      if (key === \"u\") {\r\n        e.preventDefault();\r\n        handleToolbarCommand(\"underline\");\r\n        return;\r\n      }\r\n      // Undo: Ctrl/Cmd+Z\r\n      if (key === \"z\") {\r\n        e.preventDefault();\r\n        // If Shift is pressed, treat as redo\r\n        if (e.shiftKey) {\r\n          handleRedo();\r\n        } else {\r\n          handleUndo();\r\n        }\r\n        return;\r\n      }\r\n      // Redo: Ctrl/Cmd+Y\r\n      if (key === \"y\") {\r\n        e.preventDefault();\r\n        handleRedo();\r\n        return;\r\n      }\r\n    },\r\n    true\r\n  );\r\n}\r\n","import {\r\n  _setDoc,\r\n  _getDoc,\r\n  _setUndoStack,\r\n  _getUndoStack,\r\n  _setRedoStack,\r\n  _getRedoStack,\r\n  _setCurrentEditable,\r\n  _getCurrentEditable,\r\n  pushStandaloneSnapshot,\r\n} from \"./state\";\r\nimport { injectStyles } from \"../dom/styles\";\r\nimport { injectToolbar } from \"../toolbar/toolbar\";\r\nimport { attachStandaloneHandlers } from \"../dom/handlers\";\r\nimport { computeFormatState, getElementLabel } from \"../dom/format\";\r\nimport { handleUndo, handleRedo, handleToolbarCommand } from \"./commands\";\r\nimport type { EditorConfig } from \"./types\";\r\nimport { sanitizeHtml } from \"../utils/sanitize\";\r\nimport {\r\n  TOOLBAR_ID,\r\n  STYLE_ID,\r\n  CLASS_EDITABLE,\r\n  CLASS_ACTIVE,\r\n} from \"./constants\";\r\n\r\n/**\r\n * Initialize the rich HTML editor on an iframe element\r\n *\r\n * Sets up:\r\n * - State management (undo/redo stacks, current editable element)\r\n * - DOM styles for editable element highlighting\r\n * - Event handlers for click, selection change, and input events\r\n * - Toolbar UI with formatting buttons\r\n *\r\n * @param iframe - The target iframe element to enable editing on\r\n * @throws {Error} If iframe is invalid or contentDocument is not accessible\r\n *\r\n * @example\r\n * ```typescript\r\n * const iframe = document.querySelector('iframe');\r\n * initRichEditor(iframe);\r\n * ```\r\n */\r\nexport function initRichEditor(\r\n  iframe: HTMLIFrameElement,\r\n  config?: EditorConfig\r\n) {\r\n  try {\r\n    if (!iframe || !(iframe instanceof HTMLIFrameElement)) {\r\n      throw new Error(\"Invalid iframe element provided to initRichEditor\");\r\n    }\r\n\r\n    const doc = iframe.contentDocument;\r\n    if (!doc) {\r\n      throw new Error(\r\n        \"Unable to access iframe contentDocument. Ensure iframe src is same-origin.\"\r\n      );\r\n    }\r\n\r\n    _setDoc(doc);\r\n    injectStyles(doc);\r\n    _setUndoStack([]);\r\n    _setRedoStack([]);\r\n    _setCurrentEditable(null);\r\n    if (config?.maxStackSize) {\r\n      // lazy set max stack size if provided (non-blocking)\r\n      import(\"./state\")\r\n        .then((m) => m.setMaxStackSize(config.maxStackSize!))\r\n        .catch(() => {\r\n          /* ignore */\r\n        });\r\n    }\r\n    attachStandaloneHandlers(doc);\r\n    pushStandaloneSnapshot();\r\n    injectToolbar(doc, {\r\n      onCommand: handleToolbarCommand,\r\n      canUndo: () => _getUndoStack().length > 1,\r\n      canRedo: () => _getRedoStack().length > 0,\r\n      onUndo: handleUndo,\r\n      onRedo: handleRedo,\r\n      getFormatState: () => computeFormatState(doc),\r\n      getSelectedElementInfo: () => getElementLabel(_getCurrentEditable()),\r\n    });\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Failed to initialize editor:\", message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get the cleaned HTML content from the edited document\r\n *\r\n * Returns the full HTML document with proper DOCTYPE declaration\r\n *\r\n * @returns HTML string with DOCTYPE, or empty string if editor not initialized\r\n * @throws {Error} If document is not properly initialized\r\n *\r\n * @example\r\n * ```typescript\r\n * const html = getCleanHTML();\r\n * console.log(html); // <!doctype html>\\n<html>...</html>\r\n * ```\r\n */\r\nexport function getCleanHTML(): string {\r\n  try {\r\n    const doc = _getDoc();\r\n    if (!doc) {\r\n      console.warn(\r\n        \"[rich-html-editor] getCleanHTML called before editor initialization\"\r\n      );\r\n      return \"\";\r\n    }\r\n    if (!doc.documentElement) {\r\n      throw new Error(\"Document is missing documentElement\");\r\n    }\r\n    // Clone the document element and strip injected UI and editing attributes\r\n    const clone = doc.documentElement.cloneNode(true) as HTMLElement;\r\n\r\n    // Remove injected toolbar and style elements if present\r\n    const toolbarNode = clone.querySelector(`#${TOOLBAR_ID}`);\r\n    if (toolbarNode && toolbarNode.parentNode)\r\n      toolbarNode.parentNode.removeChild(toolbarNode);\r\n    const styleNode = clone.querySelector(`#${STYLE_ID}`);\r\n    if (styleNode && styleNode.parentNode)\r\n      styleNode.parentNode.removeChild(styleNode);\r\n\r\n    // Remove editor-specific attributes/classes from cloned nodes so the\r\n    // resulting HTML is static (no contenteditable, no active/editable classes)\r\n    const editableNodes = clone.querySelectorAll(\r\n      \"[contenteditable], .\" + CLASS_EDITABLE + \", .\" + CLASS_ACTIVE\r\n    );\r\n    editableNodes.forEach((el) => {\r\n      try {\r\n        if (el instanceof Element) {\r\n          if (el.hasAttribute(\"contenteditable\"))\r\n            el.removeAttribute(\"contenteditable\");\r\n          if (el.hasAttribute(\"tabindex\")) el.removeAttribute(\"tabindex\");\r\n          el.classList.remove(CLASS_EDITABLE, CLASS_ACTIVE);\r\n        }\r\n      } catch (e) {\r\n        // ignore any removal errors on read-only or unexpected nodes\r\n      }\r\n    });\r\n\r\n    return \"<!doctype html>\\n\" + clone.outerHTML;\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Failed to get clean HTML:\", message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get a sanitized HTML string suitable for exporting to untrusted contexts.\r\n * This will run the same sanitizer used for snapshots/restores.\r\n */\r\nexport function getSanitizedHTML(): string {\r\n  try {\r\n    const doc = _getDoc();\r\n    if (!doc) return \"\";\r\n    if (!doc.documentElement)\r\n      throw new Error(\"Document is missing documentElement\");\r\n    const raw = \"<!doctype html>\\n\" + doc.documentElement.outerHTML;\r\n    return sanitizeHtml(raw, doc);\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[rich-html-editor] Failed to get sanitized HTML:\", message);\r\n    throw error;\r\n  }\r\n}\r\n"],"mappings":"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","names":["newRange"]}