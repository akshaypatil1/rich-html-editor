{"version":3,"sources":["../src/core/events.ts","../src/core/constants.ts","../node_modules/dompurify/src/utils.ts","../node_modules/dompurify/src/tags.ts","../node_modules/dompurify/src/attrs.ts","../node_modules/dompurify/src/regexp.ts","../node_modules/dompurify/src/purify.ts","../src/utils/sanitize.ts","../src/core/state.ts","../src/index.ts","../src/core/editor.ts","../src/dom/styles.ts","../src/toolbar/render.ts","../src/dom/root.ts","../src/toolbar/color.ts","../src/toolbar/overflow.ts","../src/toolbar/buttons.ts","../src/toolbar/selects.ts","../src/toolbar/navigation.ts","../src/dom/handlers.ts","../src/dom/candidates.ts","../src/dom/imageEditor.ts","../src/dom/format.ts","../src/core/sanitizeURL.ts","../src/core/history.ts","../src/core/formatActions.ts","../src/RichHtmlEditor.ts"],"sourcesContent":["import type { EditorEventType, EditorEvent, EditorEventHandler } from \"./types\";\n\nexport class EditorEventEmitter {\n  private listeners: Map<EditorEventType, Set<EditorEventHandler>> = new Map();\n\n  on(type: EditorEventType, handler: EditorEventHandler): () => void {\n    if (!this.listeners.has(type)) {\n      this.listeners.set(type, new Set());\n    }\n    this.listeners.get(type)!.add(handler);\n    return () => this.off(type, handler);\n  }\n\n  once(type: EditorEventType, handler: EditorEventHandler): void {\n    const unsubscribe = this.on(type, (event) => {\n      handler(event);\n      unsubscribe();\n    });\n  }\n\n  off(type: EditorEventType, handler: EditorEventHandler): void {\n    const handlers = this.listeners.get(type);\n    if (handlers) {\n      handlers.delete(handler);\n      if (handlers.size === 0) this.listeners.delete(type);\n    }\n  }\n\n  emit(event: EditorEvent): void {\n    const handlers = this.listeners.get(event.type);\n    if (handlers) {\n      handlers.forEach((handler) => {\n        try {\n          handler(event);\n        } catch (error) {\n          console.error(\n            `[rich-html-editor] Error in event handler for ${event.type}:`,\n            error,\n          );\n        }\n      });\n    }\n  }\n\n  removeAllListeners(type?: EditorEventType): void {\n    if (type) this.listeners.delete(type);\n    else this.listeners.clear();\n  }\n\n  listenerCount(type: EditorEventType): number {\n    return this.listeners.get(type)?.size ?? 0;\n  }\n}\n\nexport const editorEventEmitter = new EditorEventEmitter();\n\nexport function getEditorEventEmitter(): EditorEventEmitter {\n  return editorEventEmitter;\n}\n","// Shared constants for the rich-html-editor (moved to core)\nexport const TOOLBAR_ID = \"editor-toolbar\";\nexport const STYLE_ID = \"editor-styles\";\nexport const CLASS_EDITABLE = \"editor-editable-element\";\nexport const CLASS_ACTIVE = \"editor-active-element\";\n\n// Default undo/redo stack size\nexport const DEFAULT_MAX_STACK = 60;\n\n// Toolbar styling constants\nexport const TOOLBAR_BG = \"#f8fafc\";\nexport const TOOLBAR_BORDER = \"#e5e7eb\";\nexport const BUTTON_BORDER = \"#d1d5db\";\nexport const BUTTON_ACTIVE_BG = \"#e0e7ff\";\nexport const BUTTON_BG = \"#fff\";\nexport const BUTTON_COLOR = \"#222\";\nexport const INFO_COLOR = \"#888\";\n\n// Outline colors used by injected styles\nexport const HOVER_OUTLINE = \"#2563eb\";\nexport const ACTIVE_OUTLINE = \"#16a34a\";\n\n// Toolbar label/icon constants (kept in core for reuse)\nexport const LABEL_BOLD = \"<b>B</b>\";\nexport const LABEL_ITALIC = \"<i>I</i>\";\nexport const LABEL_UNDERLINE = \"<u>U</u>\";\nexport const LABEL_STRIKETHROUGH = \"<s>S</s>\";\nexport const LABEL_UNDO = \"â†º\";\nexport const LABEL_REDO = \"â†»\";\nexport const LABEL_LINK = \"ðŸ”—\";\nexport const LABEL_UNORDERED_LIST = `\n  <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\">\n    <circle cx=\"3\" cy=\"4\" r=\"1\" fill=\"currentColor\" />\n    <rect x=\"6\" y=\"3\" width=\"9\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n    <circle cx=\"3\" cy=\"8\" r=\"1\" fill=\"currentColor\" />\n    <rect x=\"6\" y=\"7\" width=\"9\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n    <circle cx=\"3\" cy=\"12\" r=\"1\" fill=\"currentColor\" />\n    <rect x=\"6\" y=\"11\" width=\"9\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n  </svg>\n`;\nexport const LABEL_ORDERED_LIST = `\n  <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\">\n    <text x=\"1\" y=\"4\" font-size=\"4\" fill=\"currentColor\">1.</text>\n    <rect x=\"6\" y=\"3\" width=\"9\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n    <text x=\"1\" y=\"8\" font-size=\"4\" fill=\"currentColor\">2.</text>\n    <rect x=\"6\" y=\"7\" width=\"9\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n    <text x=\"1\" y=\"12\" font-size=\"4\" fill=\"currentColor\">3.</text>\n    <rect x=\"6\" y=\"11\" width=\"9\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n  </svg>\n`;\nexport const LABEL_ALIGN_LEFT = `\n\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\">\n\t\t<rect x=\"1\" y=\"2\" width=\"10\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"6\" width=\"14\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"10\" width=\"10\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"14\" width=\"14\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t</svg>\n`;\nexport const LABEL_ALIGN_CENTER = `\n\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\">\n\t\t<rect x=\"3\" y=\"2\" width=\"10\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"6\" width=\"14\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"3\" y=\"10\" width=\"10\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"14\" width=\"14\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t</svg>\n`;\nexport const LABEL_ALIGN_RIGHT = `\n\t<svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\">\n\t\t<rect x=\"5\" y=\"2\" width=\"10\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"6\" width=\"14\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"5\" y=\"10\" width=\"10\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t\t<rect x=\"1\" y=\"14\" width=\"14\" height=\"2\" rx=\"0.5\" fill=\"currentColor\" />\n\t</svg>\n`;\n\n// Font and size option lists used by the toolbar\nexport const FONT_OPTIONS: { label: string; value: string }[] = [\n  { label: \"Arial\", value: \"Arial\" },\n  { label: \"Helvetica\", value: \"Helvetica, Arial, sans-serif\" },\n  { label: \"Verdana\", value: \"Verdana, Geneva, sans-serif\" },\n  { label: \"Tahoma\", value: \"Tahoma, Geneva, sans-serif\" },\n  { label: \"Trebuchet MS\", value: \"Trebuchet MS, Helvetica, sans-serif\" },\n  { label: \"Georgia\", value: \"Georgia, serif\" },\n  { label: \"Times New Roman\", value: \"Times New Roman, Times, serif\" },\n  { label: \"Palatino\", value: \"Palatino, 'Palatino Linotype', serif\" },\n  { label: \"Garamond\", value: \"Garamond, serif\" },\n  { label: \"Book Antiqua\", value: \"'Book Antiqua', Palatino, serif\" },\n  { label: \"Courier New\", value: \"'Courier New', Courier, monospace\" },\n  { label: \"Lucida Console\", value: \"'Lucida Console', Monaco, monospace\" },\n  { label: \"Impact\", value: \"Impact, Charcoal, sans-serif\" },\n  { label: \"Comic Sans MS\", value: \"'Comic Sans MS', 'Comic Sans', cursive\" },\n  { label: \"Segoe UI\", value: \"'Segoe UI', Tahoma, Geneva, sans-serif\" },\n  {\n    label: \"Roboto\",\n    value: \"Roboto, 'Helvetica Neue', Helvetica, Arial, sans-serif\",\n  },\n  { label: \"Open Sans\", value: \"'Open Sans', Arial, sans-serif\" },\n  { label: \"Lato\", value: \"Lato, 'Helvetica Neue', Arial, sans-serif\" },\n  { label: \"Montserrat\", value: \"Montserrat, Arial, sans-serif\" },\n  { label: \"Source Sans Pro\", value: \"'Source Sans Pro', Arial, sans-serif\" },\n  { label: \"Fira Sans\", value: \"'Fira Sans', Arial, sans-serif\" },\n  { label: \"Ubuntu\", value: \"Ubuntu, Arial, sans-serif\" },\n  { label: \"Noto Sans\", value: \"'Noto Sans', Arial, sans-serif\" },\n  { label: \"Droid Sans\", value: \"'Droid Sans', Arial, sans-serif\" },\n  {\n    label: \"Helvetica Neue\",\n    value: \"'Helvetica Neue', Helvetica, Arial, sans-serif\",\n  },\n  {\n    label: \"System UI\",\n    value:\n      \"system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif\",\n  },\n];\n\nexport const SIZE_OPTIONS: { label: string; value: string }[] = [\n  { label: \"8\", value: \"8\" },\n  { label: \"9\", value: \"9\" },\n  { label: \"10\", value: \"10\" },\n  { label: \"11\", value: \"11\" },\n  { label: \"12\", value: \"12\" },\n  { label: \"14\", value: \"14\" },\n  { label: \"16\", value: \"16\" },\n  { label: \"18\", value: \"18\" },\n  { label: \"20\", value: \"20\" },\n  { label: \"22\", value: \"22\" },\n  { label: \"24\", value: \"24\" },\n  { label: \"26\", value: \"26\" },\n  { label: \"28\", value: \"28\" },\n  { label: \"36\", value: \"36\" },\n  { label: \"48\", value: \"48\" },\n  { label: \"72\", value: \"72\" },\n];\n\n// Block format options (Paragraph + Headings)\nexport const FORMAT_OPTIONS: { label: string; value: string }[] = [\n  { label: \"Heading 1\", value: \"h1\" },\n  { label: \"Heading 2\", value: \"h2\" },\n  { label: \"Heading 3\", value: \"h3\" },\n  { label: \"Heading 4\", value: \"h4\" },\n  { label: \"Heading 5\", value: \"h5\" },\n  { label: \"Heading 6\", value: \"h6\" },\n];\n\n// Clear formatting label\nexport const LABEL_CLEAR_FORMAT = \"ðŸ§¹ Clear\";\n\n// Maximum allowed file size for inline image uploads (bytes)\nexport const MAX_FILE_SIZE = 1024 * 1024; // 1MB\n","const {\n  entries,\n  setPrototypeOf,\n  isFrozen,\n  getPrototypeOf,\n  getOwnPropertyDescriptor,\n} = Object;\n\nlet { freeze, seal, create } = Object; // eslint-disable-line import/no-mutable-exports\nlet { apply, construct } = typeof Reflect !== 'undefined' && Reflect;\n\nif (!freeze) {\n  freeze = function <T>(x: T): T {\n    return x;\n  };\n}\n\nif (!seal) {\n  seal = function <T>(x: T): T {\n    return x;\n  };\n}\n\nif (!apply) {\n  apply = function <T>(\n    func: (thisArg: any, ...args: any[]) => T,\n    thisArg: any,\n    ...args: any[]\n  ): T {\n    return func.apply(thisArg, args);\n  };\n}\n\nif (!construct) {\n  construct = function <T>(Func: new (...args: any[]) => T, ...args: any[]): T {\n    return new Func(...args);\n  };\n}\n\nconst arrayForEach = unapply(Array.prototype.forEach);\nconst arrayIndexOf = unapply(Array.prototype.indexOf);\nconst arrayLastIndexOf = unapply(Array.prototype.lastIndexOf);\nconst arrayPop = unapply(Array.prototype.pop);\nconst arrayPush = unapply(Array.prototype.push);\nconst arraySlice = unapply(Array.prototype.slice);\nconst arraySplice = unapply(Array.prototype.splice);\n\nconst stringToLowerCase = unapply(String.prototype.toLowerCase);\nconst stringToString = unapply(String.prototype.toString);\nconst stringMatch = unapply(String.prototype.match);\nconst stringReplace = unapply(String.prototype.replace);\nconst stringIndexOf = unapply(String.prototype.indexOf);\nconst stringTrim = unapply(String.prototype.trim);\n\nconst objectHasOwnProperty = unapply(Object.prototype.hasOwnProperty);\n\nconst regExpTest = unapply(RegExp.prototype.test);\n\nconst typeErrorCreate = unconstruct(TypeError);\n\n/**\n * Creates a new function that calls the given function with a specified thisArg and arguments.\n *\n * @param func - The function to be wrapped and called.\n * @returns A new function that calls the given function with a specified thisArg and arguments.\n */\nfunction unapply<T>(\n  func: (thisArg: any, ...args: any[]) => T\n): (thisArg: any, ...args: any[]) => T {\n  return (thisArg: any, ...args: any[]): T => {\n    if (thisArg instanceof RegExp) {\n      thisArg.lastIndex = 0;\n    }\n\n    return apply(func, thisArg, args);\n  };\n}\n\n/**\n * Creates a new function that constructs an instance of the given constructor function with the provided arguments.\n *\n * @param func - The constructor function to be wrapped and called.\n * @returns A new function that constructs an instance of the given constructor function with the provided arguments.\n */\nfunction unconstruct<T>(\n  Func: new (...args: any[]) => T\n): (...args: any[]) => T {\n  return (...args: any[]): T => construct(Func, args);\n}\n\n/**\n * Add properties to a lookup table\n *\n * @param set - The set to which elements will be added.\n * @param array - The array containing elements to be added to the set.\n * @param transformCaseFunc - An optional function to transform the case of each element before adding to the set.\n * @returns The modified set with added elements.\n */\nfunction addToSet(\n  set: Record<string, any>,\n  array: readonly any[],\n  transformCaseFunc: ReturnType<typeof unapply<string>> = stringToLowerCase\n): Record<string, any> {\n  if (setPrototypeOf) {\n    // Make 'in' and truthy checks like Boolean(set.constructor)\n    // independent of any properties defined on Object.prototype.\n    // Prevent prototype setters from intercepting set as a this value.\n    setPrototypeOf(set, null);\n  }\n\n  let l = array.length;\n  while (l--) {\n    let element = array[l];\n    if (typeof element === 'string') {\n      const lcElement = transformCaseFunc(element);\n      if (lcElement !== element) {\n        // Config presets (e.g. tags.js, attrs.js) are immutable.\n        if (!isFrozen(array)) {\n          (array as any[])[l] = lcElement;\n        }\n\n        element = lcElement;\n      }\n    }\n\n    set[element] = true;\n  }\n\n  return set;\n}\n\n/**\n * Clean up an array to harden against CSPP\n *\n * @param array - The array to be cleaned.\n * @returns The cleaned version of the array\n */\nfunction cleanArray<T>(array: T[]): Array<T | null> {\n  for (let index = 0; index < array.length; index++) {\n    const isPropertyExist = objectHasOwnProperty(array, index);\n\n    if (!isPropertyExist) {\n      array[index] = null;\n    }\n  }\n\n  return array;\n}\n\n/**\n * Shallow clone an object\n *\n * @param object - The object to be cloned.\n * @returns A new object that copies the original.\n */\nfunction clone<T extends Record<string, any>>(object: T): T {\n  const newObject = create(null);\n\n  for (const [property, value] of entries(object)) {\n    const isPropertyExist = objectHasOwnProperty(object, property);\n\n    if (isPropertyExist) {\n      if (Array.isArray(value)) {\n        newObject[property] = cleanArray(value);\n      } else if (\n        value &&\n        typeof value === 'object' &&\n        value.constructor === Object\n      ) {\n        newObject[property] = clone(value);\n      } else {\n        newObject[property] = value;\n      }\n    }\n  }\n\n  return newObject;\n}\n\n/**\n * This method automatically checks if the prop is function or getter and behaves accordingly.\n *\n * @param object - The object to look up the getter function in its prototype chain.\n * @param prop - The property name for which to find the getter function.\n * @returns The getter function found in the prototype chain or a fallback function.\n */\nfunction lookupGetter<T extends Record<string, any>>(\n  object: T,\n  prop: string\n): ReturnType<typeof unapply<any>> | (() => null) {\n  while (object !== null) {\n    const desc = getOwnPropertyDescriptor(object, prop);\n\n    if (desc) {\n      if (desc.get) {\n        return unapply(desc.get);\n      }\n\n      if (typeof desc.value === 'function') {\n        return unapply(desc.value);\n      }\n    }\n\n    object = getPrototypeOf(object);\n  }\n\n  function fallbackValue(): null {\n    return null;\n  }\n\n  return fallbackValue;\n}\n\nexport {\n  // Array\n  arrayForEach,\n  arrayIndexOf,\n  arrayLastIndexOf,\n  arrayPop,\n  arrayPush,\n  arraySlice,\n  arraySplice,\n  // Object\n  entries,\n  freeze,\n  getPrototypeOf,\n  getOwnPropertyDescriptor,\n  isFrozen,\n  setPrototypeOf,\n  seal,\n  clone,\n  create,\n  objectHasOwnProperty,\n  // RegExp\n  regExpTest,\n  // String\n  stringIndexOf,\n  stringMatch,\n  stringReplace,\n  stringToLowerCase,\n  stringToString,\n  stringTrim,\n  // Errors\n  typeErrorCreate,\n  // Other\n  lookupGetter,\n  addToSet,\n  // Reflect\n  unapply,\n  unconstruct,\n};\n","import { freeze } from './utils.js';\n\nexport const html = freeze([\n  'a',\n  'abbr',\n  'acronym',\n  'address',\n  'area',\n  'article',\n  'aside',\n  'audio',\n  'b',\n  'bdi',\n  'bdo',\n  'big',\n  'blink',\n  'blockquote',\n  'body',\n  'br',\n  'button',\n  'canvas',\n  'caption',\n  'center',\n  'cite',\n  'code',\n  'col',\n  'colgroup',\n  'content',\n  'data',\n  'datalist',\n  'dd',\n  'decorator',\n  'del',\n  'details',\n  'dfn',\n  'dialog',\n  'dir',\n  'div',\n  'dl',\n  'dt',\n  'element',\n  'em',\n  'fieldset',\n  'figcaption',\n  'figure',\n  'font',\n  'footer',\n  'form',\n  'h1',\n  'h2',\n  'h3',\n  'h4',\n  'h5',\n  'h6',\n  'head',\n  'header',\n  'hgroup',\n  'hr',\n  'html',\n  'i',\n  'img',\n  'input',\n  'ins',\n  'kbd',\n  'label',\n  'legend',\n  'li',\n  'main',\n  'map',\n  'mark',\n  'marquee',\n  'menu',\n  'menuitem',\n  'meter',\n  'nav',\n  'nobr',\n  'ol',\n  'optgroup',\n  'option',\n  'output',\n  'p',\n  'picture',\n  'pre',\n  'progress',\n  'q',\n  'rp',\n  'rt',\n  'ruby',\n  's',\n  'samp',\n  'search',\n  'section',\n  'select',\n  'shadow',\n  'slot',\n  'small',\n  'source',\n  'spacer',\n  'span',\n  'strike',\n  'strong',\n  'style',\n  'sub',\n  'summary',\n  'sup',\n  'table',\n  'tbody',\n  'td',\n  'template',\n  'textarea',\n  'tfoot',\n  'th',\n  'thead',\n  'time',\n  'tr',\n  'track',\n  'tt',\n  'u',\n  'ul',\n  'var',\n  'video',\n  'wbr',\n] as const);\n\nexport const svg = freeze([\n  'svg',\n  'a',\n  'altglyph',\n  'altglyphdef',\n  'altglyphitem',\n  'animatecolor',\n  'animatemotion',\n  'animatetransform',\n  'circle',\n  'clippath',\n  'defs',\n  'desc',\n  'ellipse',\n  'enterkeyhint',\n  'exportparts',\n  'filter',\n  'font',\n  'g',\n  'glyph',\n  'glyphref',\n  'hkern',\n  'image',\n  'inputmode',\n  'line',\n  'lineargradient',\n  'marker',\n  'mask',\n  'metadata',\n  'mpath',\n  'part',\n  'path',\n  'pattern',\n  'polygon',\n  'polyline',\n  'radialgradient',\n  'rect',\n  'stop',\n  'style',\n  'switch',\n  'symbol',\n  'text',\n  'textpath',\n  'title',\n  'tref',\n  'tspan',\n  'view',\n  'vkern',\n] as const);\n\nexport const svgFilters = freeze([\n  'feBlend',\n  'feColorMatrix',\n  'feComponentTransfer',\n  'feComposite',\n  'feConvolveMatrix',\n  'feDiffuseLighting',\n  'feDisplacementMap',\n  'feDistantLight',\n  'feDropShadow',\n  'feFlood',\n  'feFuncA',\n  'feFuncB',\n  'feFuncG',\n  'feFuncR',\n  'feGaussianBlur',\n  'feImage',\n  'feMerge',\n  'feMergeNode',\n  'feMorphology',\n  'feOffset',\n  'fePointLight',\n  'feSpecularLighting',\n  'feSpotLight',\n  'feTile',\n  'feTurbulence',\n] as const);\n\n// List of SVG elements that are disallowed by default.\n// We still need to know them so that we can do namespace\n// checks properly in case one wants to add them to\n// allow-list.\nexport const svgDisallowed = freeze([\n  'animate',\n  'color-profile',\n  'cursor',\n  'discard',\n  'font-face',\n  'font-face-format',\n  'font-face-name',\n  'font-face-src',\n  'font-face-uri',\n  'foreignobject',\n  'hatch',\n  'hatchpath',\n  'mesh',\n  'meshgradient',\n  'meshpatch',\n  'meshrow',\n  'missing-glyph',\n  'script',\n  'set',\n  'solidcolor',\n  'unknown',\n  'use',\n] as const);\n\nexport const mathMl = freeze([\n  'math',\n  'menclose',\n  'merror',\n  'mfenced',\n  'mfrac',\n  'mglyph',\n  'mi',\n  'mlabeledtr',\n  'mmultiscripts',\n  'mn',\n  'mo',\n  'mover',\n  'mpadded',\n  'mphantom',\n  'mroot',\n  'mrow',\n  'ms',\n  'mspace',\n  'msqrt',\n  'mstyle',\n  'msub',\n  'msup',\n  'msubsup',\n  'mtable',\n  'mtd',\n  'mtext',\n  'mtr',\n  'munder',\n  'munderover',\n  'mprescripts',\n] as const);\n\n// Similarly to SVG, we want to know all MathML elements,\n// even those that we disallow by default.\nexport const mathMlDisallowed = freeze([\n  'maction',\n  'maligngroup',\n  'malignmark',\n  'mlongdiv',\n  'mscarries',\n  'mscarry',\n  'msgroup',\n  'mstack',\n  'msline',\n  'msrow',\n  'semantics',\n  'annotation',\n  'annotation-xml',\n  'mprescripts',\n  'none',\n] as const);\n\nexport const text = freeze(['#text'] as const);\n","import { freeze } from './utils.js';\n\nexport const html = freeze([\n  'accept',\n  'action',\n  'align',\n  'alt',\n  'autocapitalize',\n  'autocomplete',\n  'autopictureinpicture',\n  'autoplay',\n  'background',\n  'bgcolor',\n  'border',\n  'capture',\n  'cellpadding',\n  'cellspacing',\n  'checked',\n  'cite',\n  'class',\n  'clear',\n  'color',\n  'cols',\n  'colspan',\n  'controls',\n  'controlslist',\n  'coords',\n  'crossorigin',\n  'datetime',\n  'decoding',\n  'default',\n  'dir',\n  'disabled',\n  'disablepictureinpicture',\n  'disableremoteplayback',\n  'download',\n  'draggable',\n  'enctype',\n  'enterkeyhint',\n  'exportparts',\n  'face',\n  'for',\n  'headers',\n  'height',\n  'hidden',\n  'high',\n  'href',\n  'hreflang',\n  'id',\n  'inert',\n  'inputmode',\n  'integrity',\n  'ismap',\n  'kind',\n  'label',\n  'lang',\n  'list',\n  'loading',\n  'loop',\n  'low',\n  'max',\n  'maxlength',\n  'media',\n  'method',\n  'min',\n  'minlength',\n  'multiple',\n  'muted',\n  'name',\n  'nonce',\n  'noshade',\n  'novalidate',\n  'nowrap',\n  'open',\n  'optimum',\n  'part',\n  'pattern',\n  'placeholder',\n  'playsinline',\n  'popover',\n  'popovertarget',\n  'popovertargetaction',\n  'poster',\n  'preload',\n  'pubdate',\n  'radiogroup',\n  'readonly',\n  'rel',\n  'required',\n  'rev',\n  'reversed',\n  'role',\n  'rows',\n  'rowspan',\n  'spellcheck',\n  'scope',\n  'selected',\n  'shape',\n  'size',\n  'sizes',\n  'slot',\n  'span',\n  'srclang',\n  'start',\n  'src',\n  'srcset',\n  'step',\n  'style',\n  'summary',\n  'tabindex',\n  'title',\n  'translate',\n  'type',\n  'usemap',\n  'valign',\n  'value',\n  'width',\n  'wrap',\n  'xmlns',\n  'slot',\n] as const);\n\nexport const svg = freeze([\n  'accent-height',\n  'accumulate',\n  'additive',\n  'alignment-baseline',\n  'amplitude',\n  'ascent',\n  'attributename',\n  'attributetype',\n  'azimuth',\n  'basefrequency',\n  'baseline-shift',\n  'begin',\n  'bias',\n  'by',\n  'class',\n  'clip',\n  'clippathunits',\n  'clip-path',\n  'clip-rule',\n  'color',\n  'color-interpolation',\n  'color-interpolation-filters',\n  'color-profile',\n  'color-rendering',\n  'cx',\n  'cy',\n  'd',\n  'dx',\n  'dy',\n  'diffuseconstant',\n  'direction',\n  'display',\n  'divisor',\n  'dur',\n  'edgemode',\n  'elevation',\n  'end',\n  'exponent',\n  'fill',\n  'fill-opacity',\n  'fill-rule',\n  'filter',\n  'filterunits',\n  'flood-color',\n  'flood-opacity',\n  'font-family',\n  'font-size',\n  'font-size-adjust',\n  'font-stretch',\n  'font-style',\n  'font-variant',\n  'font-weight',\n  'fx',\n  'fy',\n  'g1',\n  'g2',\n  'glyph-name',\n  'glyphref',\n  'gradientunits',\n  'gradienttransform',\n  'height',\n  'href',\n  'id',\n  'image-rendering',\n  'in',\n  'in2',\n  'intercept',\n  'k',\n  'k1',\n  'k2',\n  'k3',\n  'k4',\n  'kerning',\n  'keypoints',\n  'keysplines',\n  'keytimes',\n  'lang',\n  'lengthadjust',\n  'letter-spacing',\n  'kernelmatrix',\n  'kernelunitlength',\n  'lighting-color',\n  'local',\n  'marker-end',\n  'marker-mid',\n  'marker-start',\n  'markerheight',\n  'markerunits',\n  'markerwidth',\n  'maskcontentunits',\n  'maskunits',\n  'max',\n  'mask',\n  'mask-type',\n  'media',\n  'method',\n  'mode',\n  'min',\n  'name',\n  'numoctaves',\n  'offset',\n  'operator',\n  'opacity',\n  'order',\n  'orient',\n  'orientation',\n  'origin',\n  'overflow',\n  'paint-order',\n  'path',\n  'pathlength',\n  'patterncontentunits',\n  'patterntransform',\n  'patternunits',\n  'points',\n  'preservealpha',\n  'preserveaspectratio',\n  'primitiveunits',\n  'r',\n  'rx',\n  'ry',\n  'radius',\n  'refx',\n  'refy',\n  'repeatcount',\n  'repeatdur',\n  'restart',\n  'result',\n  'rotate',\n  'scale',\n  'seed',\n  'shape-rendering',\n  'slope',\n  'specularconstant',\n  'specularexponent',\n  'spreadmethod',\n  'startoffset',\n  'stddeviation',\n  'stitchtiles',\n  'stop-color',\n  'stop-opacity',\n  'stroke-dasharray',\n  'stroke-dashoffset',\n  'stroke-linecap',\n  'stroke-linejoin',\n  'stroke-miterlimit',\n  'stroke-opacity',\n  'stroke',\n  'stroke-width',\n  'style',\n  'surfacescale',\n  'systemlanguage',\n  'tabindex',\n  'tablevalues',\n  'targetx',\n  'targety',\n  'transform',\n  'transform-origin',\n  'text-anchor',\n  'text-decoration',\n  'text-rendering',\n  'textlength',\n  'type',\n  'u1',\n  'u2',\n  'unicode',\n  'values',\n  'viewbox',\n  'visibility',\n  'version',\n  'vert-adv-y',\n  'vert-origin-x',\n  'vert-origin-y',\n  'width',\n  'word-spacing',\n  'wrap',\n  'writing-mode',\n  'xchannelselector',\n  'ychannelselector',\n  'x',\n  'x1',\n  'x2',\n  'xmlns',\n  'y',\n  'y1',\n  'y2',\n  'z',\n  'zoomandpan',\n] as const);\n\nexport const mathMl = freeze([\n  'accent',\n  'accentunder',\n  'align',\n  'bevelled',\n  'close',\n  'columnsalign',\n  'columnlines',\n  'columnspan',\n  'denomalign',\n  'depth',\n  'dir',\n  'display',\n  'displaystyle',\n  'encoding',\n  'fence',\n  'frame',\n  'height',\n  'href',\n  'id',\n  'largeop',\n  'length',\n  'linethickness',\n  'lspace',\n  'lquote',\n  'mathbackground',\n  'mathcolor',\n  'mathsize',\n  'mathvariant',\n  'maxsize',\n  'minsize',\n  'movablelimits',\n  'notation',\n  'numalign',\n  'open',\n  'rowalign',\n  'rowlines',\n  'rowspacing',\n  'rowspan',\n  'rspace',\n  'rquote',\n  'scriptlevel',\n  'scriptminsize',\n  'scriptsizemultiplier',\n  'selection',\n  'separator',\n  'separators',\n  'stretchy',\n  'subscriptshift',\n  'supscriptshift',\n  'symmetric',\n  'voffset',\n  'width',\n  'xmlns',\n]);\n\nexport const xml = freeze([\n  'xlink:href',\n  'xml:id',\n  'xlink:title',\n  'xml:space',\n  'xmlns:xlink',\n] as const);\n","import { seal } from './utils.js';\n\n// eslint-disable-next-line unicorn/better-regex\nexport const MUSTACHE_EXPR = seal(/\\{\\{[\\w\\W]*|[\\w\\W]*\\}\\}/gm); // Specify template detection regex for SAFE_FOR_TEMPLATES mode\nexport const ERB_EXPR = seal(/<%[\\w\\W]*|[\\w\\W]*%>/gm);\nexport const TMPLIT_EXPR = seal(/\\$\\{[\\w\\W]*/gm); // eslint-disable-line unicorn/better-regex\nexport const DATA_ATTR = seal(/^data-[\\-\\w.\\u00B7-\\uFFFF]+$/); // eslint-disable-line no-useless-escape\nexport const ARIA_ATTR = seal(/^aria-[\\-\\w]+$/); // eslint-disable-line no-useless-escape\nexport const IS_ALLOWED_URI = seal(\n  /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\\-]+(?:[^a-z+.\\-:]|$))/i // eslint-disable-line no-useless-escape\n);\nexport const IS_SCRIPT_OR_DATA = seal(/^(?:\\w+script|data):/i);\nexport const ATTR_WHITESPACE = seal(\n  /[\\u0000-\\u0020\\u00A0\\u1680\\u180E\\u2000-\\u2029\\u205F\\u3000]/g // eslint-disable-line no-control-regex\n);\nexport const DOCTYPE_NAME = seal(/^html$/i);\nexport const CUSTOM_ELEMENT = seal(/^[a-z][.\\w]*(-[.\\w]+)+$/i);\n","/* eslint-disable @typescript-eslint/indent */\n\nimport type {\n  TrustedHTML,\n  TrustedTypesWindow,\n} from 'trusted-types/lib/index.js';\nimport type { Config, UseProfilesConfig } from './config';\nimport * as TAGS from './tags.js';\nimport * as ATTRS from './attrs.js';\nimport * as EXPRESSIONS from './regexp.js';\nimport {\n  addToSet,\n  clone,\n  entries,\n  freeze,\n  arrayForEach,\n  arrayLastIndexOf,\n  arrayPop,\n  arrayPush,\n  arraySplice,\n  stringMatch,\n  stringReplace,\n  stringToLowerCase,\n  stringToString,\n  stringIndexOf,\n  stringTrim,\n  regExpTest,\n  typeErrorCreate,\n  lookupGetter,\n  create,\n  objectHasOwnProperty,\n} from './utils.js';\n\nexport type { Config } from './config';\n\ndeclare const VERSION: string;\n\n// https://developer.mozilla.org/en-US/docs/Web/API/Node/nodeType\nconst NODE_TYPE = {\n  element: 1,\n  attribute: 2,\n  text: 3,\n  cdataSection: 4,\n  entityReference: 5, // Deprecated\n  entityNode: 6, // Deprecated\n  progressingInstruction: 7,\n  comment: 8,\n  document: 9,\n  documentType: 10,\n  documentFragment: 11,\n  notation: 12, // Deprecated\n};\n\nconst getGlobal = function (): WindowLike {\n  return typeof window === 'undefined' ? null : window;\n};\n\n/**\n * Creates a no-op policy for internal use only.\n * Don't export this function outside this module!\n * @param trustedTypes The policy factory.\n * @param purifyHostElement The Script element used to load DOMPurify (to determine policy name suffix).\n * @return The policy created (or null, if Trusted Types\n * are not supported or creating the policy failed).\n */\nconst _createTrustedTypesPolicy = function (\n  trustedTypes: TrustedTypePolicyFactory,\n  purifyHostElement: HTMLScriptElement\n) {\n  if (\n    typeof trustedTypes !== 'object' ||\n    typeof trustedTypes.createPolicy !== 'function'\n  ) {\n    return null;\n  }\n\n  // Allow the callers to control the unique policy name\n  // by adding a data-tt-policy-suffix to the script element with the DOMPurify.\n  // Policy creation with duplicate names throws in Trusted Types.\n  let suffix = null;\n  const ATTR_NAME = 'data-tt-policy-suffix';\n  if (purifyHostElement && purifyHostElement.hasAttribute(ATTR_NAME)) {\n    suffix = purifyHostElement.getAttribute(ATTR_NAME);\n  }\n\n  const policyName = 'dompurify' + (suffix ? '#' + suffix : '');\n\n  try {\n    return trustedTypes.createPolicy(policyName, {\n      createHTML(html) {\n        return html;\n      },\n      createScriptURL(scriptUrl) {\n        return scriptUrl;\n      },\n    });\n  } catch (_) {\n    // Policy creation failed (most likely another DOMPurify script has\n    // already run). Skip creating the policy, as this will only cause errors\n    // if TT are enforced.\n    console.warn(\n      'TrustedTypes policy ' + policyName + ' could not be created.'\n    );\n    return null;\n  }\n};\n\nconst _createHooksMap = function (): HooksMap {\n  return {\n    afterSanitizeAttributes: [],\n    afterSanitizeElements: [],\n    afterSanitizeShadowDOM: [],\n    beforeSanitizeAttributes: [],\n    beforeSanitizeElements: [],\n    beforeSanitizeShadowDOM: [],\n    uponSanitizeAttribute: [],\n    uponSanitizeElement: [],\n    uponSanitizeShadowNode: [],\n  };\n};\n\nfunction createDOMPurify(window: WindowLike = getGlobal()): DOMPurify {\n  const DOMPurify: DOMPurify = (root: WindowLike) => createDOMPurify(root);\n\n  DOMPurify.version = VERSION;\n\n  DOMPurify.removed = [];\n\n  if (\n    !window ||\n    !window.document ||\n    window.document.nodeType !== NODE_TYPE.document ||\n    !window.Element\n  ) {\n    // Not running in a browser, provide a factory function\n    // so that you can pass your own Window\n    DOMPurify.isSupported = false;\n\n    return DOMPurify;\n  }\n\n  let { document } = window;\n\n  const originalDocument = document;\n  const currentScript: HTMLScriptElement =\n    originalDocument.currentScript as HTMLScriptElement;\n  const {\n    DocumentFragment,\n    HTMLTemplateElement,\n    Node,\n    Element,\n    NodeFilter,\n    NamedNodeMap = window.NamedNodeMap || (window as any).MozNamedAttrMap,\n    HTMLFormElement,\n    DOMParser,\n    trustedTypes,\n  } = window;\n\n  const ElementPrototype = Element.prototype;\n\n  const cloneNode = lookupGetter(ElementPrototype, 'cloneNode');\n  const remove = lookupGetter(ElementPrototype, 'remove');\n  const getNextSibling = lookupGetter(ElementPrototype, 'nextSibling');\n  const getChildNodes = lookupGetter(ElementPrototype, 'childNodes');\n  const getParentNode = lookupGetter(ElementPrototype, 'parentNode');\n\n  // As per issue #47, the web-components registry is inherited by a\n  // new document created via createHTMLDocument. As per the spec\n  // (http://w3c.github.io/webcomponents/spec/custom/#creating-and-passing-registries)\n  // a new empty registry is used when creating a template contents owner\n  // document, so we use that as our parent document to ensure nothing\n  // is inherited.\n  if (typeof HTMLTemplateElement === 'function') {\n    const template = document.createElement('template');\n    if (template.content && template.content.ownerDocument) {\n      document = template.content.ownerDocument;\n    }\n  }\n\n  let trustedTypesPolicy;\n  let emptyHTML = '';\n\n  const {\n    implementation,\n    createNodeIterator,\n    createDocumentFragment,\n    getElementsByTagName,\n  } = document;\n  const { importNode } = originalDocument;\n\n  let hooks = _createHooksMap();\n\n  /**\n   * Expose whether this browser supports running the full DOMPurify.\n   */\n  DOMPurify.isSupported =\n    typeof entries === 'function' &&\n    typeof getParentNode === 'function' &&\n    implementation &&\n    implementation.createHTMLDocument !== undefined;\n\n  const {\n    MUSTACHE_EXPR,\n    ERB_EXPR,\n    TMPLIT_EXPR,\n    DATA_ATTR,\n    ARIA_ATTR,\n    IS_SCRIPT_OR_DATA,\n    ATTR_WHITESPACE,\n    CUSTOM_ELEMENT,\n  } = EXPRESSIONS;\n\n  let { IS_ALLOWED_URI } = EXPRESSIONS;\n\n  /**\n   * We consider the elements and attributes below to be safe. Ideally\n   * don't add any new ones but feel free to remove unwanted ones.\n   */\n\n  /* allowed element names */\n  let ALLOWED_TAGS = null;\n  const DEFAULT_ALLOWED_TAGS = addToSet({}, [\n    ...TAGS.html,\n    ...TAGS.svg,\n    ...TAGS.svgFilters,\n    ...TAGS.mathMl,\n    ...TAGS.text,\n  ]);\n\n  /* Allowed attribute names */\n  let ALLOWED_ATTR = null;\n  const DEFAULT_ALLOWED_ATTR = addToSet({}, [\n    ...ATTRS.html,\n    ...ATTRS.svg,\n    ...ATTRS.mathMl,\n    ...ATTRS.xml,\n  ]);\n\n  /*\n   * Configure how DOMPurify should handle custom elements and their attributes as well as customized built-in elements.\n   * @property {RegExp|Function|null} tagNameCheck one of [null, regexPattern, predicate]. Default: `null` (disallow any custom elements)\n   * @property {RegExp|Function|null} attributeNameCheck one of [null, regexPattern, predicate]. Default: `null` (disallow any attributes not on the allow list)\n   * @property {boolean} allowCustomizedBuiltInElements allow custom elements derived from built-ins if they pass CUSTOM_ELEMENT_HANDLING.tagNameCheck. Default: `false`.\n   */\n  let CUSTOM_ELEMENT_HANDLING = Object.seal(\n    create(null, {\n      tagNameCheck: {\n        writable: true,\n        configurable: false,\n        enumerable: true,\n        value: null,\n      },\n      attributeNameCheck: {\n        writable: true,\n        configurable: false,\n        enumerable: true,\n        value: null,\n      },\n      allowCustomizedBuiltInElements: {\n        writable: true,\n        configurable: false,\n        enumerable: true,\n        value: false,\n      },\n    })\n  );\n\n  /* Explicitly forbidden tags (overrides ALLOWED_TAGS/ADD_TAGS) */\n  let FORBID_TAGS = null;\n\n  /* Explicitly forbidden attributes (overrides ALLOWED_ATTR/ADD_ATTR) */\n  let FORBID_ATTR = null;\n\n  /* Config object to store ADD_TAGS/ADD_ATTR functions (when used as functions) */\n  const EXTRA_ELEMENT_HANDLING = Object.seal(\n    create(null, {\n      tagCheck: {\n        writable: true,\n        configurable: false,\n        enumerable: true,\n        value: null,\n      },\n      attributeCheck: {\n        writable: true,\n        configurable: false,\n        enumerable: true,\n        value: null,\n      },\n    })\n  );\n\n  /* Decide if ARIA attributes are okay */\n  let ALLOW_ARIA_ATTR = true;\n\n  /* Decide if custom data attributes are okay */\n  let ALLOW_DATA_ATTR = true;\n\n  /* Decide if unknown protocols are okay */\n  let ALLOW_UNKNOWN_PROTOCOLS = false;\n\n  /* Decide if self-closing tags in attributes are allowed.\n   * Usually removed due to a mXSS issue in jQuery 3.0 */\n  let ALLOW_SELF_CLOSE_IN_ATTR = true;\n\n  /* Output should be safe for common template engines.\n   * This means, DOMPurify removes data attributes, mustaches and ERB\n   */\n  let SAFE_FOR_TEMPLATES = false;\n\n  /* Output should be safe even for XML used within HTML and alike.\n   * This means, DOMPurify removes comments when containing risky content.\n   */\n  let SAFE_FOR_XML = true;\n\n  /* Decide if document with <html>... should be returned */\n  let WHOLE_DOCUMENT = false;\n\n  /* Track whether config is already set on this instance of DOMPurify. */\n  let SET_CONFIG = false;\n\n  /* Decide if all elements (e.g. style, script) must be children of\n   * document.body. By default, browsers might move them to document.head */\n  let FORCE_BODY = false;\n\n  /* Decide if a DOM `HTMLBodyElement` should be returned, instead of a html\n   * string (or a TrustedHTML object if Trusted Types are supported).\n   * If `WHOLE_DOCUMENT` is enabled a `HTMLHtmlElement` will be returned instead\n   */\n  let RETURN_DOM = false;\n\n  /* Decide if a DOM `DocumentFragment` should be returned, instead of a html\n   * string  (or a TrustedHTML object if Trusted Types are supported) */\n  let RETURN_DOM_FRAGMENT = false;\n\n  /* Try to return a Trusted Type object instead of a string, return a string in\n   * case Trusted Types are not supported  */\n  let RETURN_TRUSTED_TYPE = false;\n\n  /* Output should be free from DOM clobbering attacks?\n   * This sanitizes markups named with colliding, clobberable built-in DOM APIs.\n   */\n  let SANITIZE_DOM = true;\n\n  /* Achieve full DOM Clobbering protection by isolating the namespace of named\n   * properties and JS variables, mitigating attacks that abuse the HTML/DOM spec rules.\n   *\n   * HTML/DOM spec rules that enable DOM Clobbering:\n   *   - Named Access on Window (Â§7.3.3)\n   *   - DOM Tree Accessors (Â§3.1.5)\n   *   - Form Element Parent-Child Relations (Â§4.10.3)\n   *   - Iframe srcdoc / Nested WindowProxies (Â§4.8.5)\n   *   - HTMLCollection (Â§4.2.10.2)\n   *\n   * Namespace isolation is implemented by prefixing `id` and `name` attributes\n   * with a constant string, i.e., `user-content-`\n   */\n  let SANITIZE_NAMED_PROPS = false;\n  const SANITIZE_NAMED_PROPS_PREFIX = 'user-content-';\n\n  /* Keep element content when removing element? */\n  let KEEP_CONTENT = true;\n\n  /* If a `Node` is passed to sanitize(), then performs sanitization in-place instead\n   * of importing it into a new Document and returning a sanitized copy */\n  let IN_PLACE = false;\n\n  /* Allow usage of profiles like html, svg and mathMl */\n  let USE_PROFILES: UseProfilesConfig | false = {};\n\n  /* Tags to ignore content of when KEEP_CONTENT is true */\n  let FORBID_CONTENTS = null;\n  const DEFAULT_FORBID_CONTENTS = addToSet({}, [\n    'annotation-xml',\n    'audio',\n    'colgroup',\n    'desc',\n    'foreignobject',\n    'head',\n    'iframe',\n    'math',\n    'mi',\n    'mn',\n    'mo',\n    'ms',\n    'mtext',\n    'noembed',\n    'noframes',\n    'noscript',\n    'plaintext',\n    'script',\n    'style',\n    'svg',\n    'template',\n    'thead',\n    'title',\n    'video',\n    'xmp',\n  ]);\n\n  /* Tags that are safe for data: URIs */\n  let DATA_URI_TAGS = null;\n  const DEFAULT_DATA_URI_TAGS = addToSet({}, [\n    'audio',\n    'video',\n    'img',\n    'source',\n    'image',\n    'track',\n  ]);\n\n  /* Attributes safe for values like \"javascript:\" */\n  let URI_SAFE_ATTRIBUTES = null;\n  const DEFAULT_URI_SAFE_ATTRIBUTES = addToSet({}, [\n    'alt',\n    'class',\n    'for',\n    'id',\n    'label',\n    'name',\n    'pattern',\n    'placeholder',\n    'role',\n    'summary',\n    'title',\n    'value',\n    'style',\n    'xmlns',\n  ]);\n\n  const MATHML_NAMESPACE = 'http://www.w3.org/1998/Math/MathML';\n  const SVG_NAMESPACE = 'http://www.w3.org/2000/svg';\n  const HTML_NAMESPACE = 'http://www.w3.org/1999/xhtml';\n  /* Document namespace */\n  let NAMESPACE = HTML_NAMESPACE;\n  let IS_EMPTY_INPUT = false;\n\n  /* Allowed XHTML+XML namespaces */\n  let ALLOWED_NAMESPACES = null;\n  const DEFAULT_ALLOWED_NAMESPACES = addToSet(\n    {},\n    [MATHML_NAMESPACE, SVG_NAMESPACE, HTML_NAMESPACE],\n    stringToString\n  );\n\n  let MATHML_TEXT_INTEGRATION_POINTS = addToSet({}, [\n    'mi',\n    'mo',\n    'mn',\n    'ms',\n    'mtext',\n  ]);\n\n  let HTML_INTEGRATION_POINTS = addToSet({}, ['annotation-xml']);\n\n  // Certain elements are allowed in both SVG and HTML\n  // namespace. We need to specify them explicitly\n  // so that they don't get erroneously deleted from\n  // HTML namespace.\n  const COMMON_SVG_AND_HTML_ELEMENTS = addToSet({}, [\n    'title',\n    'style',\n    'font',\n    'a',\n    'script',\n  ]);\n\n  /* Parsing of strict XHTML documents */\n  let PARSER_MEDIA_TYPE: null | DOMParserSupportedType = null;\n  const SUPPORTED_PARSER_MEDIA_TYPES = ['application/xhtml+xml', 'text/html'];\n  const DEFAULT_PARSER_MEDIA_TYPE = 'text/html';\n  let transformCaseFunc: null | Parameters<typeof addToSet>[2] = null;\n\n  /* Keep a reference to config to pass to hooks */\n  let CONFIG: Config | null = null;\n\n  /* Ideally, do not touch anything below this line */\n  /* ______________________________________________ */\n\n  const formElement = document.createElement('form');\n\n  const isRegexOrFunction = function (\n    testValue: unknown\n  ): testValue is Function | RegExp {\n    return testValue instanceof RegExp || testValue instanceof Function;\n  };\n\n  /**\n   * _parseConfig\n   *\n   * @param cfg optional config literal\n   */\n  // eslint-disable-next-line complexity\n  const _parseConfig = function (cfg: Config = {}): void {\n    if (CONFIG && CONFIG === cfg) {\n      return;\n    }\n\n    /* Shield configuration object from tampering */\n    if (!cfg || typeof cfg !== 'object') {\n      cfg = {};\n    }\n\n    /* Shield configuration object from prototype pollution */\n    cfg = clone(cfg);\n\n    PARSER_MEDIA_TYPE =\n      // eslint-disable-next-line unicorn/prefer-includes\n      SUPPORTED_PARSER_MEDIA_TYPES.indexOf(cfg.PARSER_MEDIA_TYPE) === -1\n        ? DEFAULT_PARSER_MEDIA_TYPE\n        : cfg.PARSER_MEDIA_TYPE;\n\n    // HTML tags and attributes are not case-sensitive, converting to lowercase. Keeping XHTML as is.\n    transformCaseFunc =\n      PARSER_MEDIA_TYPE === 'application/xhtml+xml'\n        ? stringToString\n        : stringToLowerCase;\n\n    /* Set configuration parameters */\n    ALLOWED_TAGS = objectHasOwnProperty(cfg, 'ALLOWED_TAGS')\n      ? addToSet({}, cfg.ALLOWED_TAGS, transformCaseFunc)\n      : DEFAULT_ALLOWED_TAGS;\n    ALLOWED_ATTR = objectHasOwnProperty(cfg, 'ALLOWED_ATTR')\n      ? addToSet({}, cfg.ALLOWED_ATTR, transformCaseFunc)\n      : DEFAULT_ALLOWED_ATTR;\n    ALLOWED_NAMESPACES = objectHasOwnProperty(cfg, 'ALLOWED_NAMESPACES')\n      ? addToSet({}, cfg.ALLOWED_NAMESPACES, stringToString)\n      : DEFAULT_ALLOWED_NAMESPACES;\n    URI_SAFE_ATTRIBUTES = objectHasOwnProperty(cfg, 'ADD_URI_SAFE_ATTR')\n      ? addToSet(\n          clone(DEFAULT_URI_SAFE_ATTRIBUTES),\n          cfg.ADD_URI_SAFE_ATTR,\n          transformCaseFunc\n        )\n      : DEFAULT_URI_SAFE_ATTRIBUTES;\n    DATA_URI_TAGS = objectHasOwnProperty(cfg, 'ADD_DATA_URI_TAGS')\n      ? addToSet(\n          clone(DEFAULT_DATA_URI_TAGS),\n          cfg.ADD_DATA_URI_TAGS,\n          transformCaseFunc\n        )\n      : DEFAULT_DATA_URI_TAGS;\n    FORBID_CONTENTS = objectHasOwnProperty(cfg, 'FORBID_CONTENTS')\n      ? addToSet({}, cfg.FORBID_CONTENTS, transformCaseFunc)\n      : DEFAULT_FORBID_CONTENTS;\n    FORBID_TAGS = objectHasOwnProperty(cfg, 'FORBID_TAGS')\n      ? addToSet({}, cfg.FORBID_TAGS, transformCaseFunc)\n      : clone({});\n    FORBID_ATTR = objectHasOwnProperty(cfg, 'FORBID_ATTR')\n      ? addToSet({}, cfg.FORBID_ATTR, transformCaseFunc)\n      : clone({});\n    USE_PROFILES = objectHasOwnProperty(cfg, 'USE_PROFILES')\n      ? cfg.USE_PROFILES\n      : false;\n    ALLOW_ARIA_ATTR = cfg.ALLOW_ARIA_ATTR !== false; // Default true\n    ALLOW_DATA_ATTR = cfg.ALLOW_DATA_ATTR !== false; // Default true\n    ALLOW_UNKNOWN_PROTOCOLS = cfg.ALLOW_UNKNOWN_PROTOCOLS || false; // Default false\n    ALLOW_SELF_CLOSE_IN_ATTR = cfg.ALLOW_SELF_CLOSE_IN_ATTR !== false; // Default true\n    SAFE_FOR_TEMPLATES = cfg.SAFE_FOR_TEMPLATES || false; // Default false\n    SAFE_FOR_XML = cfg.SAFE_FOR_XML !== false; // Default true\n    WHOLE_DOCUMENT = cfg.WHOLE_DOCUMENT || false; // Default false\n    RETURN_DOM = cfg.RETURN_DOM || false; // Default false\n    RETURN_DOM_FRAGMENT = cfg.RETURN_DOM_FRAGMENT || false; // Default false\n    RETURN_TRUSTED_TYPE = cfg.RETURN_TRUSTED_TYPE || false; // Default false\n    FORCE_BODY = cfg.FORCE_BODY || false; // Default false\n    SANITIZE_DOM = cfg.SANITIZE_DOM !== false; // Default true\n    SANITIZE_NAMED_PROPS = cfg.SANITIZE_NAMED_PROPS || false; // Default false\n    KEEP_CONTENT = cfg.KEEP_CONTENT !== false; // Default true\n    IN_PLACE = cfg.IN_PLACE || false; // Default false\n    IS_ALLOWED_URI = cfg.ALLOWED_URI_REGEXP || EXPRESSIONS.IS_ALLOWED_URI;\n    NAMESPACE = cfg.NAMESPACE || HTML_NAMESPACE;\n    MATHML_TEXT_INTEGRATION_POINTS =\n      cfg.MATHML_TEXT_INTEGRATION_POINTS || MATHML_TEXT_INTEGRATION_POINTS;\n    HTML_INTEGRATION_POINTS =\n      cfg.HTML_INTEGRATION_POINTS || HTML_INTEGRATION_POINTS;\n\n    CUSTOM_ELEMENT_HANDLING = cfg.CUSTOM_ELEMENT_HANDLING || {};\n    if (\n      cfg.CUSTOM_ELEMENT_HANDLING &&\n      isRegexOrFunction(cfg.CUSTOM_ELEMENT_HANDLING.tagNameCheck)\n    ) {\n      CUSTOM_ELEMENT_HANDLING.tagNameCheck =\n        cfg.CUSTOM_ELEMENT_HANDLING.tagNameCheck;\n    }\n\n    if (\n      cfg.CUSTOM_ELEMENT_HANDLING &&\n      isRegexOrFunction(cfg.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)\n    ) {\n      CUSTOM_ELEMENT_HANDLING.attributeNameCheck =\n        cfg.CUSTOM_ELEMENT_HANDLING.attributeNameCheck;\n    }\n\n    if (\n      cfg.CUSTOM_ELEMENT_HANDLING &&\n      typeof cfg.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements ===\n        'boolean'\n    ) {\n      CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements =\n        cfg.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements;\n    }\n\n    if (SAFE_FOR_TEMPLATES) {\n      ALLOW_DATA_ATTR = false;\n    }\n\n    if (RETURN_DOM_FRAGMENT) {\n      RETURN_DOM = true;\n    }\n\n    /* Parse profile info */\n    if (USE_PROFILES) {\n      ALLOWED_TAGS = addToSet({}, TAGS.text);\n      ALLOWED_ATTR = [];\n      if (USE_PROFILES.html === true) {\n        addToSet(ALLOWED_TAGS, TAGS.html);\n        addToSet(ALLOWED_ATTR, ATTRS.html);\n      }\n\n      if (USE_PROFILES.svg === true) {\n        addToSet(ALLOWED_TAGS, TAGS.svg);\n        addToSet(ALLOWED_ATTR, ATTRS.svg);\n        addToSet(ALLOWED_ATTR, ATTRS.xml);\n      }\n\n      if (USE_PROFILES.svgFilters === true) {\n        addToSet(ALLOWED_TAGS, TAGS.svgFilters);\n        addToSet(ALLOWED_ATTR, ATTRS.svg);\n        addToSet(ALLOWED_ATTR, ATTRS.xml);\n      }\n\n      if (USE_PROFILES.mathMl === true) {\n        addToSet(ALLOWED_TAGS, TAGS.mathMl);\n        addToSet(ALLOWED_ATTR, ATTRS.mathMl);\n        addToSet(ALLOWED_ATTR, ATTRS.xml);\n      }\n    }\n\n    /* Merge configuration parameters */\n    if (cfg.ADD_TAGS) {\n      if (typeof cfg.ADD_TAGS === 'function') {\n        EXTRA_ELEMENT_HANDLING.tagCheck = cfg.ADD_TAGS;\n      } else {\n        if (ALLOWED_TAGS === DEFAULT_ALLOWED_TAGS) {\n          ALLOWED_TAGS = clone(ALLOWED_TAGS);\n        }\n\n        addToSet(ALLOWED_TAGS, cfg.ADD_TAGS, transformCaseFunc);\n      }\n    }\n\n    if (cfg.ADD_ATTR) {\n      if (typeof cfg.ADD_ATTR === 'function') {\n        EXTRA_ELEMENT_HANDLING.attributeCheck = cfg.ADD_ATTR;\n      } else {\n        if (ALLOWED_ATTR === DEFAULT_ALLOWED_ATTR) {\n          ALLOWED_ATTR = clone(ALLOWED_ATTR);\n        }\n\n        addToSet(ALLOWED_ATTR, cfg.ADD_ATTR, transformCaseFunc);\n      }\n    }\n\n    if (cfg.ADD_URI_SAFE_ATTR) {\n      addToSet(URI_SAFE_ATTRIBUTES, cfg.ADD_URI_SAFE_ATTR, transformCaseFunc);\n    }\n\n    if (cfg.FORBID_CONTENTS) {\n      if (FORBID_CONTENTS === DEFAULT_FORBID_CONTENTS) {\n        FORBID_CONTENTS = clone(FORBID_CONTENTS);\n      }\n\n      addToSet(FORBID_CONTENTS, cfg.FORBID_CONTENTS, transformCaseFunc);\n    }\n\n    if (cfg.ADD_FORBID_CONTENTS) {\n      if (FORBID_CONTENTS === DEFAULT_FORBID_CONTENTS) {\n        FORBID_CONTENTS = clone(FORBID_CONTENTS);\n      }\n\n      addToSet(FORBID_CONTENTS, cfg.ADD_FORBID_CONTENTS, transformCaseFunc);\n    }\n\n    /* Add #text in case KEEP_CONTENT is set to true */\n    if (KEEP_CONTENT) {\n      ALLOWED_TAGS['#text'] = true;\n    }\n\n    /* Add html, head and body to ALLOWED_TAGS in case WHOLE_DOCUMENT is true */\n    if (WHOLE_DOCUMENT) {\n      addToSet(ALLOWED_TAGS, ['html', 'head', 'body']);\n    }\n\n    /* Add tbody to ALLOWED_TAGS in case tables are permitted, see #286, #365 */\n    if (ALLOWED_TAGS.table) {\n      addToSet(ALLOWED_TAGS, ['tbody']);\n      delete FORBID_TAGS.tbody;\n    }\n\n    if (cfg.TRUSTED_TYPES_POLICY) {\n      if (typeof cfg.TRUSTED_TYPES_POLICY.createHTML !== 'function') {\n        throw typeErrorCreate(\n          'TRUSTED_TYPES_POLICY configuration option must provide a \"createHTML\" hook.'\n        );\n      }\n\n      if (typeof cfg.TRUSTED_TYPES_POLICY.createScriptURL !== 'function') {\n        throw typeErrorCreate(\n          'TRUSTED_TYPES_POLICY configuration option must provide a \"createScriptURL\" hook.'\n        );\n      }\n\n      // Overwrite existing TrustedTypes policy.\n      trustedTypesPolicy = cfg.TRUSTED_TYPES_POLICY;\n\n      // Sign local variables required by `sanitize`.\n      emptyHTML = trustedTypesPolicy.createHTML('');\n    } else {\n      // Uninitialized policy, attempt to initialize the internal dompurify policy.\n      if (trustedTypesPolicy === undefined) {\n        trustedTypesPolicy = _createTrustedTypesPolicy(\n          trustedTypes,\n          currentScript\n        );\n      }\n\n      // If creating the internal policy succeeded sign internal variables.\n      if (trustedTypesPolicy !== null && typeof emptyHTML === 'string') {\n        emptyHTML = trustedTypesPolicy.createHTML('');\n      }\n    }\n\n    // Prevent further manipulation of configuration.\n    // Not available in IE8, Safari 5, etc.\n    if (freeze) {\n      freeze(cfg);\n    }\n\n    CONFIG = cfg;\n  };\n\n  /* Keep track of all possible SVG and MathML tags\n   * so that we can perform the namespace checks\n   * correctly. */\n  const ALL_SVG_TAGS = addToSet({}, [\n    ...TAGS.svg,\n    ...TAGS.svgFilters,\n    ...TAGS.svgDisallowed,\n  ]);\n  const ALL_MATHML_TAGS = addToSet({}, [\n    ...TAGS.mathMl,\n    ...TAGS.mathMlDisallowed,\n  ]);\n\n  /**\n   * @param element a DOM element whose namespace is being checked\n   * @returns Return false if the element has a\n   *  namespace that a spec-compliant parser would never\n   *  return. Return true otherwise.\n   */\n  const _checkValidNamespace = function (element: Element): boolean {\n    let parent = getParentNode(element);\n\n    // In JSDOM, if we're inside shadow DOM, then parentNode\n    // can be null. We just simulate parent in this case.\n    if (!parent || !parent.tagName) {\n      parent = {\n        namespaceURI: NAMESPACE,\n        tagName: 'template',\n      };\n    }\n\n    const tagName = stringToLowerCase(element.tagName);\n    const parentTagName = stringToLowerCase(parent.tagName);\n\n    if (!ALLOWED_NAMESPACES[element.namespaceURI]) {\n      return false;\n    }\n\n    if (element.namespaceURI === SVG_NAMESPACE) {\n      // The only way to switch from HTML namespace to SVG\n      // is via <svg>. If it happens via any other tag, then\n      // it should be killed.\n      if (parent.namespaceURI === HTML_NAMESPACE) {\n        return tagName === 'svg';\n      }\n\n      // The only way to switch from MathML to SVG is via`\n      // svg if parent is either <annotation-xml> or MathML\n      // text integration points.\n      if (parent.namespaceURI === MATHML_NAMESPACE) {\n        return (\n          tagName === 'svg' &&\n          (parentTagName === 'annotation-xml' ||\n            MATHML_TEXT_INTEGRATION_POINTS[parentTagName])\n        );\n      }\n\n      // We only allow elements that are defined in SVG\n      // spec. All others are disallowed in SVG namespace.\n      return Boolean(ALL_SVG_TAGS[tagName]);\n    }\n\n    if (element.namespaceURI === MATHML_NAMESPACE) {\n      // The only way to switch from HTML namespace to MathML\n      // is via <math>. If it happens via any other tag, then\n      // it should be killed.\n      if (parent.namespaceURI === HTML_NAMESPACE) {\n        return tagName === 'math';\n      }\n\n      // The only way to switch from SVG to MathML is via\n      // <math> and HTML integration points\n      if (parent.namespaceURI === SVG_NAMESPACE) {\n        return tagName === 'math' && HTML_INTEGRATION_POINTS[parentTagName];\n      }\n\n      // We only allow elements that are defined in MathML\n      // spec. All others are disallowed in MathML namespace.\n      return Boolean(ALL_MATHML_TAGS[tagName]);\n    }\n\n    if (element.namespaceURI === HTML_NAMESPACE) {\n      // The only way to switch from SVG to HTML is via\n      // HTML integration points, and from MathML to HTML\n      // is via MathML text integration points\n      if (\n        parent.namespaceURI === SVG_NAMESPACE &&\n        !HTML_INTEGRATION_POINTS[parentTagName]\n      ) {\n        return false;\n      }\n\n      if (\n        parent.namespaceURI === MATHML_NAMESPACE &&\n        !MATHML_TEXT_INTEGRATION_POINTS[parentTagName]\n      ) {\n        return false;\n      }\n\n      // We disallow tags that are specific for MathML\n      // or SVG and should never appear in HTML namespace\n      return (\n        !ALL_MATHML_TAGS[tagName] &&\n        (COMMON_SVG_AND_HTML_ELEMENTS[tagName] || !ALL_SVG_TAGS[tagName])\n      );\n    }\n\n    // For XHTML and XML documents that support custom namespaces\n    if (\n      PARSER_MEDIA_TYPE === 'application/xhtml+xml' &&\n      ALLOWED_NAMESPACES[element.namespaceURI]\n    ) {\n      return true;\n    }\n\n    // The code should never reach this place (this means\n    // that the element somehow got namespace that is not\n    // HTML, SVG, MathML or allowed via ALLOWED_NAMESPACES).\n    // Return false just in case.\n    return false;\n  };\n\n  /**\n   * _forceRemove\n   *\n   * @param node a DOM node\n   */\n  const _forceRemove = function (node: Node): void {\n    arrayPush(DOMPurify.removed, { element: node });\n\n    try {\n      // eslint-disable-next-line unicorn/prefer-dom-node-remove\n      getParentNode(node).removeChild(node);\n    } catch (_) {\n      remove(node);\n    }\n  };\n\n  /**\n   * _removeAttribute\n   *\n   * @param name an Attribute name\n   * @param element a DOM node\n   */\n  const _removeAttribute = function (name: string, element: Element): void {\n    try {\n      arrayPush(DOMPurify.removed, {\n        attribute: element.getAttributeNode(name),\n        from: element,\n      });\n    } catch (_) {\n      arrayPush(DOMPurify.removed, {\n        attribute: null,\n        from: element,\n      });\n    }\n\n    element.removeAttribute(name);\n\n    // We void attribute values for unremovable \"is\" attributes\n    if (name === 'is') {\n      if (RETURN_DOM || RETURN_DOM_FRAGMENT) {\n        try {\n          _forceRemove(element);\n        } catch (_) {}\n      } else {\n        try {\n          element.setAttribute(name, '');\n        } catch (_) {}\n      }\n    }\n  };\n\n  /**\n   * _initDocument\n   *\n   * @param dirty - a string of dirty markup\n   * @return a DOM, filled with the dirty markup\n   */\n  const _initDocument = function (dirty: string): Document {\n    /* Create a HTML document */\n    let doc = null;\n    let leadingWhitespace = null;\n\n    if (FORCE_BODY) {\n      dirty = '<remove></remove>' + dirty;\n    } else {\n      /* If FORCE_BODY isn't used, leading whitespace needs to be preserved manually */\n      const matches = stringMatch(dirty, /^[\\r\\n\\t ]+/);\n      leadingWhitespace = matches && matches[0];\n    }\n\n    if (\n      PARSER_MEDIA_TYPE === 'application/xhtml+xml' &&\n      NAMESPACE === HTML_NAMESPACE\n    ) {\n      // Root of XHTML doc must contain xmlns declaration (see https://www.w3.org/TR/xhtml1/normative.html#strict)\n      dirty =\n        '<html xmlns=\"http://www.w3.org/1999/xhtml\"><head></head><body>' +\n        dirty +\n        '</body></html>';\n    }\n\n    const dirtyPayload = trustedTypesPolicy\n      ? trustedTypesPolicy.createHTML(dirty)\n      : dirty;\n    /*\n     * Use the DOMParser API by default, fallback later if needs be\n     * DOMParser not work for svg when has multiple root element.\n     */\n    if (NAMESPACE === HTML_NAMESPACE) {\n      try {\n        doc = new DOMParser().parseFromString(dirtyPayload, PARSER_MEDIA_TYPE);\n      } catch (_) {}\n    }\n\n    /* Use createHTMLDocument in case DOMParser is not available */\n    if (!doc || !doc.documentElement) {\n      doc = implementation.createDocument(NAMESPACE, 'template', null);\n      try {\n        doc.documentElement.innerHTML = IS_EMPTY_INPUT\n          ? emptyHTML\n          : dirtyPayload;\n      } catch (_) {\n        // Syntax error if dirtyPayload is invalid xml\n      }\n    }\n\n    const body = doc.body || doc.documentElement;\n\n    if (dirty && leadingWhitespace) {\n      body.insertBefore(\n        document.createTextNode(leadingWhitespace),\n        body.childNodes[0] || null\n      );\n    }\n\n    /* Work on whole document or just its body */\n    if (NAMESPACE === HTML_NAMESPACE) {\n      return getElementsByTagName.call(\n        doc,\n        WHOLE_DOCUMENT ? 'html' : 'body'\n      )[0];\n    }\n\n    return WHOLE_DOCUMENT ? doc.documentElement : body;\n  };\n\n  /**\n   * Creates a NodeIterator object that you can use to traverse filtered lists of nodes or elements in a document.\n   *\n   * @param root The root element or node to start traversing on.\n   * @return The created NodeIterator\n   */\n  const _createNodeIterator = function (root: Node): NodeIterator {\n    return createNodeIterator.call(\n      root.ownerDocument || root,\n      root,\n      // eslint-disable-next-line no-bitwise\n      NodeFilter.SHOW_ELEMENT |\n        NodeFilter.SHOW_COMMENT |\n        NodeFilter.SHOW_TEXT |\n        NodeFilter.SHOW_PROCESSING_INSTRUCTION |\n        NodeFilter.SHOW_CDATA_SECTION,\n      null\n    );\n  };\n\n  /**\n   * _isClobbered\n   *\n   * @param element element to check for clobbering attacks\n   * @return true if clobbered, false if safe\n   */\n  const _isClobbered = function (element: Element): boolean {\n    return (\n      element instanceof HTMLFormElement &&\n      (typeof element.nodeName !== 'string' ||\n        typeof element.textContent !== 'string' ||\n        typeof element.removeChild !== 'function' ||\n        !(element.attributes instanceof NamedNodeMap) ||\n        typeof element.removeAttribute !== 'function' ||\n        typeof element.setAttribute !== 'function' ||\n        typeof element.namespaceURI !== 'string' ||\n        typeof element.insertBefore !== 'function' ||\n        typeof element.hasChildNodes !== 'function')\n    );\n  };\n\n  /**\n   * Checks whether the given object is a DOM node.\n   *\n   * @param value object to check whether it's a DOM node\n   * @return true is object is a DOM node\n   */\n  const _isNode = function (value: unknown): value is Node {\n    return typeof Node === 'function' && value instanceof Node;\n  };\n\n  function _executeHooks<T extends HookFunction>(\n    hooks: HookFunction[],\n    currentNode: Parameters<T>[0],\n    data: Parameters<T>[1]\n  ): void {\n    arrayForEach(hooks, (hook: T) => {\n      hook.call(DOMPurify, currentNode, data, CONFIG);\n    });\n  }\n\n  /**\n   * _sanitizeElements\n   *\n   * @protect nodeName\n   * @protect textContent\n   * @protect removeChild\n   * @param currentNode to check for permission to exist\n   * @return true if node was killed, false if left alive\n   */\n  const _sanitizeElements = function (currentNode: any): boolean {\n    let content = null;\n\n    /* Execute a hook if present */\n    _executeHooks(hooks.beforeSanitizeElements, currentNode, null);\n\n    /* Check if element is clobbered or can clobber */\n    if (_isClobbered(currentNode)) {\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Now let's check the element's type and name */\n    const tagName = transformCaseFunc(currentNode.nodeName);\n\n    /* Execute a hook if present */\n    _executeHooks(hooks.uponSanitizeElement, currentNode, {\n      tagName,\n      allowedTags: ALLOWED_TAGS,\n    });\n\n    /* Detect mXSS attempts abusing namespace confusion */\n    if (\n      SAFE_FOR_XML &&\n      currentNode.hasChildNodes() &&\n      !_isNode(currentNode.firstElementChild) &&\n      regExpTest(/<[/\\w!]/g, currentNode.innerHTML) &&\n      regExpTest(/<[/\\w!]/g, currentNode.textContent)\n    ) {\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Remove any occurrence of processing instructions */\n    if (currentNode.nodeType === NODE_TYPE.progressingInstruction) {\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Remove any kind of possibly harmful comments */\n    if (\n      SAFE_FOR_XML &&\n      currentNode.nodeType === NODE_TYPE.comment &&\n      regExpTest(/<[/\\w]/g, currentNode.data)\n    ) {\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Remove element if anything forbids its presence */\n    if (\n      !(\n        EXTRA_ELEMENT_HANDLING.tagCheck instanceof Function &&\n        EXTRA_ELEMENT_HANDLING.tagCheck(tagName)\n      ) &&\n      (!ALLOWED_TAGS[tagName] || FORBID_TAGS[tagName])\n    ) {\n      /* Check if we have a custom element to handle */\n      if (!FORBID_TAGS[tagName] && _isBasicCustomElement(tagName)) {\n        if (\n          CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp &&\n          regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck, tagName)\n        ) {\n          return false;\n        }\n\n        if (\n          CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function &&\n          CUSTOM_ELEMENT_HANDLING.tagNameCheck(tagName)\n        ) {\n          return false;\n        }\n      }\n\n      /* Keep content except for bad-listed elements */\n      if (KEEP_CONTENT && !FORBID_CONTENTS[tagName]) {\n        const parentNode = getParentNode(currentNode) || currentNode.parentNode;\n        const childNodes = getChildNodes(currentNode) || currentNode.childNodes;\n\n        if (childNodes && parentNode) {\n          const childCount = childNodes.length;\n\n          for (let i = childCount - 1; i >= 0; --i) {\n            const childClone = cloneNode(childNodes[i], true);\n            childClone.__removalCount = (currentNode.__removalCount || 0) + 1;\n            parentNode.insertBefore(childClone, getNextSibling(currentNode));\n          }\n        }\n      }\n\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Check whether element has a valid namespace */\n    if (currentNode instanceof Element && !_checkValidNamespace(currentNode)) {\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Make sure that older browsers don't get fallback-tag mXSS */\n    if (\n      (tagName === 'noscript' ||\n        tagName === 'noembed' ||\n        tagName === 'noframes') &&\n      regExpTest(/<\\/no(script|embed|frames)/i, currentNode.innerHTML)\n    ) {\n      _forceRemove(currentNode);\n      return true;\n    }\n\n    /* Sanitize element content to be template-safe */\n    if (SAFE_FOR_TEMPLATES && currentNode.nodeType === NODE_TYPE.text) {\n      /* Get the element's text content */\n      content = currentNode.textContent;\n\n      arrayForEach([MUSTACHE_EXPR, ERB_EXPR, TMPLIT_EXPR], (expr: RegExp) => {\n        content = stringReplace(content, expr, ' ');\n      });\n\n      if (currentNode.textContent !== content) {\n        arrayPush(DOMPurify.removed, { element: currentNode.cloneNode() });\n        currentNode.textContent = content;\n      }\n    }\n\n    /* Execute a hook if present */\n    _executeHooks(hooks.afterSanitizeElements, currentNode, null);\n\n    return false;\n  };\n\n  /**\n   * _isValidAttribute\n   *\n   * @param lcTag Lowercase tag name of containing element.\n   * @param lcName Lowercase attribute name.\n   * @param value Attribute value.\n   * @return Returns true if `value` is valid, otherwise false.\n   */\n  // eslint-disable-next-line complexity\n  const _isValidAttribute = function (\n    lcTag: string,\n    lcName: string,\n    value: string\n  ): boolean {\n    /* Make sure attribute cannot clobber */\n    if (\n      SANITIZE_DOM &&\n      (lcName === 'id' || lcName === 'name') &&\n      (value in document || value in formElement)\n    ) {\n      return false;\n    }\n\n    /* Allow valid data-* attributes: At least one character after \"-\"\n        (https://html.spec.whatwg.org/multipage/dom.html#embedding-custom-non-visible-data-with-the-data-*-attributes)\n        XML-compatible (https://html.spec.whatwg.org/multipage/infrastructure.html#xml-compatible and http://www.w3.org/TR/xml/#d0e804)\n        We don't need to check the value; it's always URI safe. */\n    if (\n      ALLOW_DATA_ATTR &&\n      !FORBID_ATTR[lcName] &&\n      regExpTest(DATA_ATTR, lcName)\n    ) {\n      // This attribute is safe\n    } else if (ALLOW_ARIA_ATTR && regExpTest(ARIA_ATTR, lcName)) {\n      // This attribute is safe\n      /* Check if ADD_ATTR function allows this attribute */\n    } else if (\n      EXTRA_ELEMENT_HANDLING.attributeCheck instanceof Function &&\n      EXTRA_ELEMENT_HANDLING.attributeCheck(lcName, lcTag)\n    ) {\n      // This attribute is safe\n      /* Otherwise, check the name is permitted */\n    } else if (!ALLOWED_ATTR[lcName] || FORBID_ATTR[lcName]) {\n      if (\n        // First condition does a very basic check if a) it's basically a valid custom element tagname AND\n        // b) if the tagName passes whatever the user has configured for CUSTOM_ELEMENT_HANDLING.tagNameCheck\n        // and c) if the attribute name passes whatever the user has configured for CUSTOM_ELEMENT_HANDLING.attributeNameCheck\n        (_isBasicCustomElement(lcTag) &&\n          ((CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp &&\n            regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck, lcTag)) ||\n            (CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function &&\n              CUSTOM_ELEMENT_HANDLING.tagNameCheck(lcTag))) &&\n          ((CUSTOM_ELEMENT_HANDLING.attributeNameCheck instanceof RegExp &&\n            regExpTest(CUSTOM_ELEMENT_HANDLING.attributeNameCheck, lcName)) ||\n            (CUSTOM_ELEMENT_HANDLING.attributeNameCheck instanceof Function &&\n              CUSTOM_ELEMENT_HANDLING.attributeNameCheck(lcName, lcTag)))) ||\n        // Alternative, second condition checks if it's an `is`-attribute, AND\n        // the value passes whatever the user has configured for CUSTOM_ELEMENT_HANDLING.tagNameCheck\n        (lcName === 'is' &&\n          CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements &&\n          ((CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp &&\n            regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck, value)) ||\n            (CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function &&\n              CUSTOM_ELEMENT_HANDLING.tagNameCheck(value))))\n      ) {\n        // If user has supplied a regexp or function in CUSTOM_ELEMENT_HANDLING.tagNameCheck, we need to also allow derived custom elements using the same tagName test.\n        // Additionally, we need to allow attributes passing the CUSTOM_ELEMENT_HANDLING.attributeNameCheck user has configured, as custom elements can define these at their own discretion.\n      } else {\n        return false;\n      }\n      /* Check value is safe. First, is attr inert? If so, is safe */\n    } else if (URI_SAFE_ATTRIBUTES[lcName]) {\n      // This attribute is safe\n      /* Check no script, data or unknown possibly unsafe URI\n        unless we know URI values are safe for that attribute */\n    } else if (\n      regExpTest(IS_ALLOWED_URI, stringReplace(value, ATTR_WHITESPACE, ''))\n    ) {\n      // This attribute is safe\n      /* Keep image data URIs alive if src/xlink:href is allowed */\n      /* Further prevent gadget XSS for dynamically built script tags */\n    } else if (\n      (lcName === 'src' || lcName === 'xlink:href' || lcName === 'href') &&\n      lcTag !== 'script' &&\n      stringIndexOf(value, 'data:') === 0 &&\n      DATA_URI_TAGS[lcTag]\n    ) {\n      // This attribute is safe\n      /* Allow unknown protocols: This provides support for links that\n        are handled by protocol handlers which may be unknown ahead of\n        time, e.g. fb:, spotify: */\n    } else if (\n      ALLOW_UNKNOWN_PROTOCOLS &&\n      !regExpTest(IS_SCRIPT_OR_DATA, stringReplace(value, ATTR_WHITESPACE, ''))\n    ) {\n      // This attribute is safe\n      /* Check for binary attributes */\n    } else if (value) {\n      return false;\n    } else {\n      // Binary attributes are safe at this point\n      /* Anything else, presume unsafe, do not add it back */\n    }\n\n    return true;\n  };\n\n  /**\n   * _isBasicCustomElement\n   * checks if at least one dash is included in tagName, and it's not the first char\n   * for more sophisticated checking see https://github.com/sindresorhus/validate-element-name\n   *\n   * @param tagName name of the tag of the node to sanitize\n   * @returns Returns true if the tag name meets the basic criteria for a custom element, otherwise false.\n   */\n  const _isBasicCustomElement = function (tagName: string): RegExpMatchArray {\n    return tagName !== 'annotation-xml' && stringMatch(tagName, CUSTOM_ELEMENT);\n  };\n\n  /**\n   * _sanitizeAttributes\n   *\n   * @protect attributes\n   * @protect nodeName\n   * @protect removeAttribute\n   * @protect setAttribute\n   *\n   * @param currentNode to sanitize\n   */\n  const _sanitizeAttributes = function (currentNode: Element): void {\n    /* Execute a hook if present */\n    _executeHooks(hooks.beforeSanitizeAttributes, currentNode, null);\n\n    const { attributes } = currentNode;\n\n    /* Check if we have attributes; if not we might have a text node */\n    if (!attributes || _isClobbered(currentNode)) {\n      return;\n    }\n\n    const hookEvent = {\n      attrName: '',\n      attrValue: '',\n      keepAttr: true,\n      allowedAttributes: ALLOWED_ATTR,\n      forceKeepAttr: undefined,\n    };\n    let l = attributes.length;\n\n    /* Go backwards over all attributes; safely remove bad ones */\n    while (l--) {\n      const attr = attributes[l];\n      const { name, namespaceURI, value: attrValue } = attr;\n      const lcName = transformCaseFunc(name);\n\n      const initValue = attrValue;\n      let value = name === 'value' ? initValue : stringTrim(initValue);\n\n      /* Execute a hook if present */\n      hookEvent.attrName = lcName;\n      hookEvent.attrValue = value;\n      hookEvent.keepAttr = true;\n      hookEvent.forceKeepAttr = undefined; // Allows developers to see this is a property they can set\n      _executeHooks(hooks.uponSanitizeAttribute, currentNode, hookEvent);\n      value = hookEvent.attrValue;\n\n      /* Full DOM Clobbering protection via namespace isolation,\n       * Prefix id and name attributes with `user-content-`\n       */\n      if (SANITIZE_NAMED_PROPS && (lcName === 'id' || lcName === 'name')) {\n        // Remove the attribute with this value\n        _removeAttribute(name, currentNode);\n\n        // Prefix the value and later re-create the attribute with the sanitized value\n        value = SANITIZE_NAMED_PROPS_PREFIX + value;\n      }\n\n      /* Work around a security issue with comments inside attributes */\n      if (\n        SAFE_FOR_XML &&\n        regExpTest(/((--!?|])>)|<\\/(style|title|textarea)/i, value)\n      ) {\n        _removeAttribute(name, currentNode);\n        continue;\n      }\n\n      /* Make sure we cannot easily use animated hrefs, even if animations are allowed */\n      if (lcName === 'attributename' && stringMatch(value, 'href')) {\n        _removeAttribute(name, currentNode);\n        continue;\n      }\n\n      /* Did the hooks approve of the attribute? */\n      if (hookEvent.forceKeepAttr) {\n        continue;\n      }\n\n      /* Did the hooks approve of the attribute? */\n      if (!hookEvent.keepAttr) {\n        _removeAttribute(name, currentNode);\n        continue;\n      }\n\n      /* Work around a security issue in jQuery 3.0 */\n      if (!ALLOW_SELF_CLOSE_IN_ATTR && regExpTest(/\\/>/i, value)) {\n        _removeAttribute(name, currentNode);\n        continue;\n      }\n\n      /* Sanitize attribute content to be template-safe */\n      if (SAFE_FOR_TEMPLATES) {\n        arrayForEach([MUSTACHE_EXPR, ERB_EXPR, TMPLIT_EXPR], (expr: RegExp) => {\n          value = stringReplace(value, expr, ' ');\n        });\n      }\n\n      /* Is `value` valid for this attribute? */\n      const lcTag = transformCaseFunc(currentNode.nodeName);\n      if (!_isValidAttribute(lcTag, lcName, value)) {\n        _removeAttribute(name, currentNode);\n        continue;\n      }\n\n      /* Handle attributes that require Trusted Types */\n      if (\n        trustedTypesPolicy &&\n        typeof trustedTypes === 'object' &&\n        typeof trustedTypes.getAttributeType === 'function'\n      ) {\n        if (namespaceURI) {\n          /* Namespaces are not yet supported, see https://bugs.chromium.org/p/chromium/issues/detail?id=1305293 */\n        } else {\n          switch (trustedTypes.getAttributeType(lcTag, lcName)) {\n            case 'TrustedHTML': {\n              value = trustedTypesPolicy.createHTML(value);\n              break;\n            }\n\n            case 'TrustedScriptURL': {\n              value = trustedTypesPolicy.createScriptURL(value);\n              break;\n            }\n\n            default: {\n              break;\n            }\n          }\n        }\n      }\n\n      /* Handle invalid data-* attribute set by try-catching it */\n      if (value !== initValue) {\n        try {\n          if (namespaceURI) {\n            currentNode.setAttributeNS(namespaceURI, name, value);\n          } else {\n            /* Fallback to setAttribute() for browser-unrecognized namespaces e.g. \"x-schema\". */\n            currentNode.setAttribute(name, value);\n          }\n\n          if (_isClobbered(currentNode)) {\n            _forceRemove(currentNode);\n          } else {\n            arrayPop(DOMPurify.removed);\n          }\n        } catch (_) {\n          _removeAttribute(name, currentNode);\n        }\n      }\n    }\n\n    /* Execute a hook if present */\n    _executeHooks(hooks.afterSanitizeAttributes, currentNode, null);\n  };\n\n  /**\n   * _sanitizeShadowDOM\n   *\n   * @param fragment to iterate over recursively\n   */\n  const _sanitizeShadowDOM = function (fragment: DocumentFragment): void {\n    let shadowNode = null;\n    const shadowIterator = _createNodeIterator(fragment);\n\n    /* Execute a hook if present */\n    _executeHooks(hooks.beforeSanitizeShadowDOM, fragment, null);\n\n    while ((shadowNode = shadowIterator.nextNode())) {\n      /* Execute a hook if present */\n      _executeHooks(hooks.uponSanitizeShadowNode, shadowNode, null);\n\n      /* Sanitize tags and elements */\n      _sanitizeElements(shadowNode);\n\n      /* Check attributes next */\n      _sanitizeAttributes(shadowNode);\n\n      /* Deep shadow DOM detected */\n      if (shadowNode.content instanceof DocumentFragment) {\n        _sanitizeShadowDOM(shadowNode.content);\n      }\n    }\n\n    /* Execute a hook if present */\n    _executeHooks(hooks.afterSanitizeShadowDOM, fragment, null);\n  };\n\n  // eslint-disable-next-line complexity\n  DOMPurify.sanitize = function (dirty, cfg = {}) {\n    let body = null;\n    let importedNode = null;\n    let currentNode = null;\n    let returnNode = null;\n    /* Make sure we have a string to sanitize.\n      DO NOT return early, as this will return the wrong type if\n      the user has requested a DOM object rather than a string */\n    IS_EMPTY_INPUT = !dirty;\n    if (IS_EMPTY_INPUT) {\n      dirty = '<!-->';\n    }\n\n    /* Stringify, in case dirty is an object */\n    if (typeof dirty !== 'string' && !_isNode(dirty)) {\n      if (typeof dirty.toString === 'function') {\n        dirty = dirty.toString();\n        if (typeof dirty !== 'string') {\n          throw typeErrorCreate('dirty is not a string, aborting');\n        }\n      } else {\n        throw typeErrorCreate('toString is not a function');\n      }\n    }\n\n    /* Return dirty HTML if DOMPurify cannot run */\n    if (!DOMPurify.isSupported) {\n      return dirty;\n    }\n\n    /* Assign config vars */\n    if (!SET_CONFIG) {\n      _parseConfig(cfg);\n    }\n\n    /* Clean up removed elements */\n    DOMPurify.removed = [];\n\n    /* Check if dirty is correctly typed for IN_PLACE */\n    if (typeof dirty === 'string') {\n      IN_PLACE = false;\n    }\n\n    if (IN_PLACE) {\n      /* Do some early pre-sanitization to avoid unsafe root nodes */\n      if ((dirty as Node).nodeName) {\n        const tagName = transformCaseFunc((dirty as Node).nodeName);\n        if (!ALLOWED_TAGS[tagName] || FORBID_TAGS[tagName]) {\n          throw typeErrorCreate(\n            'root node is forbidden and cannot be sanitized in-place'\n          );\n        }\n      }\n    } else if (dirty instanceof Node) {\n      /* If dirty is a DOM element, append to an empty document to avoid\n         elements being stripped by the parser */\n      body = _initDocument('<!---->');\n      importedNode = body.ownerDocument.importNode(dirty, true);\n      if (\n        importedNode.nodeType === NODE_TYPE.element &&\n        importedNode.nodeName === 'BODY'\n      ) {\n        /* Node is already a body, use as is */\n        body = importedNode;\n      } else if (importedNode.nodeName === 'HTML') {\n        body = importedNode;\n      } else {\n        // eslint-disable-next-line unicorn/prefer-dom-node-append\n        body.appendChild(importedNode);\n      }\n    } else {\n      /* Exit directly if we have nothing to do */\n      if (\n        !RETURN_DOM &&\n        !SAFE_FOR_TEMPLATES &&\n        !WHOLE_DOCUMENT &&\n        // eslint-disable-next-line unicorn/prefer-includes\n        dirty.indexOf('<') === -1\n      ) {\n        return trustedTypesPolicy && RETURN_TRUSTED_TYPE\n          ? trustedTypesPolicy.createHTML(dirty)\n          : dirty;\n      }\n\n      /* Initialize the document to work on */\n      body = _initDocument(dirty);\n\n      /* Check we have a DOM node from the data */\n      if (!body) {\n        return RETURN_DOM ? null : RETURN_TRUSTED_TYPE ? emptyHTML : '';\n      }\n    }\n\n    /* Remove first element node (ours) if FORCE_BODY is set */\n    if (body && FORCE_BODY) {\n      _forceRemove(body.firstChild);\n    }\n\n    /* Get node iterator */\n    const nodeIterator = _createNodeIterator(IN_PLACE ? dirty : body);\n\n    /* Now start iterating over the created document */\n    while ((currentNode = nodeIterator.nextNode())) {\n      /* Sanitize tags and elements */\n      _sanitizeElements(currentNode);\n\n      /* Check attributes next */\n      _sanitizeAttributes(currentNode);\n\n      /* Shadow DOM detected, sanitize it */\n      if (currentNode.content instanceof DocumentFragment) {\n        _sanitizeShadowDOM(currentNode.content);\n      }\n    }\n\n    /* If we sanitized `dirty` in-place, return it. */\n    if (IN_PLACE) {\n      return dirty;\n    }\n\n    /* Return sanitized string or DOM */\n    if (RETURN_DOM) {\n      if (RETURN_DOM_FRAGMENT) {\n        returnNode = createDocumentFragment.call(body.ownerDocument);\n\n        while (body.firstChild) {\n          // eslint-disable-next-line unicorn/prefer-dom-node-append\n          returnNode.appendChild(body.firstChild);\n        }\n      } else {\n        returnNode = body;\n      }\n\n      if (ALLOWED_ATTR.shadowroot || ALLOWED_ATTR.shadowrootmode) {\n        /*\n          AdoptNode() is not used because internal state is not reset\n          (e.g. the past names map of a HTMLFormElement), this is safe\n          in theory but we would rather not risk another attack vector.\n          The state that is cloned by importNode() is explicitly defined\n          by the specs.\n        */\n        returnNode = importNode.call(originalDocument, returnNode, true);\n      }\n\n      return returnNode;\n    }\n\n    let serializedHTML = WHOLE_DOCUMENT ? body.outerHTML : body.innerHTML;\n\n    /* Serialize doctype if allowed */\n    if (\n      WHOLE_DOCUMENT &&\n      ALLOWED_TAGS['!doctype'] &&\n      body.ownerDocument &&\n      body.ownerDocument.doctype &&\n      body.ownerDocument.doctype.name &&\n      regExpTest(EXPRESSIONS.DOCTYPE_NAME, body.ownerDocument.doctype.name)\n    ) {\n      serializedHTML =\n        '<!DOCTYPE ' + body.ownerDocument.doctype.name + '>\\n' + serializedHTML;\n    }\n\n    /* Sanitize final string template-safe */\n    if (SAFE_FOR_TEMPLATES) {\n      arrayForEach([MUSTACHE_EXPR, ERB_EXPR, TMPLIT_EXPR], (expr: RegExp) => {\n        serializedHTML = stringReplace(serializedHTML, expr, ' ');\n      });\n    }\n\n    return trustedTypesPolicy && RETURN_TRUSTED_TYPE\n      ? trustedTypesPolicy.createHTML(serializedHTML)\n      : serializedHTML;\n  };\n\n  DOMPurify.setConfig = function (cfg = {}) {\n    _parseConfig(cfg);\n    SET_CONFIG = true;\n  };\n\n  DOMPurify.clearConfig = function () {\n    CONFIG = null;\n    SET_CONFIG = false;\n  };\n\n  DOMPurify.isValidAttribute = function (tag, attr, value) {\n    /* Initialize shared config vars if necessary. */\n    if (!CONFIG) {\n      _parseConfig({});\n    }\n\n    const lcTag = transformCaseFunc(tag);\n    const lcName = transformCaseFunc(attr);\n    return _isValidAttribute(lcTag, lcName, value);\n  };\n\n  DOMPurify.addHook = function (\n    entryPoint: keyof HooksMap,\n    hookFunction: HookFunction\n  ) {\n    if (typeof hookFunction !== 'function') {\n      return;\n    }\n\n    arrayPush(hooks[entryPoint], hookFunction);\n  };\n\n  DOMPurify.removeHook = function (\n    entryPoint: keyof HooksMap,\n    hookFunction: HookFunction\n  ) {\n    if (hookFunction !== undefined) {\n      const index = arrayLastIndexOf(hooks[entryPoint], hookFunction);\n\n      return index === -1\n        ? undefined\n        : arraySplice(hooks[entryPoint], index, 1)[0];\n    }\n\n    return arrayPop(hooks[entryPoint]);\n  };\n\n  DOMPurify.removeHooks = function (entryPoint: keyof HooksMap) {\n    hooks[entryPoint] = [];\n  };\n\n  DOMPurify.removeAllHooks = function () {\n    hooks = _createHooksMap();\n  };\n\n  return DOMPurify;\n}\n\nexport default createDOMPurify();\n\nexport interface DOMPurify {\n  /**\n   * Creates a DOMPurify instance using the given window-like object. Defaults to `window`.\n   */\n  (root?: WindowLike): DOMPurify;\n\n  /**\n   * Version label, exposed for easier checks\n   * if DOMPurify is up to date or not\n   */\n  version: string;\n\n  /**\n   * Array of elements that DOMPurify removed during sanitation.\n   * Empty if nothing was removed.\n   */\n  removed: Array<RemovedElement | RemovedAttribute>;\n\n  /**\n   * Expose whether this browser supports running the full DOMPurify.\n   */\n  isSupported: boolean;\n\n  /**\n   * Set the configuration once.\n   *\n   * @param cfg configuration object\n   */\n  setConfig(cfg?: Config): void;\n\n  /**\n   * Removes the configuration.\n   */\n  clearConfig(): void;\n\n  /**\n   * Provides core sanitation functionality.\n   *\n   * @param dirty string or DOM node\n   * @param cfg object\n   * @returns Sanitized TrustedHTML.\n   */\n  sanitize(\n    dirty: string | Node,\n    cfg: Config & { RETURN_TRUSTED_TYPE: true }\n  ): TrustedHTML;\n\n  /**\n   * Provides core sanitation functionality.\n   *\n   * @param dirty DOM node\n   * @param cfg object\n   * @returns Sanitized DOM node.\n   */\n  sanitize(dirty: Node, cfg: Config & { IN_PLACE: true }): Node;\n\n  /**\n   * Provides core sanitation functionality.\n   *\n   * @param dirty string or DOM node\n   * @param cfg object\n   * @returns Sanitized DOM node.\n   */\n  sanitize(dirty: string | Node, cfg: Config & { RETURN_DOM: true }): Node;\n\n  /**\n   * Provides core sanitation functionality.\n   *\n   * @param dirty string or DOM node\n   * @param cfg object\n   * @returns Sanitized document fragment.\n   */\n  sanitize(\n    dirty: string | Node,\n    cfg: Config & { RETURN_DOM_FRAGMENT: true }\n  ): DocumentFragment;\n\n  /**\n   * Provides core sanitation functionality.\n   *\n   * @param dirty string or DOM node\n   * @param cfg object\n   * @returns Sanitized string.\n   */\n  sanitize(dirty: string | Node, cfg?: Config): string;\n\n  /**\n   * Checks if an attribute value is valid.\n   * Uses last set config, if any. Otherwise, uses config defaults.\n   *\n   * @param tag Tag name of containing element.\n   * @param attr Attribute name.\n   * @param value Attribute value.\n   * @returns Returns true if `value` is valid. Otherwise, returns false.\n   */\n  isValidAttribute(tag: string, attr: string, value: string): boolean;\n\n  /**\n   * Adds a DOMPurify hook.\n   *\n   * @param entryPoint entry point for the hook to add\n   * @param hookFunction function to execute\n   */\n  addHook(entryPoint: BasicHookName, hookFunction: NodeHook): void;\n\n  /**\n   * Adds a DOMPurify hook.\n   *\n   * @param entryPoint entry point for the hook to add\n   * @param hookFunction function to execute\n   */\n  addHook(entryPoint: ElementHookName, hookFunction: ElementHook): void;\n\n  /**\n   * Adds a DOMPurify hook.\n   *\n   * @param entryPoint entry point for the hook to add\n   * @param hookFunction function to execute\n   */\n  addHook(\n    entryPoint: DocumentFragmentHookName,\n    hookFunction: DocumentFragmentHook\n  ): void;\n\n  /**\n   * Adds a DOMPurify hook.\n   *\n   * @param entryPoint entry point for the hook to add\n   * @param hookFunction function to execute\n   */\n  addHook(\n    entryPoint: 'uponSanitizeElement',\n    hookFunction: UponSanitizeElementHook\n  ): void;\n\n  /**\n   * Adds a DOMPurify hook.\n   *\n   * @param entryPoint entry point for the hook to add\n   * @param hookFunction function to execute\n   */\n  addHook(\n    entryPoint: 'uponSanitizeAttribute',\n    hookFunction: UponSanitizeAttributeHook\n  ): void;\n\n  /**\n   * Remove a DOMPurify hook at a given entryPoint\n   * (pops it from the stack of hooks if hook not specified)\n   *\n   * @param entryPoint entry point for the hook to remove\n   * @param hookFunction optional specific hook to remove\n   * @returns removed hook\n   */\n  removeHook(\n    entryPoint: BasicHookName,\n    hookFunction?: NodeHook\n  ): NodeHook | undefined;\n\n  /**\n   * Remove a DOMPurify hook at a given entryPoint\n   * (pops it from the stack of hooks if hook not specified)\n   *\n   * @param entryPoint entry point for the hook to remove\n   * @param hookFunction optional specific hook to remove\n   * @returns removed hook\n   */\n  removeHook(\n    entryPoint: ElementHookName,\n    hookFunction?: ElementHook\n  ): ElementHook | undefined;\n\n  /**\n   * Remove a DOMPurify hook at a given entryPoint\n   * (pops it from the stack of hooks if hook not specified)\n   *\n   * @param entryPoint entry point for the hook to remove\n   * @param hookFunction optional specific hook to remove\n   * @returns removed hook\n   */\n  removeHook(\n    entryPoint: DocumentFragmentHookName,\n    hookFunction?: DocumentFragmentHook\n  ): DocumentFragmentHook | undefined;\n\n  /**\n   * Remove a DOMPurify hook at a given entryPoint\n   * (pops it from the stack of hooks if hook not specified)\n   *\n   * @param entryPoint entry point for the hook to remove\n   * @param hookFunction optional specific hook to remove\n   * @returns removed hook\n   */\n  removeHook(\n    entryPoint: 'uponSanitizeElement',\n    hookFunction?: UponSanitizeElementHook\n  ): UponSanitizeElementHook | undefined;\n\n  /**\n   * Remove a DOMPurify hook at a given entryPoint\n   * (pops it from the stack of hooks if hook not specified)\n   *\n   * @param entryPoint entry point for the hook to remove\n   * @param hookFunction optional specific hook to remove\n   * @returns removed hook\n   */\n  removeHook(\n    entryPoint: 'uponSanitizeAttribute',\n    hookFunction?: UponSanitizeAttributeHook\n  ): UponSanitizeAttributeHook | undefined;\n\n  /**\n   * Removes all DOMPurify hooks at a given entryPoint\n   *\n   * @param entryPoint entry point for the hooks to remove\n   */\n  removeHooks(entryPoint: HookName): void;\n\n  /**\n   * Removes all DOMPurify hooks.\n   */\n  removeAllHooks(): void;\n}\n\n/**\n * An element removed by DOMPurify.\n */\nexport interface RemovedElement {\n  /**\n   * The element that was removed.\n   */\n  element: Node;\n}\n\n/**\n * An element removed by DOMPurify.\n */\nexport interface RemovedAttribute {\n  /**\n   * The attribute that was removed.\n   */\n  attribute: Attr | null;\n\n  /**\n   * The element that the attribute was removed.\n   */\n  from: Node;\n}\n\ntype BasicHookName =\n  | 'beforeSanitizeElements'\n  | 'afterSanitizeElements'\n  | 'uponSanitizeShadowNode';\ntype ElementHookName = 'beforeSanitizeAttributes' | 'afterSanitizeAttributes';\ntype DocumentFragmentHookName =\n  | 'beforeSanitizeShadowDOM'\n  | 'afterSanitizeShadowDOM';\ntype UponSanitizeElementHookName = 'uponSanitizeElement';\ntype UponSanitizeAttributeHookName = 'uponSanitizeAttribute';\n\ninterface HooksMap {\n  beforeSanitizeElements: NodeHook[];\n  afterSanitizeElements: NodeHook[];\n  beforeSanitizeShadowDOM: DocumentFragmentHook[];\n  uponSanitizeShadowNode: NodeHook[];\n  afterSanitizeShadowDOM: DocumentFragmentHook[];\n  beforeSanitizeAttributes: ElementHook[];\n  afterSanitizeAttributes: ElementHook[];\n  uponSanitizeElement: UponSanitizeElementHook[];\n  uponSanitizeAttribute: UponSanitizeAttributeHook[];\n}\n\ntype ArrayElement<T> = T extends Array<infer U> ? U : never;\n\ntype HookFunction = ArrayElement<HooksMap[keyof HooksMap]>;\n\nexport type HookName =\n  | BasicHookName\n  | ElementHookName\n  | DocumentFragmentHookName\n  | UponSanitizeElementHookName\n  | UponSanitizeAttributeHookName;\n\nexport type NodeHook = (\n  this: DOMPurify,\n  currentNode: Node,\n  hookEvent: null,\n  config: Config\n) => void;\n\nexport type ElementHook = (\n  this: DOMPurify,\n  currentNode: Element,\n  hookEvent: null,\n  config: Config\n) => void;\n\nexport type DocumentFragmentHook = (\n  this: DOMPurify,\n  currentNode: DocumentFragment,\n  hookEvent: null,\n  config: Config\n) => void;\n\nexport type UponSanitizeElementHook = (\n  this: DOMPurify,\n  currentNode: Node,\n  hookEvent: UponSanitizeElementHookEvent,\n  config: Config\n) => void;\n\nexport type UponSanitizeAttributeHook = (\n  this: DOMPurify,\n  currentNode: Element,\n  hookEvent: UponSanitizeAttributeHookEvent,\n  config: Config\n) => void;\n\nexport interface UponSanitizeElementHookEvent {\n  tagName: string;\n  allowedTags: Record<string, boolean>;\n}\n\nexport interface UponSanitizeAttributeHookEvent {\n  attrName: string;\n  attrValue: string;\n  keepAttr: boolean;\n  allowedAttributes: Record<string, boolean>;\n  forceKeepAttr: boolean | undefined;\n}\n\n/**\n * A `Window`-like object containing the properties and types that DOMPurify requires.\n */\nexport type WindowLike = Pick<\n  typeof globalThis,\n  | 'DocumentFragment'\n  | 'HTMLTemplateElement'\n  | 'Node'\n  | 'Element'\n  | 'NodeFilter'\n  | 'NamedNodeMap'\n  | 'HTMLFormElement'\n  | 'DOMParser'\n> & {\n  document?: Document;\n  MozNamedAttrMap?: typeof window.NamedNodeMap;\n} & Pick<TrustedTypesWindow, 'trustedTypes'>;\n","import createDOMPurify from \"dompurify\";\n\n/**\n * Sanitize HTML using DOMPurify.\n *\n * Works in browser and in jsdom (tests) by accepting either a `Window`\n * or a `Document` (from which `defaultView` is used).\n */\nexport function sanitizeHtml(\n  html: string,\n  ctx?: Window | Document | null,\n): string {\n  if (!html) return \"\";\n  // Try to get a Window reference\n  let win: Window | null = null;\n  if (ctx && (ctx as Document).defaultView) {\n    win = (ctx as Document).defaultView as Window;\n  } else if (ctx && (ctx as Window).document) {\n    win = ctx as Window;\n  } else if (typeof window !== \"undefined\") {\n    win = window as Window;\n  }\n\n  // If we have a window, use DOMPurify\n  if (win) {\n    try {\n      const DOMPurify = createDOMPurify(win as any);\n      // Preserve element ids and data-* attributes so restoring snapshots\n      // during undo/redo does not break page scripts or CSS that rely on\n      // those attributes. Still strip <script> and all inline event\n      // handlers (on*) to avoid executing arbitrary script.\n      // Use ADD_ATTR to allow `id`, and a hook to preserve any `data-` attrs.\n      try {\n        DOMPurify.addHook(\"uponSanitizeAttribute\", (node: any, data: any) => {\n          try {\n            if (data && data.attrName && data.attrName.startsWith(\"data-\")) {\n              // Keep data-* attributes\n              (data as any).keepAttr = true;\n            }\n          } catch (e) {\n            /* ignore hook errors */\n          }\n        });\n      } catch (e) {\n        /* addHook may not be available in some environments; ignore */\n      }\n\n      return DOMPurify.sanitize(html, {\n        // Use sensible defaults: allow common formatting tags but strip scripts\n        ALLOWED_TAGS: [\n          \"a\",\n          \"b\",\n          \"i\",\n          \"em\",\n          \"strong\",\n          \"u\",\n          \"p\",\n          \"div\",\n          \"span\",\n          // Common semantic elements: preserve document structure so undo/redo\n          // does not flatten header/section/nav into plain content.\n          \"header\",\n          \"nav\",\n          \"section\",\n          \"main\",\n          \"footer\",\n          \"article\",\n          \"aside\",\n          \"figure\",\n          \"figcaption\",\n          \"time\",\n          // Interactive / form elements that may appear in content\n          \"button\",\n          \"input\",\n          \"label\",\n          \"select\",\n          \"option\",\n          \"textarea\",\n          \"details\",\n          \"summary\",\n          // Allow <style> tags so user/content-provided CSS is preserved\n          // when taking snapshots and during undo/redo operations.\n          // DOMPurify will still sanitize the contents of style blocks.\n          \"style\",\n          // Preserve linked stylesheets so page/editor styling isn't lost\n          \"link\",\n          \"ul\",\n          \"ol\",\n          \"li\",\n          \"br\",\n          \"hr\",\n          \"blockquote\",\n          \"pre\",\n          \"code\",\n          \"h1\",\n          \"h2\",\n          \"h3\",\n          \"h4\",\n          \"h5\",\n          \"h6\",\n          \"img\",\n        ],\n        ALLOWED_ATTR: [\n          \"href\",\n          \"title\",\n          \"alt\",\n          \"src\",\n          \"class\",\n          \"style\",\n          // Attributes used by <link> tags\n          \"rel\",\n          \"type\",\n          \"media\",\n        ],\n        // Also allow `id` attributes so element ids survive sanitization.\n        ADD_ATTR: [\"id\"],\n      });\n    } catch (e) {\n      // If DOMPurify initialization fails, fall through to minimal stripping\n    }\n  }\n\n  // Minimal fallback: remove <script> tags and on* attributes\n  return html\n    .replace(/<script[\\s\\S]*?>[\\s\\S]*?<\\/script>/gi, \"\")\n    .replace(/on[a-z]+=\\\"[^\"]*\\\"/gi, \"\");\n}\n\nexport default sanitizeHtml;\n","import { editorEventEmitter } from \"./events\";\nimport {\n  DEFAULT_MAX_STACK,\n  TOOLBAR_ID,\n  STYLE_ID,\n  CLASS_EDITABLE,\n  CLASS_ACTIVE,\n} from \"./constants\";\nimport { sanitizeHtml } from \"../utils/sanitize\";\n\nlet _doc: Document | null = null;\nlet _undoStack: string[] = [];\nlet _redoStack: string[] = [];\nlet _currentEditable: HTMLElement | null = null;\nlet _savedRange: Range | null = null;\nlet _maxStackSize = DEFAULT_MAX_STACK;\n\nexport function _setDoc(doc: Document | null) {\n  _doc = doc;\n}\nexport function _getDoc() {\n  return _doc;\n}\nexport function _setUndoStack(stack: string[]) {\n  _undoStack = stack;\n  editorEventEmitter.emit({\n    type: \"undoStateChanged\",\n    timestamp: Date.now(),\n    data: { canUndo: _undoStack.length > 1 },\n  });\n}\nexport function _getUndoStack() {\n  return _undoStack;\n}\nexport function _setRedoStack(stack: string[]) {\n  _redoStack = stack;\n  editorEventEmitter.emit({\n    type: \"redoStateChanged\",\n    timestamp: Date.now(),\n    data: { canRedo: _redoStack.length > 0 },\n  });\n}\nexport function _getRedoStack() {\n  return _redoStack;\n}\nexport function _setCurrentEditable(el: HTMLElement | null) {\n  _currentEditable = el;\n  editorEventEmitter.emit({\n    type: \"selectionChanged\",\n    timestamp: Date.now(),\n    data: { element: el?.tagName },\n  });\n}\nexport function _getCurrentEditable() {\n  return _currentEditable;\n}\n\n// Selection save/restore helpers used by toolbar interactions\nexport function _saveSelection() {\n  try {\n    if (!_doc) return;\n    const sel = _doc.getSelection();\n    if (!sel) return;\n    if (!sel.rangeCount) return;\n    _savedRange = sel.getRangeAt(0).cloneRange();\n  } catch (e) {\n    /* ignore */\n  }\n}\n\nexport function _restoreSelection() {\n  try {\n    if (!_doc) return;\n    const sel = _doc.getSelection();\n    if (!sel) return;\n    if (_savedRange) {\n      sel.removeAllRanges();\n      sel.addRange(_savedRange);\n      _savedRange = null;\n    }\n  } catch (e) {\n    /* ignore */\n  }\n}\nexport function pushStandaloneSnapshot(clearRedo = true) {\n  if (!_doc) return;\n  // Clone the documentElement and remove injected UI (toolbar/style)\n  // so snapshots capture only the user's content.\n  const clone = _doc.documentElement.cloneNode(true) as HTMLElement;\n  const toolbarNode = clone.querySelector(`#${TOOLBAR_ID}`);\n  if (toolbarNode && toolbarNode.parentNode)\n    toolbarNode.parentNode.removeChild(toolbarNode);\n  const styleNode = clone.querySelector(`#${STYLE_ID}`);\n  if (styleNode && styleNode.parentNode)\n    styleNode.parentNode.removeChild(styleNode);\n  // Remove editor-specific attributes/classes so snapshots don't persist\n  // transient editing state (contenteditable, toolbar classes, tabindex).\n  try {\n    const editableNodes = clone.querySelectorAll(\n      \"[contenteditable], .\" + CLASS_EDITABLE + \", .\" + CLASS_ACTIVE,\n    );\n    editableNodes.forEach((el) => {\n      try {\n        if (el instanceof Element) {\n          if (el.hasAttribute(\"contenteditable\"))\n            el.removeAttribute(\"contenteditable\");\n          if (el.hasAttribute(\"tabindex\")) el.removeAttribute(\"tabindex\");\n          el.classList.remove(CLASS_EDITABLE, CLASS_ACTIVE);\n        }\n      } catch (e) {\n        /* ignore */\n      }\n    });\n  } catch (e) {\n    /* ignore */\n  }\n  // Preserve scripts by replacing them with a harmless placeholder\n  // that contains the encoded script source/attributes. This allows the\n  // sanitizer to run (which strips <script> tags) while keeping the\n  // script content available to re-insert and execute on restore.\n  try {\n    const scripts = Array.from(\n      clone.querySelectorAll<HTMLScriptElement>(\"script\"),\n    );\n    scripts.forEach((s) => {\n      try {\n        const code = s.textContent || \"\";\n        const attrs: Record<string, string> = {};\n        Array.from(s.attributes).forEach((a) => (attrs[a.name] = a.value));\n        const placeholder = clone.ownerDocument!.createElement(\"span\");\n        // encode script body in base64 to survive sanitization\n        try {\n          // btoa may throw on Unicode; encodeURIComponent first\n          const safe =\n            typeof btoa !== \"undefined\"\n              ? btoa(unescape(encodeURIComponent(code)))\n              : encodeURIComponent(code);\n          placeholder.setAttribute(\"data-rhe-script\", safe);\n        } catch (e) {\n          placeholder.setAttribute(\"data-rhe-script\", encodeURIComponent(code));\n        }\n        if (Object.keys(attrs).length) {\n          placeholder.setAttribute(\n            \"data-rhe-script-attrs\",\n            encodeURIComponent(JSON.stringify(attrs)),\n          );\n        }\n        // mark parent editable region if present so we can reinsert in-place\n        const parentMarker = s.closest(\"[data-rhe-id]\") as HTMLElement | null;\n        if (parentMarker && parentMarker.getAttribute(\"data-rhe-id\")) {\n          placeholder.setAttribute(\n            \"data-rhe-script-parent\",\n            parentMarker.getAttribute(\"data-rhe-id\")!,\n          );\n        } else {\n          placeholder.setAttribute(\"data-rhe-script-parent\", \"head\");\n        }\n        s.parentNode?.replaceChild(placeholder, s);\n      } catch (e) {\n        /* ignore per-script errors */\n      }\n    });\n  } catch (e) {\n    /* ignore script extraction errors */\n  }\n  const snapRaw = clone.outerHTML;\n  const snap = sanitizeHtml(snapRaw, _doc);\n  if (!_undoStack.length || _undoStack[_undoStack.length - 1] !== snap) {\n    _undoStack.push(snap);\n    if (_undoStack.length > _maxStackSize) _undoStack.shift();\n    editorEventEmitter.emit({\n      type: \"contentChanged\",\n      timestamp: Date.now(),\n      data: { htmlLength: snap.length },\n    });\n  }\n  if (clearRedo) {\n    _redoStack = [];\n    editorEventEmitter.emit({\n      type: \"redoStateChanged\",\n      timestamp: Date.now(),\n      data: { canRedo: false },\n    });\n  }\n}\nexport function setMaxStackSize(size: number) {\n  _maxStackSize = Math.max(1, size);\n}\n","// Public API\n\n// Class-based editor (browser + framework usage)\nexport { default as RichHtmlEditor } from \"./RichHtmlEditor\";\n\n// Functional API (advanced usage)\nexport { initRichEditor, getCleanHTML } from \"./core/editor\";\n\n// Types\nexport type {\n  FormatState,\n  ToolbarOptions,\n  EditorEvent,\n  EditorEventType,\n  EditorEventHandler,\n  FormattingCommand,\n  TextAlignment,\n  FontSizeMap,\n  EditorConfig,\n} from \"./core/types\";\n\n// Event system\nexport { editorEventEmitter, getEditorEventEmitter } from \"./core/events\";\nexport type { EditorEventEmitter } from \"./core/events\";\n","import {\n  _setDoc,\n  _getDoc,\n  _setUndoStack,\n  _getUndoStack,\n  _setRedoStack,\n  _getRedoStack,\n  _setCurrentEditable,\n  _getCurrentEditable,\n  pushStandaloneSnapshot,\n} from \"./state\";\nimport { injectStyles } from \"../dom/styles\";\nimport { injectToolbar } from \"../toolbar/toolbar\";\nimport { attachStandaloneHandlers } from \"../dom/handlers\";\nimport { computeFormatState, getElementLabel } from \"../dom/format\";\nimport { handleUndo, handleRedo, handleToolbarCommand } from \"./commands\";\nimport type { EditorConfig } from \"./types\";\nimport { sanitizeHtml } from \"../utils/sanitize\";\nimport {\n  TOOLBAR_ID,\n  STYLE_ID,\n  CLASS_EDITABLE,\n  CLASS_ACTIVE,\n} from \"./constants\";\n\n/**\n * Initialize the rich HTML editor on an iframe element\n */\nexport function initRichEditor(\n  iframe: HTMLIFrameElement,\n  config?: EditorConfig,\n) {\n  try {\n    if (!iframe || !(iframe instanceof HTMLIFrameElement)) {\n      throw new Error(\"Invalid iframe element provided to initRichEditor\");\n    }\n\n    const doc = iframe.contentDocument;\n    if (!doc) {\n      throw new Error(\n        \"Unable to access iframe contentDocument. Ensure iframe src is same-origin.\",\n      );\n    }\n\n    _setDoc(doc);\n    injectStyles(doc);\n    _setUndoStack([]);\n    _setRedoStack([]);\n    _setCurrentEditable(null);\n    if (config?.maxStackSize) {\n      import(\"./state\")\n        .then((m) => m.setMaxStackSize(config.maxStackSize!))\n        .catch(() => {\n          /* ignore */\n        });\n    }\n    attachStandaloneHandlers(doc);\n    pushStandaloneSnapshot();\n    injectToolbar(doc, {\n      onCommand: handleToolbarCommand,\n      canUndo: () => _getUndoStack().length > 1,\n      canRedo: () => _getRedoStack().length > 0,\n      onUndo: handleUndo,\n      onRedo: handleRedo,\n      getFormatState: () => computeFormatState(doc),\n      getSelectedElementInfo: () => getElementLabel(_getCurrentEditable()),\n    });\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Failed to initialize editor:\", message);\n    throw error;\n  }\n}\n\nexport function getCleanHTML(): string {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] getCleanHTML called before editor initialization\",\n      );\n      return \"\";\n    }\n    if (!doc.documentElement) {\n      throw new Error(\"Document is missing documentElement\");\n    }\n\n    const clone = doc.documentElement.cloneNode(true) as HTMLElement;\n\n    // Remove injected toolbar and style elements if present\n    const toolbarNode = clone.querySelector(`#${TOOLBAR_ID}`);\n    if (toolbarNode && toolbarNode.parentNode)\n      toolbarNode.parentNode.removeChild(toolbarNode);\n    const styleNode = clone.querySelector(`#${STYLE_ID}`);\n    if (styleNode && styleNode.parentNode)\n      styleNode.parentNode.removeChild(styleNode);\n\n    // Recursively clean root and descendants\n    try {\n      const cleanElement = (el: Element) => {\n        try {\n          // remove boolean/content attributes explicitly\n          if (el.hasAttribute(\"contenteditable\"))\n            el.removeAttribute(\"contenteditable\");\n          if (el.hasAttribute(\"tabindex\")) el.removeAttribute(\"tabindex\");\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          const attrs = Array.from(el.attributes || []);\n          attrs.forEach((a) => {\n            const rawName = a.name;\n            const name = rawName.toLowerCase();\n\n            // remove inline event handlers\n            if (name.startsWith(\"on\")) {\n              try {\n                el.removeAttribute(rawName);\n              } catch (e) {\n                /* ignore */\n              }\n              return;\n            }\n\n            // remove any data-rhe-* attributes (including data-rhe-id)\n            if (\n              name === \"data-rhe-id\" ||\n              name.startsWith(\"data-rhe-\") ||\n              name === \"data-rhe\"\n            ) {\n              try {\n                el.removeAttribute(rawName);\n              } catch (e) {\n                /* ignore */\n              }\n              return;\n            }\n          });\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          if (el.id) {\n            const id = el.id;\n            if (\n              id === TOOLBAR_ID ||\n              id === STYLE_ID ||\n              id.startsWith(\"editor-\") ||\n              id.startsWith(\"rhe-\")\n            ) {\n              el.removeAttribute(\"id\");\n            }\n          }\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          const cls = Array.from(el.classList || []);\n          cls.forEach((c) => {\n            if (\n              c === CLASS_EDITABLE ||\n              c === CLASS_ACTIVE ||\n              c.startsWith(\"editor-\") ||\n              c.startsWith(\"rhe-\")\n            ) {\n              try {\n                el.classList.remove(c);\n              } catch (e) {\n                /* ignore */\n              }\n            }\n          });\n\n          // remove empty class attributes left behind\n          if (\n            el.hasAttribute(\"class\") &&\n            (el.getAttribute(\"class\") || \"\").trim() === \"\"\n          ) {\n            try {\n              el.removeAttribute(\"class\");\n            } catch (e) {\n              /* ignore */\n            }\n          }\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          const children = Array.from(el.children || []);\n          children.forEach((child) => cleanElement(child as Element));\n        } catch (e) {\n          /* ignore */\n        }\n      };\n\n      // `instanceof Element` can fail across window/iframe boundaries\n      // because each iframe has its own global `Element` constructor.\n      // Use a cross-realm-safe check instead.\n      if ((clone as Node).nodeType === Node.ELEMENT_NODE) {\n        cleanElement(clone as Element);\n      }\n    } catch (e) {\n      /* ignore traversal errors */\n    }\n\n    // Preserve original scripts intentionally.\n    return \"<!doctype html>\\n\" + clone.outerHTML;\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Failed to get clean HTML:\", message);\n    throw error;\n  }\n}\n\nexport function getSanitizedHTML(): string {\n  try {\n    const doc = _getDoc();\n    if (!doc) return \"\";\n    if (!doc.documentElement)\n      throw new Error(\"Document is missing documentElement\");\n    const raw = \"<!doctype html>\\n\" + doc.documentElement.outerHTML;\n    return sanitizeHtml(raw, doc);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Failed to get sanitized HTML:\", message);\n    throw error;\n  }\n}\n","/**\n * Inject CSS styles into the document for editor UI\n *\n * Adds styling for:\n * - `.editor-editable-element`: Dashed outline for hoverable elements\n * - `.editor-active-element`: Solid green outline for active editing element\n *\n * Uses a style ID to prevent duplicate injections\n *\n * @param doc - Document to inject styles into\n */\nimport {\n  STYLE_ID,\n  CLASS_EDITABLE,\n  CLASS_ACTIVE,\n  HOVER_OUTLINE,\n  ACTIVE_OUTLINE,\n  TOOLBAR_ID,\n  TOOLBAR_BG,\n  TOOLBAR_BORDER,\n  BUTTON_BORDER,\n  BUTTON_ACTIVE_BG,\n  BUTTON_BG,\n  BUTTON_COLOR,\n  INFO_COLOR,\n} from \"../core/constants\";\n\nexport function injectStyles(doc: Document): void {\n  const styleId = STYLE_ID;\n  let styleEl = doc.getElementById(styleId) as HTMLStyleElement | null;\n  const css = `\n/* Scoped conservative reset for editor UI root to prevent template styles leaking in */\n#rhe-editor-root {\n  box-sizing: border-box;\n  font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n  font-size: 14px;\n  line-height: 1.5;\n  color: #0f172a;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n#rhe-editor-root *,\n#rhe-editor-root *::before,\n#rhe-editor-root *::after {\n  box-sizing: inherit;\n}\n/* Restore user-agent defaults for native controls inside the root */\n#rhe-editor-root button,\n#rhe-editor-root input,\n#rhe-editor-root textarea,\n#rhe-editor-root select {\n  all: revert;\n  font: inherit;\n  color: inherit;\n  background: transparent;\n  border: none;\n  padding: 0;\n  margin: 0;\n}\n/* Basic focus visibility for accessibility inside root */\n#rhe-editor-root :focus {\n  outline: 2px solid Highlight;\n  outline-offset: 2px;\n}\n\n.${CLASS_EDITABLE}{outline:2px dashed ${HOVER_OUTLINE};cursor:text}\n.${CLASS_ACTIVE}{outline:2px solid ${ACTIVE_OUTLINE};cursor:text}\n#${TOOLBAR_ID} img{cursor:auto}\n/* Make images inside editable regions show a pointer to indicate click/edit */\n.${CLASS_EDITABLE} img, .${CLASS_ACTIVE} img { cursor: pointer; }\n#${TOOLBAR_ID}{\n  position: sticky;\n  top: 0;\n  left: 0;\n  right: 0;\n  z-index: 9999;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 8px 12px;\n  background: ${TOOLBAR_BG};\n  border-bottom: 1px solid ${TOOLBAR_BORDER};\n  font-family: inherit;\n  box-shadow: 0 6px 18px rgba(2,6,23,0.08);\n  backdrop-filter: blur(6px);\n  /* Allow toolbar items to wrap onto multiple lines on narrow screens */\n  flex-wrap: wrap;\n  justify-content: flex-start;\n}\n#${TOOLBAR_ID} button{\n  padding: 6px 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: ${BUTTON_BG};\n  color: ${BUTTON_COLOR};\n  border-radius: 8px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;\n  outline: none;\n  margin-right: 2px;\n}\n#${TOOLBAR_ID} button[aria-pressed=\"true\"]{\n  background: ${BUTTON_ACTIVE_BG};\n  font-weight: 600;\n  box-shadow: 0 6px 12px rgba(99,102,241,0.12);\n}\n#${TOOLBAR_ID} button:hover:not(:disabled){\n  transform: translateY(-2px);\n  box-shadow: 0 8px 20px rgba(2,6,23,0.08);\n}\n#${TOOLBAR_ID} select{\n  padding: 6px 8px;\n  border-radius: 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: #fff;\n  font-family: inherit;\n}\n#${TOOLBAR_ID} input[type=\"color\"]{\n  border-radius: 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: #fff;\n  font-family: inherit;\n}\n#${TOOLBAR_ID} .color-input-label{\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  padding: 0;\n  background: transparent;\n  border: none;\n}\n\n/* Labeled color inputs (e.g. \"Text Color <input type=color>\") */\n#${TOOLBAR_ID} .color-label{\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  padding: 0;\n  background: transparent;\n  border: none;\n}\n#${TOOLBAR_ID} .color-input-label .color-icon{\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n}\n#${TOOLBAR_ID} .text-color-icon{\n  font-weight: 700;\n  font-size: 14px;\n  line-height: 1;\n  display: inline-block;\n  padding-bottom: 2px;\n  border-bottom: 3px solid currentColor;\n  transform-origin: center;\n}\n#${TOOLBAR_ID} .highlight-icon{\n  width: 16px;\n  height: 16px;\n  display: inline-block;\n}\n#${TOOLBAR_ID} .color-icon svg{\n  width: 16px;\n  height: 16px;\n  display: block;\n}\n/* Text color wrapper: A with a small swatch on the right */\n#${TOOLBAR_ID} .text-color-wrapper{\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n}\n#${TOOLBAR_ID} .text-color-wrapper .text-A{\n  font-weight: 700;\n  font-size: 14px;\n  line-height: 1;\n}\n#${TOOLBAR_ID} .text-color-wrapper .color-swatch{\n  width: 12px;\n  height: 12px;\n  border-radius: 3px;\n  border: 1px solid rgba(0,0,0,0.12);\n  box-shadow: 0 1px 0 rgba(255,255,255,0.5) inset;\n  background: currentColor;\n}\n\n/* Highlight wrapper: small colored bar under/behind the A to mimic highlighter */\n#${TOOLBAR_ID} .highlight-wrapper{\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n  position: relative;\n}\n#${TOOLBAR_ID} .highlight-wrapper .highlight-bar{\n  position: absolute;\n  left: 0;\n  right: 0;\n  bottom: 2px;\n  height: 8px;\n  border-radius: 3px;\n  background: #ffeb3b; /* default yellow */\n  z-index: 0;\n}\n#${TOOLBAR_ID} .highlight-wrapper .text-A{\n  position: relative;\n  z-index: 1;\n  font-weight: 700;\n  font-size: 14px;\n  line-height: 1;\n  padding: 0 4px;\n}\n#${TOOLBAR_ID} span{\n  color: ${INFO_COLOR};\n  font-size: 90%;\n}\n\n/* Grouping and separators */\n#${TOOLBAR_ID} .toolbar-group{\n  display: flex;\n  align-items: center;\n  gap: 6px;\n}\n#${TOOLBAR_ID} .toolbar-group{\n  /* groups may wrap internally to avoid overflow on narrow screens */\n  flex-wrap: wrap;\n}\n/* Overflow button + menu styling */\n#${TOOLBAR_ID} .toolbar-overflow-btn{\n  display: none;\n  align-items: center;\n  justify-content: center;\n  padding: 6px 8px;\n  border-radius: 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: ${BUTTON_BG};\n  color: ${BUTTON_COLOR};\n  font-weight: 600;\n}\n#${TOOLBAR_ID} .toolbar-overflow-menu{\n  position: absolute;\n  top: calc(100% + 6px);\n  right: 12px;\n  min-width: 160px;\n  background: #fff;\n  border: 1px solid rgba(15,23,42,0.06);\n  border-radius: 8px;\n  padding: 8px;\n  box-shadow: 0 12px 40px rgba(2,6,23,0.12);\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n  z-index: 10000;\n}\n#${TOOLBAR_ID} .toolbar-overflow-menu[hidden]{\n  display: none;\n}\n#${TOOLBAR_ID} .toolbar-sep{\n  width: 1px;\n  height: 28px;\n  background: rgba(15,23,42,0.06);\n  margin: 0 8px;\n  border-radius: 1px;\n}\n#${TOOLBAR_ID} .toolbar-spacer{\n  flex: 1 1 auto;\n}\n#${TOOLBAR_ID} button svg{\n  width: 16px;\n  height: 16px;\n  display: block;\n  /* Default icon appearance */\n  fill: none;\n}\n\n/* Active/pressed: switch to filled appearance */\n#${TOOLBAR_ID} button[aria-pressed=\"true\"] svg{\n  fill: currentColor;\n}\n\n/* Focus and accessibility */\n#${TOOLBAR_ID} button:focus{\n  outline: none;\n  box-shadow: 0 0 0 4px rgba(99,102,241,0.12);\n}\n\n/* Disabled state */\n#${TOOLBAR_ID} button:disabled{\n  opacity: 0.48;\n  cursor: not-allowed;\n}\n/* Responsive tweaks: reduce spacing and allow horizontal scroll on very small screens */\n@media (max-width: 720px){\n  #${TOOLBAR_ID}{\n    padding: 6px 8px;\n    gap: 6px;\n  }\n  #${TOOLBAR_ID} button,\n  #${TOOLBAR_ID} select,\n  #${TOOLBAR_ID} input[type=\"color\"]{\n    padding: 4px 6px;\n    border-radius: 6px;\n  }\n  /* Hide visual separators to save horizontal space */\n  #${TOOLBAR_ID} .toolbar-sep{\n    display: none;\n  }\n  /* Collapse labeled color text visually but preserve accessibility on the input */\n  #${TOOLBAR_ID} .color-label{\n    font-size: 0;\n  }\n  #${TOOLBAR_ID} .color-label input{\n    font-size: initial;\n  }\n}\n@media (max-width: 420px){\n  /* On very small screens prefer a single-line scrollable toolbar */\n  #${TOOLBAR_ID}{\n    flex-wrap: nowrap;\n    overflow-x: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n  #${TOOLBAR_ID} .toolbar-group{\n    flex: 0 0 auto;\n  }\n  #${TOOLBAR_ID} button{ margin-right: 6px; }\n  /* Show overflow button and hide the groups marked for collapse */\n  #${TOOLBAR_ID} .toolbar-overflow-btn{\n    display: inline-flex;\n  }\n  #${TOOLBAR_ID} .collapse-on-small{\n    display: none;\n  }\n}\n/* Image editor modal */\n.rhe-img-modal-overlay{\n  position: fixed;\n  inset: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(2,6,23,0.48);\n  z-index: 11000;\n}\n.rhe-img-modal{\n  background: #fff;\n  border-radius: 12px;\n  padding: 16px;\n  width: 360px;\n  max-width: calc(100% - 24px);\n  box-shadow: 0 24px 60px rgba(2,6,23,0.28);\n  font-family: inherit;\n}\n.rhe-img-modal h3{ margin: 0 0 8px 0; font-size: 16px }\n.rhe-img-tabs{ display: flex; gap: 8px; margin-bottom: 12px }\n.rhe-img-tabs button{ padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(15,23,42,0.06); background: #fff }\n.rhe-img-tabs button.active{ background: #f3f4ff }\n.rhe-img-pane{ margin-bottom: 12px }\n.rhe-img-pane input[type=\"file\"], .rhe-img-pane input[type=\"url\"]{ width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(15,23,42,0.06) }\n.rhe-img-msg{ color: #b91c1c; font-size: 13px; min-height: 18px; margin-top: 8px }\n.rhe-img-actions{ display:flex; gap:8px; justify-content:flex-end }\n.rhe-img-actions button{ padding: 8px 12px; border-radius: 8px }\n.rhe-img-actions button.primary{ background: #6366f1; color: #fff; border: none }\n\n`;\n  if (!styleEl) {\n    styleEl = doc.createElement(\"style\");\n    styleEl.id = styleId;\n    doc.head.appendChild(styleEl);\n  }\n  styleEl.textContent = css;\n}\n","/**\n * Inject and render the formatting toolbar into the document\n *\n * Creates a sticky toolbar with:\n * - Text formatting buttons (Bold, Italic, Underline)\n * - Font and size selectors\n * - Undo/Redo buttons\n * - Link insertion button\n * - Color pickers (text and highlight)\n * - Text alignment buttons\n * - Selected element info display\n *\n * The toolbar is re-injected on every selection change to update state\n * (this is optimized for small toolbar size and few state changes)\n *\n * @param doc - Document to inject toolbar into\n * @param options - Toolbar configuration and callbacks\n */\nimport {\n  TOOLBAR_ID,\n  LABEL_BOLD,\n  LABEL_ITALIC,\n  LABEL_UNDERLINE,\n  LABEL_STRIKETHROUGH,\n  LABEL_CLEAR_FORMAT,\n  LABEL_UNORDERED_LIST,\n  LABEL_ORDERED_LIST,\n  LABEL_UNDO,\n  LABEL_REDO,\n  LABEL_LINK,\n  LABEL_ALIGN_LEFT,\n  LABEL_ALIGN_CENTER,\n  LABEL_ALIGN_RIGHT,\n  FONT_OPTIONS,\n  SIZE_OPTIONS,\n  FORMAT_OPTIONS,\n} from \"../core/constants\";\nimport { getEditorRoot } from \"../dom/root\";\nimport { makeColorInput } from \"./color\";\nimport { setupOverflow } from \"./overflow\";\nimport {\n  makeButton as _makeButton,\n  makeGroup as _makeGroup,\n  makeSep as _makeSep,\n} from \"./buttons\";\nimport { makeSelect as _makeSelect } from \"./selects\";\nimport { setupNavigation } from \"./navigation\";\n\nexport function injectToolbar(\n  doc: Document,\n  options: {\n    onCommand: (command: string, value?: string) => void;\n    canUndo: () => boolean;\n    canRedo: () => boolean;\n    onUndo: () => void;\n    onRedo: () => void;\n    getFormatState: () => {\n      bold: boolean;\n      italic: boolean;\n      underline: boolean;\n      foreColor?: string | null;\n      hiliteColor?: string | null;\n      fontName?: string | null;\n      fontSize?: string | null;\n      formatBlock?: string | null;\n    };\n    getSelectedElementInfo: () => string | null;\n  },\n) {\n  const existing = doc.getElementById(TOOLBAR_ID);\n  if (existing) existing.remove();\n\n  const toolbar = doc.createElement(\"div\");\n  toolbar.id = TOOLBAR_ID;\n  // Accessibility: expose as a toolbar region and provide a readable label\n  toolbar.setAttribute(\"role\", \"toolbar\");\n  toolbar.setAttribute(\"aria-label\", \"Rich text editor toolbar\");\n\n  // Styling moved to injected stylesheet (see src/dom/styles.ts)\n\n  const makeButton = (\n    label: string,\n    title: string,\n    command: string,\n    value?: string,\n    isActive?: boolean,\n    disabled?: boolean,\n  ) =>\n    _makeButton(\n      doc,\n      { onCommand: options.onCommand },\n      label,\n      title,\n      command,\n      value,\n      isActive,\n      disabled,\n    );\n\n  const makeSelect = (\n    title: string,\n    command: string,\n    optionsList: { label: string; value: string }[],\n    initialValue?: string | null,\n  ) =>\n    _makeSelect(\n      doc,\n      { onCommand: options.onCommand },\n      title,\n      command,\n      optionsList,\n      initialValue,\n    );\n\n  // Color input helper moved to ./color.ts\n\n  const format = options.getFormatState();\n  // Helpers: group wrapper and separator element\n  const makeGroup = () => _makeGroup(doc);\n  const makeSep = () => _makeSep(doc);\n\n  // Section 1: Undo / Redo\n  const undoBtn = makeButton(\n    LABEL_UNDO,\n    \"Undo\",\n    \"undo\",\n    undefined,\n    false,\n    !options.canUndo(),\n  );\n  // Undo/Redo are handled by the history module â€” call handlers directly\n  undoBtn.onclick = () => options.onUndo();\n\n  const redoBtn = makeButton(\n    LABEL_REDO,\n    \"Redo\",\n    \"redo\",\n    undefined,\n    false,\n    !options.canRedo(),\n  );\n  redoBtn.onclick = () => options.onRedo();\n\n  const grp1 = makeGroup();\n  grp1.appendChild(undoBtn);\n  grp1.appendChild(redoBtn);\n  toolbar.appendChild(grp1);\n  toolbar.appendChild(makeSep());\n\n  // Section 2: Format, Font & Size\n  const grp2 = makeGroup();\n  grp2.className = \"toolbar-group collapse-on-small\";\n  grp2.appendChild(\n    makeSelect(\n      \"Format\",\n      \"formatBlock\",\n      FORMAT_OPTIONS,\n      (format as any).formatBlock,\n    ),\n  );\n  grp2.appendChild(\n    makeSelect(\"Font\", \"fontName\", FONT_OPTIONS, (format as any).fontName),\n  );\n  grp2.appendChild(\n    makeSelect(\"Size\", \"fontSize\", SIZE_OPTIONS, (format as any).fontSize),\n  );\n  toolbar.appendChild(grp2);\n  toolbar.appendChild(makeSep());\n\n  // Section 3: Bold, Italic, Underline, Strikethrough\n  const grp3 = makeGroup();\n  grp3.appendChild(\n    makeButton(LABEL_BOLD, \"Bold\", \"bold\", undefined, format.bold),\n  );\n  grp3.appendChild(\n    makeButton(LABEL_ITALIC, \"Italic\", \"italic\", undefined, format.italic),\n  );\n  grp3.appendChild(\n    makeButton(\n      LABEL_UNDERLINE,\n      \"Underline\",\n      \"underline\",\n      undefined,\n      format.underline,\n    ),\n  );\n  grp3.appendChild(makeButton(LABEL_STRIKETHROUGH, \"Strikethrough\", \"strike\"));\n  // Clear formatting button: removes editor-applied inline/block formatting\n  grp3.appendChild(\n    makeButton(LABEL_CLEAR_FORMAT, \"Clear formatting\", \"clearFormat\"),\n  );\n  grp3.appendChild(\n    makeButton(\n      LABEL_UNORDERED_LIST,\n      \"Unordered list\",\n      \"unorderedList\",\n      undefined,\n      (format as any).listType === \"ul\",\n    ),\n  );\n  grp3.appendChild(\n    makeButton(\n      LABEL_ORDERED_LIST,\n      \"Ordered list\",\n      \"orderedList\",\n      undefined,\n      (format as any).listType === \"ol\",\n    ),\n  );\n  toolbar.appendChild(grp3);\n  toolbar.appendChild(makeSep());\n\n  // Section 4: Alignment\n  const grp4 = makeGroup();\n  grp4.appendChild(makeButton(LABEL_ALIGN_LEFT, \"Align left\", \"align\", \"left\"));\n  grp4.appendChild(\n    makeButton(LABEL_ALIGN_CENTER, \"Align center\", \"align\", \"center\"),\n  );\n  grp4.appendChild(\n    makeButton(LABEL_ALIGN_RIGHT, \"Align right\", \"align\", \"right\"),\n  );\n  toolbar.appendChild(grp4);\n  toolbar.appendChild(makeSep());\n\n  // Section 5: Colors\n  const grp5 = makeGroup();\n  grp5.className = \"toolbar-group collapse-on-small\";\n  grp5.appendChild(\n    makeColorInput(\n      doc,\n      options,\n      \"Text color\",\n      \"foreColor\",\n      (format as any).foreColor,\n    ),\n  );\n  grp5.appendChild(\n    makeColorInput(\n      doc,\n      options,\n      \"Highlight color\",\n      \"hiliteColor\",\n      (format as any).hiliteColor,\n    ),\n  );\n  toolbar.appendChild(grp5);\n  toolbar.appendChild(makeSep());\n\n  // Section 6: Link\n  const grp6 = makeGroup();\n  grp6.className = \"toolbar-group collapse-on-small\";\n  grp6.appendChild(makeButton(LABEL_LINK, \"Insert link\", \"link\"));\n  toolbar.appendChild(grp6);\n\n  // Overflow UI extracted to ./overflow.ts â€” set up with helper functions\n  setupOverflow(doc, toolbar, options, format, {\n    makeSelect,\n    makeColorInput: (title: string, command: string, initial?: string) =>\n      makeColorInput(doc, options, title, command, initial),\n    makeButton,\n    makeGroup,\n  });\n\n  // const info = doc.createElement(\"span\");\n  // // Info styles moved to stylesheet\n  // info.textContent = options.getSelectedElementInfo()\n  //   ? `Selected: ${options.getSelectedElementInfo()}`\n  //   : \"Click any highlighted element to edit\";\n  // toolbar.appendChild(info);\n\n  // Keyboard navigation for toolbar\n  setupNavigation(toolbar);\n\n  // Mount toolbar inside the scoped editor root so template styles cannot leak in.\n  try {\n    const root = getEditorRoot(doc);\n    root.insertBefore(toolbar, root.firstChild);\n  } catch (e) {\n    // Fallback to previous behavior if root insertion fails\n    doc.body.insertBefore(toolbar, doc.body.firstChild);\n  }\n}\n","export const EDITOR_ROOT_ID = \"rhe-editor-root\";\n\n/**\n * Ensure an editor root container exists in the given document and return it.\n * If not present, create it and insert as the first child of body.\n */\nexport function getEditorRoot(doc: Document): HTMLElement {\n  let root = doc.getElementById(EDITOR_ROOT_ID) as HTMLElement | null;\n  if (root) return root;\n\n  root = doc.createElement(\"div\");\n  root.id = EDITOR_ROOT_ID;\n  // Safe defaults: allow the page to position/size the root; library CSS will scope under it\n  root.setAttribute(\"data-rhe-root\", \"true\");\n  try {\n    if (doc.body && doc.body.firstChild)\n      doc.body.insertBefore(root, doc.body.firstChild);\n    else if (doc.body) doc.body.appendChild(root);\n    else doc.documentElement.appendChild(root);\n  } catch (e) {\n    // best-effort: if insertion fails, fallback to appending to documentElement\n    try {\n      doc.documentElement.appendChild(root);\n    } catch (err) {\n      /* ignore */\n    }\n  }\n  return root;\n}\n","export function makeColorInput(\n  doc: Document,\n  options: { onCommand: (command: string, value?: string) => void },\n  title: string,\n  command: string,\n  initialColor?: string,\n) {\n  const input = doc.createElement(\"input\");\n  input.type = \"color\";\n  input.className = \"toolbar-color-input\";\n  const wrapper = doc.createElement(\"label\");\n  wrapper.className = \"color-label\";\n  wrapper.appendChild(doc.createTextNode(title + \" \"));\n  wrapper.appendChild(input);\n  let savedRange: Range | null = null;\n  input.addEventListener(\"pointerdown\", () => {\n    const s = doc.getSelection();\n    if (s && s.rangeCount) savedRange = s.getRangeAt(0).cloneRange();\n  });\n  input.onchange = (e: Event) => {\n    try {\n      const s = doc.getSelection();\n      if (savedRange && s) {\n        s.removeAllRanges();\n        s.addRange(savedRange);\n      }\n    } catch (err) {\n      /* ignore */\n    }\n    options.onCommand(command, (e.target as HTMLInputElement).value);\n    savedRange = null;\n  };\n\n  function rgbToHex(input?: string | null): string | null {\n    if (!input) return null;\n    const v = input.trim();\n    if (v.startsWith(\"#\")) {\n      if (v.length === 4) {\n        return (\"#\" + v[1] + v[1] + v[2] + v[2] + v[3] + v[3]).toLowerCase();\n      }\n      return v.toLowerCase();\n    }\n    const rgbMatch = v.match(/rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)/i);\n    if (rgbMatch) {\n      const r = Number(rgbMatch[1]);\n      const g = Number(rgbMatch[2]);\n      const b = Number(rgbMatch[3]);\n      const hex =\n        \"#\" +\n        [r, g, b]\n          .map((n) => n.toString(16).padStart(2, \"0\"))\n          .join(\"\")\n          .toLowerCase();\n      return hex;\n    }\n    return null;\n  }\n\n  const setColor = (val?: string) => {\n    if (!val) return;\n    const hex = rgbToHex(val) || val;\n    try {\n      if (\n        hex &&\n        hex.startsWith(\"#\") &&\n        (input as HTMLInputElement).value !== hex\n      ) {\n        (input as HTMLInputElement).value = hex;\n      }\n    } catch (e) {\n      /* ignore */\n    }\n  };\n\n  if (initialColor) setColor(initialColor);\n  input.addEventListener(\"input\", (e: Event) => {\n    const val = (e.target as HTMLInputElement).value;\n    setColor(val);\n  });\n  input.title = title;\n  input.setAttribute(\"aria-label\", title);\n  return wrapper;\n}\n","export function setupOverflow(\n  doc: Document,\n  toolbar: HTMLElement,\n  options: {\n    onCommand: (command: string, value?: string) => void;\n    onUndo: () => void;\n    onRedo: () => void;\n    canUndo: () => boolean;\n    canRedo: () => boolean;\n  },\n  format: any,\n  helpers: {\n    makeSelect: (\n      title: string,\n      command: string,\n      optionsList: { label: string; value: string }[],\n      initialValue?: string | null,\n    ) => HTMLElement;\n    makeColorInput: (\n      title: string,\n      command: string,\n      initialColor?: string,\n    ) => HTMLElement;\n    makeButton: (\n      label: string,\n      title: string,\n      command: string,\n      value?: string,\n      isActive?: boolean,\n      disabled?: boolean,\n    ) => HTMLElement;\n    makeGroup: () => HTMLElement;\n  },\n) {\n  const overflowBtn = doc.createElement(\"button\");\n  overflowBtn.type = \"button\";\n  overflowBtn.className = \"toolbar-overflow-btn\";\n  overflowBtn.title = \"More\";\n  overflowBtn.setAttribute(\"aria-label\", \"More toolbar actions\");\n  overflowBtn.setAttribute(\"aria-haspopup\", \"true\");\n  overflowBtn.setAttribute(\"aria-expanded\", \"false\");\n  overflowBtn.tabIndex = 0;\n  overflowBtn.innerHTML = \"â‹¯\";\n\n  const overflowMenu = doc.createElement(\"div\");\n  overflowMenu.className = \"toolbar-overflow-menu\";\n  overflowMenu.setAttribute(\"role\", \"menu\");\n  overflowMenu.hidden = true;\n\n  function openOverflow() {\n    overflowMenu.hidden = false;\n    overflowBtn.setAttribute(\"aria-expanded\", \"true\");\n    const first = overflowMenu.querySelector<HTMLElement>(\n      \"button, select, input\",\n    );\n    first?.focus();\n  }\n  function closeOverflow() {\n    overflowMenu.hidden = true;\n    overflowBtn.setAttribute(\"aria-expanded\", \"false\");\n    overflowBtn.focus();\n  }\n\n  overflowBtn.addEventListener(\"click\", () => {\n    if (overflowMenu.hidden) openOverflow();\n    else closeOverflow();\n  });\n  overflowBtn.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n    if (e.key === \"Enter\" || e.key === \" \") {\n      e.preventDefault();\n      if (overflowMenu.hidden) openOverflow();\n      else closeOverflow();\n    }\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      if (overflowMenu.hidden) openOverflow();\n    }\n  });\n\n  overflowMenu.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n    if (e.key === \"Escape\") {\n      e.preventDefault();\n      closeOverflow();\n    }\n  });\n  doc.addEventListener(\"pointerdown\", (ev: PointerEvent) => {\n    if (\n      !overflowMenu.hidden &&\n      !overflowMenu.contains(ev.target as Node) &&\n      ev.target !== overflowBtn\n    ) {\n      closeOverflow();\n    }\n  });\n\n  // Populate overflow menu with duplicates of the collapsed controls\n  overflowMenu.appendChild(\n    helpers.makeSelect(\n      \"Format\",\n      \"formatBlock\",\n      (window as any).RHE_FORMAT_OPTIONS || [],\n      (format as any).formatBlock,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeSelect(\n      \"Font\",\n      \"fontName\",\n      (window as any).RHE_FONT_OPTIONS || [],\n      (format as any).fontName,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeSelect(\n      \"Size\",\n      \"fontSize\",\n      (window as any).RHE_SIZE_OPTIONS || [],\n      (format as any).fontSize,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeColorInput(\n      \"Text color\",\n      \"foreColor\",\n      (format as any).foreColor,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeColorInput(\n      \"Highlight color\",\n      \"hiliteColor\",\n      (format as any).hiliteColor,\n    ),\n  );\n  overflowMenu.appendChild(helpers.makeButton(\"Link\", \"Insert link\", \"link\"));\n\n  const overflowWrap = helpers.makeGroup();\n  overflowWrap.className = \"toolbar-group toolbar-overflow-wrap\";\n  overflowWrap.appendChild(overflowBtn);\n  overflowWrap.appendChild(overflowMenu);\n  toolbar.appendChild(overflowWrap);\n}\n","import { _saveSelection, _restoreSelection } from \"../core/state\";\n\nexport function makeButton(\n  doc: Document,\n  options: { onCommand: (command: string, value?: string) => void },\n  label: string,\n  title: string,\n  command: string,\n  value?: string,\n  isActive?: boolean,\n  disabled?: boolean,\n) {\n  const btn = doc.createElement(\"button\");\n  btn.type = \"button\";\n  if (label && label.trim().startsWith(\"<\")) {\n    btn.innerHTML = label;\n  } else {\n    btn.textContent = label;\n  }\n  btn.title = title;\n  btn.setAttribute(\"aria-label\", title);\n  if (typeof isActive !== \"undefined\")\n    btn.setAttribute(\"aria-pressed\", String(!!isActive));\n  btn.tabIndex = 0;\n  if (disabled) btn.disabled = true;\n  btn.onclick = () => {\n    // restore any previously-saved selection before executing command\n    _restoreSelection();\n    options.onCommand(command, value);\n  };\n  // Prevent toolbar button from taking focus / collapsing selection in the editor\n  btn.addEventListener(\"mousedown\", (ev: MouseEvent) => {\n    ev.preventDefault();\n    _saveSelection();\n  });\n  btn.addEventListener(\"keydown\", (ev: KeyboardEvent) => {\n    if (ev.key === \"Enter\" || ev.key === \" \") {\n      ev.preventDefault();\n      btn.click();\n    }\n  });\n  return btn;\n}\n\nexport function makeGroup(doc: Document) {\n  const g = doc.createElement(\"div\");\n  g.className = \"toolbar-group\";\n  return g;\n}\n\nexport function makeSep(doc: Document) {\n  const s = doc.createElement(\"div\");\n  s.className = \"toolbar-sep\";\n  return s;\n}\n","export function makeSelect(\n  doc: Document,\n  options: { onCommand: (command: string, value?: string) => void },\n  title: string,\n  command: string,\n  optionsList: { label: string; value: string }[],\n  initialValue?: string | null,\n) {\n  const select = doc.createElement(\"select\");\n  select.title = title;\n  select.setAttribute(\"aria-label\", title);\n  select.appendChild(new Option(title, \"\", true, true));\n  for (const opt of optionsList) {\n    select.appendChild(new Option(opt.label, opt.value));\n  }\n  try {\n    if (initialValue) select.value = initialValue;\n  } catch (e) {\n    /* ignore invalid value */\n  }\n  select.onchange = (e: Event) => {\n    const val = (e.target as HTMLSelectElement).value;\n    options.onCommand(command, val);\n    select.selectedIndex = 0;\n  };\n  return select;\n}\n","export function setupNavigation(toolbar: HTMLElement) {\n  toolbar.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n    const focusable = Array.from(\n      toolbar.querySelectorAll<HTMLElement>(\n        \"button, select, input, [tabindex]\",\n      ),\n    ).filter((el) => !el.hasAttribute(\"disabled\"));\n    if (!focusable.length) return;\n    const idx = focusable.indexOf(document.activeElement as HTMLElement);\n    if (e.key === \"ArrowRight\") {\n      e.preventDefault();\n      const next =\n        focusable[Math.min(focusable.length - 1, Math.max(0, idx + 1))];\n      next?.focus();\n    } else if (e.key === \"ArrowLeft\") {\n      e.preventDefault();\n      const prev = focusable[Math.max(0, idx - 1)] || focusable[0];\n      prev?.focus();\n    } else if (e.key === \"Home\") {\n      e.preventDefault();\n      focusable[0].focus();\n    } else if (e.key === \"End\") {\n      e.preventDefault();\n      focusable[focusable.length - 1].focus();\n    }\n  });\n}\n","import {\n  _getCurrentEditable,\n  _setCurrentEditable,\n  pushStandaloneSnapshot,\n  _getUndoStack,\n  _getRedoStack,\n} from \"../core/state\";\nimport { isEditableCandidate } from \"./candidates\";\nimport { openImageEditor } from \"./imageEditor\";\nimport { injectToolbar } from \"../toolbar/toolbar\";\nimport { computeFormatState, getElementLabel } from \"./format\";\nimport { handleToolbarCommand, handleUndo, handleRedo } from \"../core/commands\";\nimport { CLASS_ACTIVE } from \"../core/constants\";\n\n/**\n * Attach DOM event handlers to the document\n *\n * Handles:\n * - Click: Enables editing on valid elements\n * - Selection change: Updates toolbar state\n * - Input: Creates undo/redo snapshots\n *\n * @param doc - Document to attach handlers to\n */\nexport function attachStandaloneHandlers(doc: Document) {\n  // Assign stable data-rhe-id markers to likely editable candidates so\n  // snapshots include identifiers for selective restoration. Limit the\n  // selector to common content containers to avoid a full DOM walk.\n  try {\n    const selector = [\n      \"p\",\n      \"div\",\n      \"section\",\n      \"article\",\n      \"header\",\n      \"footer\",\n      \"aside\",\n      \"nav\",\n      \"span\",\n      \"h1\",\n      \"h2\",\n      \"h3\",\n      \"h4\",\n      \"h5\",\n      \"h6\",\n      \"li\",\n      \"figure\",\n      \"figcaption\",\n      \"blockquote\",\n      \"pre\",\n      \"code\",\n    ].join(\",\");\n    const candidates = Array.from(\n      doc.querySelectorAll<HTMLElement>(selector),\n    ).filter((el) => isEditableCandidate(el));\n    candidates.forEach((target) => {\n      if (!target.hasAttribute(\"data-rhe-id\")) {\n        const uid = `rhe-init-${Date.now()}-${Math.random()\n          .toString(36)\n          .slice(2, 7)}`;\n        try {\n          target.setAttribute(\"data-rhe-id\", uid);\n        } catch (err) {\n          /* ignore */\n        }\n      }\n    });\n  } catch (err) {\n    /* ignore initialization errors */\n  }\n\n  doc.addEventListener(\n    \"click\",\n    (e) => {\n      const target = e.target as HTMLElement;\n      // If an image was clicked, open the image editor modal\n      if (target && target.tagName === \"IMG\") {\n        try {\n          openImageEditor(doc, target as HTMLImageElement);\n        } catch (err) {\n          /* ignore */\n        }\n        e.preventDefault();\n        e.stopPropagation();\n        return;\n      }\n      if (!isEditableCandidate(target)) return;\n      if (_getCurrentEditable() && _getCurrentEditable() !== target) {\n        _getCurrentEditable()?.removeAttribute(\"contenteditable\");\n        _getCurrentEditable()?.classList.remove(CLASS_ACTIVE);\n      }\n      // Ensure the editable element has a stable identifier so snapshots\n      // can restore only the editable region without touching the rest\n      // of the page (header, nav, scripts, etc.). Use a data attribute\n      // to avoid clashing with page ids.\n      if (!target.hasAttribute(\"data-rhe-id\")) {\n        const uid = `rhe-${Date.now()}-${Math.random()\n          .toString(36)\n          .slice(2, 7)}`;\n        try {\n          target.setAttribute(\"data-rhe-id\", uid);\n        } catch (err) {\n          /* ignore attribute set errors */\n        }\n      }\n      _setCurrentEditable(target);\n      target.classList.add(CLASS_ACTIVE);\n      target.setAttribute(\"contenteditable\", \"true\");\n      target.focus();\n    },\n    true,\n  );\n  doc.addEventListener(\"selectionchange\", () => {\n    injectToolbar(doc, {\n      onCommand: handleToolbarCommand,\n      canUndo: () => _getUndoStack().length > 1,\n      canRedo: () => _getRedoStack().length > 0,\n      onUndo: handleUndo,\n      onRedo: handleRedo,\n      getFormatState: () => computeFormatState(doc),\n      getSelectedElementInfo: () => getElementLabel(_getCurrentEditable()),\n    });\n  });\n  doc.addEventListener(\"input\", () => pushStandaloneSnapshot(), true);\n\n  // Keyboard shortcuts for common formatting and undo/redo\n  doc.addEventListener(\n    \"keydown\",\n    (e) => {\n      const meta = e.ctrlKey || e.metaKey;\n      if (!meta) return;\n      const key = e.key.toLowerCase();\n      // Bold: Ctrl/Cmd+B\n      if (key === \"b\") {\n        e.preventDefault();\n        handleToolbarCommand(\"bold\");\n        return;\n      }\n      // Italic: Ctrl/Cmd+I\n      if (key === \"i\") {\n        e.preventDefault();\n        handleToolbarCommand(\"italic\");\n        return;\n      }\n      // Underline: Ctrl/Cmd+U\n      if (key === \"u\") {\n        e.preventDefault();\n        handleToolbarCommand(\"underline\");\n        return;\n      }\n      // Undo: Ctrl/Cmd+Z\n      if (key === \"z\") {\n        e.preventDefault();\n        // If Shift is pressed, treat as redo\n        if (e.shiftKey) {\n          handleRedo();\n        } else {\n          handleUndo();\n        }\n        return;\n      }\n      // Redo: Ctrl/Cmd+Y\n      if (key === \"y\") {\n        e.preventDefault();\n        handleRedo();\n        return;\n      }\n    },\n    true,\n  );\n\n  // Ensure Enter in lists creates a new list item (consistent across browsers)\n  doc.addEventListener(\n    \"keydown\",\n    (e) => {\n      if (e.key !== \"Enter\") return;\n      // Let Shift+Enter behave as a soft-break\n      if (e.shiftKey) return;\n      const sel = doc.getSelection();\n      if (!sel || !sel.rangeCount) return;\n      const node = sel.anchorNode;\n      const el =\n        node && node.nodeType === Node.ELEMENT_NODE\n          ? (node as HTMLElement)\n          : (node && (node as Node).parentElement) || null;\n      if (!el) return;\n      const li = el.closest(\"li\") as HTMLElement | null;\n      if (!li || !li.parentElement) return;\n      // Prevent default behavior and insert a new empty <li>\n      e.preventDefault();\n      const list = li.parentElement;\n      const newLi = doc.createElement(\"li\");\n      const zw = doc.createTextNode(\"\\u200B\");\n      newLi.appendChild(zw);\n      if (li.nextSibling) list.insertBefore(newLi, li.nextSibling);\n      else list.appendChild(newLi);\n      // place caret inside the new li\n      const range = doc.createRange();\n      range.setStart(zw, 1);\n      range.collapse(true);\n      sel.removeAllRanges();\n      sel.addRange(range);\n      // push snapshot will be triggered by input event after typing\n    },\n    true,\n  );\n}\n","/**\n * Check if an element can be edited\n *\n * Valid elements: Text container tags (p, div, section, etc.)\n * Invalid elements: HTML structure tags, inputs, scripts, styles\n *\n * @param el - Element to check\n * @returns True if element is a valid editable candidate\n */\nexport function isEditableCandidate(el: HTMLElement | null): boolean {\n  if (!el) return false;\n  const tag = el.tagName;\n  const DISALLOWED = [\n    \"HTML\",\n    \"HEAD\",\n    \"BODY\",\n    \"SCRIPT\",\n    \"STYLE\",\n    \"LINK\",\n    \"META\",\n    \"NOSCRIPT\",\n  ];\n  if (DISALLOWED.includes(tag)) return false;\n  if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return false;\n  return true;\n}\n","import { MAX_FILE_SIZE } from \"../core/constants\";\nimport { pushStandaloneSnapshot } from \"../core/state\";\nimport { getEditorRoot } from \"./root\";\n\nfunction createModal(doc: Document) {\n  const overlay = doc.createElement(\"div\");\n  overlay.className = \"rhe-img-modal-overlay\";\n  overlay.setAttribute(\"role\", \"dialog\");\n  overlay.setAttribute(\"aria-modal\", \"true\");\n\n  const modal = doc.createElement(\"div\");\n  modal.className = \"rhe-img-modal\";\n\n  const title = doc.createElement(\"h3\");\n  title.textContent = \"Edit image\";\n\n  const tabs = doc.createElement(\"div\");\n  tabs.className = \"rhe-img-tabs\";\n\n  const uploadBtn = doc.createElement(\"button\");\n  uploadBtn.type = \"button\";\n  uploadBtn.textContent = \"Upload file\";\n  uploadBtn.className = \"active\";\n\n  const urlBtn = doc.createElement(\"button\");\n  urlBtn.type = \"button\";\n  urlBtn.textContent = \"Image URL\";\n\n  tabs.appendChild(uploadBtn);\n  tabs.appendChild(urlBtn);\n\n  const uploadPane = doc.createElement(\"div\");\n  uploadPane.className = \"rhe-img-pane rhe-img-pane-upload\";\n  const fileInput = doc.createElement(\"input\");\n  fileInput.type = \"file\";\n  fileInput.accept = \"image/*\";\n  // Ensure the input fits inside the modal\n  fileInput.style.width = \"100%\";\n  fileInput.style.boxSizing = \"border-box\";\n  uploadPane.appendChild(fileInput);\n  const uploadMsg = doc.createElement(\"div\");\n  uploadMsg.className = \"rhe-img-msg\";\n  uploadPane.appendChild(uploadMsg);\n\n  const urlPane = doc.createElement(\"div\");\n  urlPane.className = \"rhe-img-pane rhe-img-pane-url\";\n  urlPane.style.display = \"none\";\n  const urlInput = doc.createElement(\"input\");\n  urlInput.type = \"url\";\n  urlInput.placeholder = \"https://example.com/image.jpg\";\n  // Ensure the input fits inside the modal\n  urlInput.style.width = \"100%\";\n  urlInput.style.boxSizing = \"border-box\";\n  urlPane.appendChild(urlInput);\n  const urlMsg = doc.createElement(\"div\");\n  urlMsg.className = \"rhe-img-msg\";\n  urlPane.appendChild(urlMsg);\n\n  const actions = doc.createElement(\"div\");\n  actions.className = \"rhe-img-actions\";\n  const cancel = doc.createElement(\"button\");\n  cancel.type = \"button\";\n  cancel.textContent = \"Cancel\";\n  const apply = doc.createElement(\"button\");\n  apply.type = \"button\";\n  apply.textContent = \"Apply\";\n  apply.className = \"primary\";\n  actions.appendChild(cancel);\n  actions.appendChild(apply);\n\n  modal.appendChild(title);\n  modal.appendChild(tabs);\n  modal.appendChild(uploadPane);\n  modal.appendChild(urlPane);\n  modal.appendChild(actions);\n  overlay.appendChild(modal);\n\n  // Tab behavior\n  uploadBtn.addEventListener(\"click\", () => {\n    uploadBtn.classList.add(\"active\");\n    urlBtn.classList.remove(\"active\");\n    uploadPane.style.display = \"block\";\n    urlPane.style.display = \"none\";\n  });\n  urlBtn.addEventListener(\"click\", () => {\n    urlBtn.classList.add(\"active\");\n    uploadBtn.classList.remove(\"active\");\n    uploadPane.style.display = \"none\";\n    urlPane.style.display = \"block\";\n  });\n\n  return {\n    overlay,\n    fileInput,\n    uploadMsg,\n    urlInput,\n    urlMsg,\n    cancel,\n    apply,\n  };\n}\n\nfunction validateUrl(u: string): boolean {\n  try {\n    const url = new URL(u);\n    if (url.protocol !== \"http:\" && url.protocol !== \"https:\") return false;\n    return true;\n  } catch (err) {\n    return false;\n  }\n}\n\nexport function openImageEditor(doc: Document, img: HTMLImageElement) {\n  const existing = doc.querySelector(\".rhe-img-modal-overlay\");\n  if (existing) return;\n  const { overlay, fileInput, uploadMsg, urlInput, urlMsg, cancel, apply } =\n    createModal(doc);\n\n  function close() {\n    overlay.remove();\n  }\n\n  // File input handler\n  fileInput.addEventListener(\"change\", () => {\n    uploadMsg.textContent = \"\";\n    const f = fileInput.files && fileInput.files[0];\n    if (!f) return;\n    if (!f.type.startsWith(\"image/\")) {\n      uploadMsg.textContent = \"Invalid file type\";\n      return;\n    }\n    if (f.size > MAX_FILE_SIZE) {\n      uploadMsg.textContent = \"File is larger than 1 MB\";\n      return;\n    }\n    const reader = new FileReader();\n    reader.onerror = () => {\n      uploadMsg.textContent = \"Failed to read file\";\n    };\n    reader.onload = () => {\n      const result = reader.result as string | null;\n      if (!result) {\n        uploadMsg.textContent = \"Failed to read file\";\n        return;\n      }\n      img.src = result;\n      try {\n        pushStandaloneSnapshot();\n      } catch (err) {\n        /* ignore snapshot errors */\n      }\n      close();\n    };\n    reader.readAsDataURL(f);\n  });\n\n  // URL apply handler\n  apply.addEventListener(\"click\", async () => {\n    urlMsg.textContent = \"\";\n    const val = urlInput.value.trim();\n    if (val) {\n      if (!validateUrl(val)) {\n        urlMsg.textContent = \"Enter a valid http/https URL\";\n        return;\n      }\n      // Try to fetch HEAD to validate content-type/length (best-effort, may fail due to CORS)\n      try {\n        const head = await fetch(val, { method: \"HEAD\" });\n        const ct = head.headers.get(\"content-type\");\n        const cl = head.headers.get(\"content-length\");\n        if (ct && !ct.startsWith(\"image/\")) {\n          urlMsg.textContent = \"URL does not point to an image\";\n          return;\n        }\n        if (cl && Number(cl) > MAX_FILE_SIZE) {\n          urlMsg.textContent = \"Image appears larger than 1 MB\";\n          return;\n        }\n        // OK â€” apply URL\n        img.src = val;\n        try {\n          pushStandaloneSnapshot();\n        } catch (err) {\n          /* ignore snapshot errors */\n        }\n        close();\n        return;\n      } catch (err) {\n        // If HEAD fails (CORS), still allow setting the URL â€” leave a soft warning\n        img.src = val;\n        try {\n          pushStandaloneSnapshot();\n        } catch (err) {\n          /* ignore snapshot errors */\n        }\n        close();\n        return;\n      }\n    } else {\n      // No URL entered â€” just close\n      close();\n    }\n  });\n\n  cancel.addEventListener(\"click\", () => close());\n\n  // Basic keyboard handling: Escape closes\n  overlay.addEventListener(\"keydown\", (e) => {\n    if (e.key === \"Escape\") close();\n  });\n\n  // Insert overlay inside the editor root so global template CSS doesn't affect modal UI\n  try {\n    const root = getEditorRoot(doc);\n    root.appendChild(overlay);\n  } catch (e) {\n    doc.body.appendChild(overlay);\n  }\n  (fileInput as HTMLInputElement).focus();\n}\n\nexport default {};\n","/**\n * Compute the current formatting state of selected text\n *\n * Detects bold, italic, and underline formatting based on:\n * - DOM element tags (strong, em, u)\n * - CSS computed styles (fontWeight, fontStyle, textDecoration)\n *\n * @param doc - Document context\n * @returns Object with boolean flags for bold, italic, underline\n */\nexport function computeFormatState(doc: Document): {\n  bold: boolean;\n  italic: boolean;\n  underline: boolean;\n  foreColor: string | null;\n  hiliteColor: string | null;\n  fontName: string | null;\n  fontSize: string | null;\n  formatBlock: string | null;\n  listType: string | null;\n} {\n  try {\n    const s = doc.getSelection();\n    let el: HTMLElement | null = null;\n    if (s && s.anchorNode)\n      el =\n        s.anchorNode.nodeType === Node.ELEMENT_NODE\n          ? (s.anchorNode as HTMLElement)\n          : (s.anchorNode.parentElement as HTMLElement);\n    if (!el)\n      return {\n        bold: false,\n        italic: false,\n        underline: false,\n        foreColor: null,\n        hiliteColor: null,\n        fontName: null,\n        fontSize: null,\n        formatBlock: null,\n        listType: null,\n      };\n    const computed = doc.defaultView?.getComputedStyle(el) as\n      | CSSStyleDeclaration\n      | undefined;\n    const bold = !!(\n      el.closest(\"strong, b\") ||\n      (computed &&\n        (computed.fontWeight === \"700\" || Number(computed.fontWeight) >= 700))\n    );\n    const italic = !!(\n      el.closest(\"em, i\") ||\n      (computed && computed.fontStyle === \"italic\")\n    );\n    const underline = !!(\n      el.closest(\"u\") ||\n      (computed && (computed.textDecorationLine || \"\").includes(\"underline\"))\n    );\n    // Try to detect text color and highlight (background) color at the selection\n    const foreColor =\n      (el.closest(\"font[color]\") as HTMLElement | null)?.getAttribute(\n        \"color\",\n      ) ||\n      (computed && computed.color) ||\n      null;\n    // Background color may come from a <mark> element or computed background-color\n    const mark = el.closest(\"mark\") as HTMLElement | null;\n    const hiliteColor =\n      (mark && (mark.getAttribute(\"style\") || \"\")) ||\n      (computed &&\n      computed.backgroundColor &&\n      computed.backgroundColor !== \"rgba(0, 0, 0, 0)\"\n        ? computed.backgroundColor\n        : null);\n\n    // detect font name + size from computed style\n    const fontName = (computed && computed.fontFamily) || null;\n    const fontSize = (computed && computed.fontSize) || null;\n    // detect block ancestor (paragraph, heading etc.)\n    let blockEl: HTMLElement | null = el;\n    while (blockEl && blockEl.parentElement) {\n      const tag = blockEl.tagName;\n      if (\n        [\n          \"P\",\n          \"DIV\",\n          \"SECTION\",\n          \"ARTICLE\",\n          \"LI\",\n          \"TD\",\n          \"BLOCKQUOTE\",\n          \"H1\",\n          \"H2\",\n          \"H3\",\n          \"H4\",\n          \"H5\",\n          \"H6\",\n        ].includes(tag)\n      ) {\n        break;\n      }\n      blockEl = blockEl.parentElement as HTMLElement | null;\n    }\n    const formatBlock = blockEl ? blockEl.tagName.toLowerCase() : null;\n    // detect if selection is inside a list and which type\n    let listType: string | null = null;\n    try {\n      if (blockEl && blockEl.tagName === \"LI\") {\n        const list = blockEl.closest(\"ul,ol\") as HTMLElement | null;\n        if (list) listType = list.tagName.toLowerCase();\n      } else {\n        const possible = el.closest(\"ul,ol\") as HTMLElement | null;\n        if (possible) listType = possible.tagName.toLowerCase();\n      }\n    } catch (e) {\n      listType = null;\n    }\n\n    return {\n      bold,\n      italic,\n      underline,\n      foreColor,\n      hiliteColor,\n      fontName,\n      fontSize,\n      formatBlock,\n      listType,\n    };\n  } catch (err) {\n    return {\n      bold: false,\n      italic: false,\n      underline: false,\n      foreColor: null,\n      hiliteColor: null,\n      fontName: null,\n      fontSize: null,\n      formatBlock: null,\n      listType: null,\n    };\n  }\n}\n\n/**\n * Get a human-readable label for an element\n *\n * Format: `tagname#id.class`\n * Example: `p#intro.highlight` or `div.container`\n *\n * @param el - HTML element to label\n * @returns Label string or null if element is null\n */\nexport function getElementLabel(el: HTMLElement | null): string | null {\n  if (!el) return null;\n  const id = el.id ? `#${el.id}` : \"\";\n  const cls = el.className ? `.${String(el.className).split(\" \")[0]}` : \"\";\n  const tag = el.tagName.toLowerCase();\n  return `${tag}${id}${cls}`;\n}\n","export function sanitizeURL(url: string): string {\n  if (!url) return \"\";\n  const trimmed = url.trim();\n  if (!trimmed) return \"\";\n  if (\n    trimmed.toLowerCase().startsWith(\"javascript:\") ||\n    trimmed.toLowerCase().startsWith(\"data:\")\n  ) {\n    console.warn(\"Blocked potentially dangerous URL protocol\");\n    return \"\";\n  }\n  if (!trimmed.startsWith(\"http\") && !trimmed.startsWith(\"#\")) {\n    return \"https://\" + trimmed;\n  }\n  return trimmed;\n}\n","import {\n  _getDoc,\n  _getUndoStack,\n  _getRedoStack,\n  _setUndoStack,\n  _setRedoStack,\n} from \"./state\";\n\nimport { sanitizeHtml } from \"../utils/sanitize\";\nimport { injectStyles } from \"../dom/styles\";\n\nexport function handleUndo() {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] handleUndo called before initialization\",\n      );\n      return;\n    }\n    if (_getUndoStack().length < 2) return;\n    const undoStack = _getUndoStack();\n    const redoStack = _getRedoStack();\n    const current = undoStack.pop()!;\n    redoStack.push(current);\n    const prev = undoStack[undoStack.length - 1];\n    if (!doc.documentElement) {\n      throw new Error(\"Document is missing documentElement\");\n    }\n    // Sanitize the snapshot and extract only the body content so we\n    // avoid overwriting head/link/style nodes that may contain page\n    // or editor styles. Replacing only `document.body` preserves those\n    // nodes while still restoring user content.\n    const safe = sanitizeHtml(prev.replace(/^<!doctype html>\\n?/i, \"\"), doc);\n    try {\n      const parser = new DOMParser();\n      const parsed = parser.parseFromString(safe, \"text/html\");\n      if (parsed && parsed.body && doc.body) {\n        // Prefer selective restoration: if the snapshot contains elements\n        // marked with `data-rhe-id`, restore only those elements so we do\n        // not clobber page-level UI (headers, tabs, carousel scripts).\n        const parsedEls = parsed.body.querySelectorAll(\"[data-rhe-id]\");\n        if (parsedEls && parsedEls.length) {\n          const loadPromises: Promise<void>[] = [];\n          parsedEls.forEach((pe) => {\n            const id = pe.getAttribute(\"data-rhe-id\");\n            if (!id) return;\n            const local = doc.body.querySelector(`[data-rhe-id=\"${id}\"]`);\n            if (!local) return;\n            // Copy non-identifying attributes from parsed element to local\n            try {\n              Array.from(local.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\") local.removeAttribute(a.name);\n              });\n              Array.from(pe.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\")\n                  local.setAttribute(a.name, a.value);\n              });\n            } catch (err) {\n              /* ignore attribute copy errors */\n            }\n            // Replace innerHTML of the editable region only\n            try {\n              local.innerHTML = pe.innerHTML;\n            } catch (err) {\n              /* ignore innerHTML set errors */\n            }\n            // Recreate preserved script placeholders inside the parsed element\n            try {\n              const placeholders = pe.querySelectorAll(\"[data-rhe-script]\");\n              placeholders.forEach((ph) => {\n                const encoded = ph.getAttribute(\"data-rhe-script\") || \"\";\n                let code = \"\";\n                try {\n                  code =\n                    typeof atob !== \"undefined\"\n                      ? decodeURIComponent(escape(atob(encoded)))\n                      : decodeURIComponent(encoded);\n                } catch (e) {\n                  try {\n                    code = decodeURIComponent(encoded);\n                  } catch (er) {\n                    code = \"\";\n                  }\n                }\n                const attrsRaw = ph.getAttribute(\"data-rhe-script-attrs\");\n                let attrs: Record<string, string> = {};\n                if (attrsRaw) {\n                  try {\n                    attrs = JSON.parse(decodeURIComponent(attrsRaw));\n                  } catch (e) {\n                    attrs = {};\n                  }\n                }\n                const parentId = ph.getAttribute(\"data-rhe-script-parent\");\n                try {\n                  const s = doc.createElement(\"script\");\n                  try {\n                    s.type = \"text/javascript\";\n                    (s as any).async = false;\n                  } catch (err) {\n                    /* ignore */\n                  }\n                  Object.keys(attrs).forEach((k) =>\n                    s.setAttribute(k, attrs[k]),\n                  );\n                  if (attrs.src) {\n                    const p = new Promise<void>((resolve) => {\n                      s.addEventListener(\"load\", () => resolve());\n                      s.addEventListener(\"error\", () => resolve());\n                    });\n                    loadPromises.push(p);\n                    s.src = attrs.src;\n                  } else {\n                    s.textContent = code;\n                  }\n                  if (parentId === \"head\") {\n                    doc.head.appendChild(s);\n                  } else {\n                    const target = doc.body.querySelector(\n                      `[data-rhe-id=\"${parentId}\"]`,\n                    );\n                    if (target) target.appendChild(s);\n                    else doc.body.appendChild(s);\n                  }\n                } catch (e) {\n                  /* ignore script injection errors */\n                }\n              });\n            } catch (e) {\n              /* ignore placeholder processing errors */\n            }\n          });\n          try {\n            if (loadPromises.length) {\n              const waiter = (Promise as any).allSettled\n                ? (Promise as any).allSettled(loadPromises)\n                : Promise.all(\n                    loadPromises.map((p) => p.catch(() => undefined)),\n                  );\n              waiter.then(() => {\n                try {\n                  doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n                } catch (e) {\n                  /* ignore */\n                }\n              });\n            } else {\n              try {\n                doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n              } catch (e) {\n                /* ignore */\n              }\n            }\n          } catch (e) {\n            /* ignore */\n          }\n        } else {\n          // No markers present â€” fallback to previous behavior of replacing\n          // the body contents. This preserves backward compatibility.\n          doc.body.innerHTML = parsed.body.innerHTML;\n        }\n      } else {\n        // Fallback to replacing the whole documentElement if body is missing\n        doc.documentElement.innerHTML = safe;\n      }\n    } catch (err) {\n      // On any parse error, fall back to previous behavior\n      doc.documentElement.innerHTML = safe;\n    }\n\n    // Re-inject editor styles (toolbar/style) and notify listeners so the\n    // toolbar is restored and selectionchange handlers run.\n    injectStyles(doc);\n    try {\n      doc.dispatchEvent(new Event(\"selectionchange\"));\n    } catch (err) {\n      /* ignore dispatch errors */\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Undo failed:\", message);\n  }\n}\n\nexport function handleRedo() {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] handleRedo called before initialization\",\n      );\n      return;\n    }\n    if (!_getRedoStack().length) return;\n    const undoStack = _getUndoStack();\n    const redoStack = _getRedoStack();\n    const next = redoStack.pop()!;\n    undoStack.push(next);\n    if (!doc.documentElement) {\n      throw new Error(\"Document is missing documentElement\");\n    }\n    const safeNext = sanitizeHtml(\n      next.replace(/^<!doctype html>\\n?/i, \"\"),\n      doc,\n    );\n    try {\n      const parser = new DOMParser();\n      const parsed = parser.parseFromString(safeNext, \"text/html\");\n      if (parsed && parsed.body && doc.body) {\n        const parsedEls = parsed.body.querySelectorAll(\"[data-rhe-id]\");\n        if (parsedEls && parsedEls.length) {\n          const loadPromises: Promise<void>[] = [];\n          parsedEls.forEach((pe) => {\n            const id = pe.getAttribute(\"data-rhe-id\");\n            if (!id) return;\n            const local = doc.body.querySelector(`[data-rhe-id=\"${id}\"]`);\n            if (!local) return;\n            try {\n              Array.from(local.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\") local.removeAttribute(a.name);\n              });\n              Array.from(pe.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\")\n                  local.setAttribute(a.name, a.value);\n              });\n            } catch (err) {\n              /* ignore */\n            }\n            try {\n              local.innerHTML = pe.innerHTML;\n            } catch (err) {\n              /* ignore */\n            }\n            try {\n              const placeholders = pe.querySelectorAll(\"[data-rhe-script]\");\n              placeholders.forEach((ph) => {\n                const encoded = ph.getAttribute(\"data-rhe-script\") || \"\";\n                let code = \"\";\n                try {\n                  code =\n                    typeof atob !== \"undefined\"\n                      ? decodeURIComponent(escape(atob(encoded)))\n                      : decodeURIComponent(encoded);\n                } catch (e) {\n                  try {\n                    code = decodeURIComponent(encoded);\n                  } catch (er) {\n                    code = \"\";\n                  }\n                }\n                const attrsRaw = ph.getAttribute(\"data-rhe-script-attrs\");\n                let attrs: Record<string, string> = {};\n                if (attrsRaw) {\n                  try {\n                    attrs = JSON.parse(decodeURIComponent(attrsRaw));\n                  } catch (e) {\n                    attrs = {};\n                  }\n                }\n                const parentId = ph.getAttribute(\"data-rhe-script-parent\");\n                try {\n                  const s = doc.createElement(\"script\");\n                  try {\n                    s.type = \"text/javascript\";\n                    (s as any).async = false;\n                  } catch (err) {\n                    /* ignore */\n                  }\n                  Object.keys(attrs).forEach((k) =>\n                    s.setAttribute(k, attrs[k]),\n                  );\n                  if (attrs.src) {\n                    const p = new Promise<void>((resolve) => {\n                      s.addEventListener(\"load\", () => resolve());\n                      s.addEventListener(\"error\", () => resolve());\n                    });\n                    loadPromises.push(p);\n                    s.src = attrs.src;\n                  } else {\n                    s.textContent = code;\n                  }\n                  if (parentId === \"head\") {\n                    doc.head.appendChild(s);\n                  } else {\n                    const target = doc.body.querySelector(\n                      `[data-rhe-id=\"${parentId}\"]`,\n                    );\n                    if (target) target.appendChild(s);\n                    else doc.body.appendChild(s);\n                  }\n                } catch (e) {\n                  /* ignore script injection errors */\n                }\n              });\n            } catch (e) {\n              /* ignore placeholder processing errors */\n            }\n          });\n          try {\n            if (loadPromises.length) {\n              const waiter = (Promise as any).allSettled\n                ? (Promise as any).allSettled(loadPromises)\n                : Promise.all(\n                    loadPromises.map((p) => p.catch(() => undefined)),\n                  );\n              waiter.then(() => {\n                try {\n                  doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n                } catch (e) {\n                  /* ignore */\n                }\n              });\n            } else {\n              try {\n                doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n              } catch (e) {\n                /* ignore */\n              }\n            }\n          } catch (e) {\n            /* ignore */\n          }\n        } else {\n          doc.body.innerHTML = parsed.body.innerHTML;\n        }\n      } else {\n        doc.documentElement.innerHTML = safeNext;\n      }\n    } catch (err) {\n      doc.documentElement.innerHTML = safeNext;\n    }\n\n    // Re-inject styles and notify listeners so toolbar/styles are restored\n    injectStyles(doc);\n    try {\n      doc.dispatchEvent(new Event(\"selectionchange\"));\n    } catch (err) {\n      /* ignore dispatch errors */\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Redo failed:\", message);\n  }\n}\n","import { _getDoc, pushStandaloneSnapshot } from \"./state\";\nimport { sanitizeURL } from \"./sanitizeURL\";\n\nexport function handleToolbarCommand(command: string, value?: string) {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] handleToolbarCommand called before initialization\",\n      );\n      return;\n    }\n    if (command === \"undo\") return; // delegated to history module\n    if (command === \"redo\") return; // delegated to history module\n    if (command === \"link\") {\n      const url = window.prompt(\"Enter URL (https://...):\", \"https://\");\n      if (url) {\n        const sanitized = sanitizeURL(url);\n        if (sanitized) applyStandaloneCommand(\"link\", sanitized);\n      }\n      return;\n    }\n    applyStandaloneCommand(command, value);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Command handler failed:\", message);\n  }\n}\n\nexport function applyStandaloneCommand(command: string, value?: string) {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] applyStandaloneCommand called before initialization\",\n      );\n      return;\n    }\n\n    if (command === \"bold\") wrapSelectionWithElement(doc, \"strong\");\n    else if (command === \"italic\") wrapSelectionWithElement(doc, \"em\");\n    else if (command === \"underline\") wrapSelectionWithElement(doc, \"u\");\n    else if (command === \"strike\") wrapSelectionWithElement(doc, \"s\");\n    else if (command === \"fontName\")\n      wrapSelectionWithElement(doc, \"span\", { fontFamily: value as any });\n    else if (command === \"fontSize\") {\n      // Accept numeric font-size values (e.g. \"12\", \"16\") and apply as px.\n      const raw = value || \"14\";\n      const n = parseInt(raw, 10);\n      const sz = Number.isFinite(n) ? `${n}px` : raw;\n      wrapSelectionWithElement(doc, \"span\", { fontSize: sz as any });\n    } else if (command === \"link\") {\n      const sel = doc.getSelection();\n      if (!sel || !sel.rangeCount) return;\n      const range = sel.getRangeAt(0);\n      const content = range.extractContents();\n      const a = doc.createElement(\"a\");\n      a.href = sanitizeURL(value || \"#\");\n      a.appendChild(content);\n      // mark anchor as editor-created (so clearFormat can detect it)\n      a.dataset.rheFormat = \"true\";\n      range.insertNode(a);\n    } else if (command === \"foreColor\")\n      wrapSelectionWithElement(doc, \"span\", { color: value as any });\n    else if (command === \"hiliteColor\")\n      wrapSelectionWithElement(doc, \"span\", { backgroundColor: value as any });\n    else if (command === \"align\") {\n      const sel = doc.getSelection();\n      const node = sel?.anchorNode || null;\n      const block = findBlockAncestor(node);\n      if (block) block.style.textAlign = value || \"left\";\n      else wrapSelectionWithElement(doc, \"div\", { textAlign: value as any });\n    } else if (command === \"formatBlock\") {\n      // Change block-level element to selected tag (p, h1..h6)\n      const sel = doc.getSelection();\n      const node = sel?.anchorNode || null;\n      const block = findBlockAncestor(node);\n      const tag = (value || \"p\").toLowerCase();\n      if (block && block.parentElement) {\n        // Replace existing block with new block of desired tag\n        const newEl = doc.createElement(tag);\n        // Preserve inline styles?\n        newEl.className = (block as HTMLElement).className || \"\";\n        while (block.firstChild) newEl.appendChild(block.firstChild);\n        // mark as editor-created block\n        (newEl as HTMLElement).dataset.rheFormat = \"true\";\n        block.parentElement.replaceChild(newEl, block);\n      } else {\n        // Wrap selection in the block tag\n        wrapSelectionWithElement(doc, tag);\n      }\n    } else if (command === \"unorderedList\" || command === \"orderedList\") {\n      const tag = command === \"unorderedList\" ? \"ul\" : \"ol\";\n      toggleList(doc, tag);\n    } else if (command === \"clearFormat\") {\n      clearSelectionFormatting(doc);\n    }\n\n    pushStandaloneSnapshot();\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Apply command failed:\", message);\n  }\n}\n\nfunction wrapSelectionWithElement(\n  doc: Document,\n  tagName: string,\n  style?: Partial<CSSStyleDeclaration>,\n): void {\n  const sel = doc.getSelection();\n  if (!sel) return;\n  if (!sel.rangeCount) return;\n  const range = sel.getRangeAt(0);\n  if (range.collapsed) {\n    const el = doc.createElement(tagName);\n    if (style) Object.assign(el.style, style as any);\n    // mark element as created by editor for session-only clearing\n    (el as HTMLElement).dataset.rheFormat = \"true\";\n    const zw = doc.createTextNode(\"\\u200B\");\n    el.appendChild(zw);\n    range.insertNode(el);\n    const newRange = doc.createRange();\n    newRange.setStart(zw, 1);\n    newRange.collapse(true);\n    sel.removeAllRanges();\n    sel.addRange(newRange);\n    return;\n  }\n  const content = range.extractContents();\n  const wrapper = doc.createElement(tagName);\n  if (style) Object.assign(wrapper.style, style as any);\n  // mark wrapper so we can clear editor-applied formatting later\n  (wrapper as HTMLElement).dataset.rheFormat = \"true\";\n  wrapper.appendChild(content);\n  range.insertNode(wrapper);\n  sel.removeAllRanges();\n  const newRange = doc.createRange();\n  newRange.selectNodeContents(wrapper);\n  sel.addRange(newRange);\n}\n\nfunction toggleList(doc: Document, listTag: \"ul\" | \"ol\") {\n  const sel = doc.getSelection();\n  if (!sel || !sel.rangeCount) return;\n  const node = sel.anchorNode || null;\n  const block = findBlockAncestor(node);\n\n  // If we're inside an LI\n  if (block && block.tagName === \"LI\" && block.parentElement) {\n    const parentList = block.parentElement as HTMLElement;\n    const parentTag = parentList.tagName.toLowerCase();\n    if (parentTag === listTag) {\n      // unwrap list: convert each LI into a P and replace the list\n      const frag = doc.createDocumentFragment();\n      Array.from(parentList.children).forEach((li) => {\n        const p = doc.createElement(\"p\");\n        while (li.firstChild) p.appendChild(li.firstChild);\n        frag.appendChild(p);\n      });\n      parentList.parentElement?.replaceChild(frag, parentList);\n      return;\n    } else {\n      // change list type (ul <-> ol)\n      const newList = doc.createElement(listTag);\n      while (parentList.firstChild) newList.appendChild(parentList.firstChild);\n      parentList.parentElement?.replaceChild(newList, parentList);\n      return;\n    }\n  }\n\n  // Not inside an existing list: wrap selection in a new list with a single LI per block\n  const range = sel.getRangeAt(0);\n  if (range.collapsed) {\n    const list = doc.createElement(listTag);\n    const li = doc.createElement(\"li\");\n    const zw = doc.createTextNode(\"\\u200B\");\n    li.appendChild(zw);\n    list.appendChild(li);\n    range.insertNode(list);\n    // place cursor inside the zero-width text node\n    const newRange = doc.createRange();\n    newRange.setStart(zw, 1);\n    newRange.collapse(true);\n    sel.removeAllRanges();\n    sel.addRange(newRange);\n    return;\n  }\n\n  // Non-collapsed: extract contents and wrap in a single LI (preserve structure)\n  const content = range.extractContents();\n  const list = doc.createElement(listTag);\n  const li = doc.createElement(\"li\");\n  li.appendChild(content);\n  list.appendChild(li);\n  range.insertNode(list);\n  sel.removeAllRanges();\n  const newRange = doc.createRange();\n  newRange.selectNodeContents(li);\n  sel.addRange(newRange);\n}\n\nfunction findBlockAncestor(node: Node | null): HTMLElement | null {\n  let n = node as Node | null;\n  const BLOCKS = [\n    \"P\",\n    \"DIV\",\n    \"SECTION\",\n    \"ARTICLE\",\n    \"LI\",\n    \"TD\",\n    \"BLOCKQUOTE\",\n    \"H1\",\n    \"H2\",\n    \"H3\",\n    \"H4\",\n    \"H5\",\n    \"H6\",\n  ];\n  while (n) {\n    if (n.nodeType === Node.ELEMENT_NODE) {\n      const el = n as HTMLElement;\n      if (BLOCKS.includes(el.tagName)) return el;\n    }\n    n = n.parentNode;\n  }\n  return null;\n}\n\nfunction clearSelectionFormatting(doc: Document) {\n  const sel = doc.getSelection();\n  if (!sel || !sel.rangeCount) return;\n  const range = sel.getRangeAt(0);\n  if (range.collapsed) return;\n\n  // If selection is nested inside editor-created inline wrappers (strong/em/u/span),\n  // expand the range to include the outermost marked ancestor that covers the\n  // selection so extractContents contains them. Build ancestor chains for both\n  // range boundaries and choose the outermost common marked ancestor when possible.\n  try {\n    const INLINE_WRAP = [\"STRONG\", \"B\", \"EM\", \"I\", \"U\", \"S\", \"SPAN\", \"A\"];\n    function getMarkedAncestors(node: Node | null) {\n      const out: HTMLElement[] = [];\n      let n: Node | null =\n        node && node.nodeType === Node.ELEMENT_NODE\n          ? node\n          : ((node && (node as Node).parentElement) as Node | null);\n      while (n) {\n        if (n.nodeType === Node.ELEMENT_NODE) {\n          const el = n as HTMLElement;\n          if (el.dataset && el.dataset.rheFormat === \"true\") out.push(el);\n        }\n        n = (n as Node).parentNode;\n      }\n      return out; // closest first, farthest last\n    }\n\n    const startAnc = getMarkedAncestors(range.startContainer);\n    const endAnc = getMarkedAncestors(range.endContainer);\n\n    // find outermost common ancestor (farthest from leaf)\n    let outer: HTMLElement | null = null;\n    for (let i = startAnc.length - 1; i >= 0; i--) {\n      const a = startAnc[i];\n      if (endAnc.includes(a)) {\n        outer = a;\n        break;\n      }\n    }\n    // fallback: choose the outermost of either side\n    if (!outer) {\n      if (startAnc.length) outer = startAnc[startAnc.length - 1];\n      else if (endAnc.length) outer = endAnc[endAnc.length - 1];\n    }\n\n    if (outer && INLINE_WRAP.includes(outer.tagName)) {\n      try {\n        range.setStartBefore(outer);\n        range.setEndAfter(outer);\n      } catch (e) {\n        /* ignore set range errors */\n      }\n    }\n  } catch (e) {\n    /* ignore ancestor expansion errors */\n  }\n\n  const content = range.extractContents();\n\n  // Aggressive cleaning pass: unwrap any remaining marked nodes inside the\n  // extracted content by moving into a temporary container and repeatedly\n  // replacing marked elements with their children (or converting headings).\n  try {\n    const container = doc.createElement(\"div\");\n    container.appendChild(content);\n    let seen = 0;\n    while (true) {\n      const el = container.querySelector('[data-rhe-format=\"true\"]');\n      if (!el) break;\n      const tagName = el.tagName;\n      if (/^H[1-6]$/.test(tagName)) {\n        const p = doc.createElement(\"p\");\n        while (el.firstChild) p.appendChild(el.firstChild);\n        el.parentNode?.replaceChild(p, el);\n      } else {\n        // remove inline styles and unwrap\n        try {\n          (el as HTMLElement).style.cssText = \"\";\n        } catch (e) {\n          /* ignore style set errors */\n        }\n        const frag = doc.createDocumentFragment();\n        while (el.firstChild) frag.appendChild(el.firstChild);\n        el.parentNode?.replaceChild(frag, el);\n      }\n      seen++;\n      // defensive: avoid infinite loops\n      if (seen > 200) break;\n    }\n    // build a cleaned fragment to continue processing\n    const cleaned = doc.createDocumentFragment();\n    while (container.firstChild) cleaned.appendChild(container.firstChild);\n    // replace original content with cleaned fragment\n    // (content was moved into container, so use cleaned)\n    // continue using 'content' variable as the cleaned fragment\n    // by reassigning via a temporary variable\n    // (we'll use 'contentToInsert' below)\n    var contentToInsert = cleaned;\n\n    // replace content variable for downstream cleaning steps\n    // (note: content is not reused directly after this, so we will use contentToInsert)\n\n    // Use contentToInsert for the rest of the cleaning below\n    // We'll set 'content' back to contentToInsert by appending its children\n    while (contentToInsert.firstChild)\n      content.appendChild(contentToInsert.firstChild);\n  } catch (e) {\n    /* aggressive cleaning failed; ignore and continue */\n  }\n\n  // Recursively clean nodes that were created by this editor session\n  function cleanNode(node: Node) {\n    // logging removed for cleanliness\n    if (node.nodeType === Node.ELEMENT_NODE) {\n      const el = node as HTMLElement;\n\n      // If element was created by editor, unwrap or replace depending on tag\n      const isMarked = el.dataset && el.dataset.rheFormat === \"true\";\n\n      const tag = el.tagName;\n      if (\n        isMarked &&\n        (tag === \"STRONG\" ||\n          tag === \"B\" ||\n          tag === \"EM\" ||\n          tag === \"I\" ||\n          tag === \"U\" ||\n          tag === \"S\")\n      ) {\n        // replace element with its children and continue cleaning those children\n        const frag = doc.createDocumentFragment();\n        while (el.firstChild) frag.appendChild(el.firstChild);\n        const parent = el.parentNode as Node | null;\n        if (parent) parent.replaceChild(frag, el);\n        // clean any nodes that were moved up into the fragment location\n        Array.from(frag.childNodes).forEach((c) => cleanNode(c));\n        return;\n      }\n\n      if (isMarked && tag === \"SPAN\") {\n        // remove inline styles applied by editor and unwrap\n        el.style.cssText = \"\";\n        const frag = doc.createDocumentFragment();\n        while (el.firstChild) frag.appendChild(el.firstChild);\n        const parent = el.parentNode as Node | null;\n        if (parent) parent.replaceChild(frag, el);\n        Array.from(frag.childNodes).forEach((c) => cleanNode(c));\n        return;\n      }\n\n      if (isMarked && /^H[1-6]$/.test(tag)) {\n        // convert heading to paragraph\n        const p = doc.createElement(\"p\");\n        while (el.firstChild) p.appendChild(el.firstChild);\n        const parent = el.parentNode as Node | null;\n        if (parent) parent.replaceChild(p, el);\n        // continue cleaning inside the new paragraph\n        Array.from(p.childNodes).forEach((c) => cleanNode(c));\n        return;\n      }\n\n      // Otherwise, clean inline styles on marked elements\n      if (isMarked) {\n        el.style.cssText = \"\";\n      }\n\n      // Recurse into children\n      Array.from(el.childNodes).forEach((c) => cleanNode(c));\n    }\n  }\n\n  // Traverse and clean\n  Array.from(content.childNodes).forEach((n) => cleanNode(n));\n\n  // Insert cleaned content wrapped so selection can be restored\n  const wrapper = doc.createElement(\"span\");\n  wrapper.appendChild(content);\n  range.insertNode(wrapper);\n  sel.removeAllRanges();\n  const newRange = doc.createRange();\n  newRange.selectNodeContents(wrapper);\n  sel.addRange(newRange);\n\n  // Unwrap wrapper while keeping selection (selection references the nodes)\n  const parent = wrapper.parentElement;\n  if (parent) {\n    const frag = doc.createDocumentFragment();\n    while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);\n    parent.replaceChild(frag, wrapper);\n  }\n\n  // Final cleanup: ensure no leftover editor-marked elements remain\n  const root = parent || doc.body;\n  const leftover = Array.from(\n    (root as Element).querySelectorAll('[data-rhe-format=\"true\"]'),\n  );\n  leftover.forEach((el) => {\n    const tag = el.tagName;\n    if (/^H[1-6]$/.test(tag)) {\n      const p = doc.createElement(\"p\");\n      while (el.firstChild) p.appendChild(el.firstChild);\n      el.parentElement?.replaceChild(p, el);\n      return;\n    }\n    // unwrap element (move children up); if empty, just remove\n    if (el.firstChild) {\n      const frag = doc.createDocumentFragment();\n      while (el.firstChild) frag.appendChild(el.firstChild);\n      el.parentElement?.replaceChild(frag, el);\n    } else {\n      el.parentElement?.removeChild(el);\n    }\n  });\n\n  // If the selection was inside a heading element that was marked, convert it to a paragraph\n  const possibleBlock = findBlockAncestor(range.startContainer);\n  if (\n    possibleBlock &&\n    possibleBlock.dataset.rheFormat === \"true\" &&\n    /^H[1-6]$/.test(possibleBlock.tagName)\n  ) {\n    const p = doc.createElement(\"p\");\n    while (possibleBlock.firstChild) p.appendChild(possibleBlock.firstChild);\n    possibleBlock.parentElement?.replaceChild(p, possibleBlock);\n  }\n}\n","import { initRichEditor, getCleanHTML } from \"./core/editor\";\nimport type { EditorConfig } from \"./core/types\";\n\nexport default class RichHtmlEditor {\n  private iframeWindow!: Window;\n  private iframeEl?: HTMLIFrameElement;\n  private config?: EditorConfig;\n\n  constructor(\n    options: {\n      iframe: Window | HTMLIFrameElement | string;\n    } & Partial<EditorConfig>,\n  ) {\n    const { iframe, ...cfg } = options as any;\n    this.config = Object.keys(cfg).length ? (cfg as EditorConfig) : undefined;\n\n    if (typeof iframe === \"string\") {\n      const el = document.querySelector(iframe);\n      if (!el) throw new Error(`Iframe selector \"${iframe}\" not found`);\n      if (!(el instanceof HTMLIFrameElement))\n        throw new Error(`Selector \"${iframe}\" did not resolve to an iframe`);\n      if (!el.contentWindow) throw new Error(\"Iframe has no contentWindow\");\n      this.iframeEl = el;\n      this.iframeWindow = el.contentWindow;\n    } else if (iframe && (iframe as HTMLIFrameElement).contentWindow) {\n      const el = iframe as HTMLIFrameElement;\n      if (!el.contentWindow) throw new Error(\"Iframe has no contentWindow\");\n      this.iframeEl = el;\n      this.iframeWindow = el.contentWindow;\n    } else if (iframe && (iframe as Window).document) {\n      this.iframeWindow = iframe as Window;\n      // Try to locate the corresponding iframe element in the current document\n      try {\n        const candidates = Array.from(\n          document.querySelectorAll(\"iframe\"),\n        ) as HTMLIFrameElement[];\n        const found = candidates.find(\n          (f) => f.contentWindow === this.iframeWindow,\n        );\n        if (found) this.iframeEl = found;\n      } catch (e) {\n        /* ignore cross-origin or DOM errors */\n      }\n    } else {\n      throw new Error(\n        \"Invalid `iframe` option. Provide a `Window`, `HTMLIFrameElement`, or selector string.\",\n      );\n    }\n  }\n\n  init() {\n    if (!this.iframeEl) {\n      throw new Error(\n        \"Unable to initialize: iframe element not available. Provide an iframe element or selector.\",\n      );\n    }\n    initRichEditor(this.iframeEl, this.config);\n  }\n\n  getHTML() {\n    return getCleanHTML();\n  }\n\n  static attachToWindow(force = false) {\n    if (typeof window === \"undefined\") return;\n    if (!(window as any).RichHtmlEditor || force) {\n      (window as any).RichHtmlEditor = RichHtmlEditor;\n    }\n  }\n}\n\ndeclare global {\n  interface Window {\n    RichHtmlEditor?: typeof RichHtmlEditor;\n  }\n}\n\nif (typeof window !== \"undefined\") {\n  RichHtmlEditor.attachToWindow();\n}\n"],"mappings":"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S,MAAMiE,UAAUuP,WAAW;AAC5D,MAAM7C,WAAWpR,QAAQS,MAAMiE,UAAUwP,GAAG;AAC5C,MAAM7H,YAAYrM,QAAQS,MAAMiE,UAAUyP,IAAI;AAE9C,MAAMhB,cAAcnT,QAAQS,MAAMiE,UAAU0P,MAAM;AAElD,MAAM/S,oBAAoBrB,QAAQqU,OAAO3P,UAAU4P,WAAW;AAC9D,MAAM5K,iBAAiB1J,QAAQqU,OAAO3P,UAAUuN,QAAQ;AACxD,MAAM7E,cAAcpN,QAAQqU,OAAO3P,UAAU6P,KAAK;AAClD,MAAMvE,gBAAgBhQ,QAAQqU,OAAO3P,UAAU8P,OAAO;AACtD,MAAMnE,gBAAgBrQ,QAAQqU,OAAO3P,UAAU8F,OAAO;AACtD,MAAMwG,aAAahR,QAAQqU,OAAO3P,UAAU+P,IAAI;AAEhD,MAAM3S,uBAAuB9B,QAAQwC,OAAOkC,UAAUgQ,cAAc;AAEpE,MAAMrF,aAAarP,QAAQG,OAAOuE,UAAUiQ,IAAI;AAEhD,MAAMpJ,kBAAkB3K,YAAYgU,SAAS;ACxDtC,MAAMhK,SAAOc,OAAO,CACzB,KACA,QACA,WACA,WACA,QACA,WACA,SACA,SACA,KACA,OACA,OACA,OACA,SACA,cACA,QACA,MACA,UACA,UACA,WACA,UACA,QACA,QACA,OACA,YACA,WACA,QACA,YACA,MACA,aACA,OACA,WACA,OACA,UACA,OACA,OACA,MACA,MACA,WACA,MACA,YACA,cACA,UACA,QACA,UACA,QACA,MACA,MACA,MACA,MACA,MACA,MACA,QACA,UACA,UACA,MACA,QACA,KACA,OACA,SACA,OACA,OACA,SACA,UACA,MACA,QACA,OACA,QACA,WACA,QACA,YACA,SACA,OACA,QACA,MACA,YACA,UACA,UACA,KACA,WACA,OACA,YACA,KACA,MACA,MACA,QACA,KACA,QACA,UACA,WACA,UACA,UACA,QACA,SACA,UACA,UACA,QACA,UACA,UACA,SACA,OACA,WACA,OACA,SACA,SACA,MACA,YACA,YACA,SACA,MACA,SACA,QACA,MACA,SACA,MACA,KACA,MACA,OACA,SACA,KAAK,CACG;AAEH,MAAMb,QAAMa,OAAO,CACxB,OACA,KACA,YACA,eACA,gBACA,gBACA,iBACA,oBACA,UACA,YACA,QACA,QACA,WACA,gBACA,eACA,UACA,QACA,KACA,SACA,YACA,SACA,SACA,aACA,QACA,kBACA,UACA,QACA,YACA,SACA,QACA,QACA,WACA,WACA,YACA,kBACA,QACA,QACA,SACA,UACA,UACA,QACA,YACA,SACA,QACA,SACA,QACA,OAAO,CACC;AAEH,MAAMZ,aAAaY,OAAO,CAC/B,WACA,iBACA,uBACA,eACA,oBACA,qBACA,qBACA,kBACA,gBACA,WACA,WACA,WACA,WACA,WACA,kBACA,WACA,WACA,eACA,gBACA,YACA,gBACA,sBACA,eACA,UACA,cAAc,CACN;AAMH,MAAM4H,gBAAgB5H,OAAO,CAClC,WACA,iBACA,UACA,WACA,aACA,oBACA,kBACA,iBACA,iBACA,iBACA,SACA,aACA,QACA,gBACA,aACA,WACA,iBACA,UACA,OACA,cACA,WACA,KAAK,CACG;AAEH,MAAMX,WAASW,OAAO,CAC3B,QACA,YACA,UACA,WACA,SACA,UACA,MACA,cACA,iBACA,MACA,MACA,SACA,WACA,YACA,SACA,QACA,MACA,UACA,SACA,UACA,QACA,QACA,WACA,UACA,OACA,SACA,OACA,UACA,cACA,aAAa,CACL;AAIH,MAAM6H,mBAAmB7H,OAAO,CACrC,WACA,eACA,cACA,YACA,aACA,WACA,WACA,UACA,UACA,SACA,aACA,cACA,kBACA,eACA,MAAM,CACE;AAEH,MAAMoE,OAAOpE,OAAO,CAAC,OAAO,CAAU;AC1RtC,MAAMd,OAAOc,OAAO,CACzB,UACA,UACA,SACA,OACA,kBACA,gBACA,wBACA,YACA,cACA,WACA,UACA,WACA,eACA,eACA,WACA,QACA,SACA,SACA,SACA,QACA,WACA,YACA,gBACA,UACA,eACA,YACA,YACA,WACA,OACA,YACA,2BACA,yBACA,YACA,aACA,WACA,gBACA,eACA,QACA,OACA,WACA,UACA,UACA,QACA,QACA,YACA,MACA,SACA,aACA,aACA,SACA,QACA,SACA,QACA,QACA,WACA,QACA,OACA,OACA,aACA,SACA,UACA,OACA,aACA,YACA,SACA,QACA,SACA,WACA,cACA,UACA,QACA,WACA,QACA,WACA,eACA,eACA,WACA,iBACA,uBACA,UACA,WACA,WACA,cACA,YACA,OACA,YACA,OACA,YACA,QACA,QACA,WACA,cACA,SACA,YACA,SACA,QACA,SACA,QACA,QACA,WACA,SACA,OACA,UACA,QACA,SACA,WACA,YACA,SACA,aACA,QACA,UACA,UACA,SACA,SACA,QACA,SACA,MAAM,CACE;AAEH,MAAMb,MAAMa,OAAO,CACxB,iBACA,cACA,YACA,sBACA,aACA,UACA,iBACA,iBACA,WACA,iBACA,kBACA,SACA,QACA,MACA,SACA,QACA,iBACA,aACA,aACA,SACA,uBACA,+BACA,iBACA,mBACA,MACA,MACA,KACA,MACA,MACA,mBACA,aACA,WACA,WACA,OACA,YACA,aACA,OACA,YACA,QACA,gBACA,aACA,UACA,eACA,eACA,iBACA,eACA,aACA,oBACA,gBACA,cACA,gBACA,eACA,MACA,MACA,MACA,MACA,cACA,YACA,iBACA,qBACA,UACA,QACA,MACA,mBACA,MACA,OACA,aACA,KACA,MACA,MACA,MACA,MACA,WACA,aACA,cACA,YACA,QACA,gBACA,kBACA,gBACA,oBACA,kBACA,SACA,cACA,cACA,gBACA,gBACA,eACA,eACA,oBACA,aACA,OACA,QACA,aACA,SACA,UACA,QACA,OACA,QACA,cACA,UACA,YACA,WACA,SACA,UACA,eACA,UACA,YACA,eACA,QACA,cACA,uBACA,oBACA,gBACA,UACA,iBACA,uBACA,kBACA,KACA,MACA,MACA,UACA,QACA,QACA,eACA,aACA,WACA,UACA,UACA,SACA,QACA,mBACA,SACA,oBACA,oBACA,gBACA,eACA,gBACA,eACA,cACA,gBACA,oBACA,qBACA,kBACA,mBACA,qBACA,kBACA,UACA,gBACA,SACA,gBACA,kBACA,YACA,eACA,WACA,WACA,aACA,oBACA,eACA,mBACA,kBACA,cACA,QACA,MACA,MACA,WACA,UACA,WACA,cACA,WACA,cACA,iBACA,iBACA,SACA,gBACA,QACA,gBACA,oBACA,oBACA,KACA,MACA,MACA,SACA,KACA,MACA,MACA,KACA,YAAY,CACJ;AAEH,MAAMX,SAASW,OAAO,CAC3B,UACA,eACA,SACA,YACA,SACA,gBACA,eACA,cACA,cACA,SACA,OACA,WACA,gBACA,YACA,SACA,SACA,UACA,QACA,MACA,WACA,UACA,iBACA,UACA,UACA,kBACA,aACA,YACA,eACA,WACA,WACA,iBACA,YACA,YACA,QACA,YACA,YACA,cACA,WACA,UACA,UACA,eACA,iBACA,wBACA,aACA,aACA,cACA,YACA,kBACA,kBACA,aACA,WACA,SACA,OAAO,CACR;AAEM,MAAM8H,MAAM9H,OAAO,CACxB,cACA,UACA,eACA,aACA,aAAa,CACL;ACpXH,MAAM5F,gBAAgBiB,KAAK,2BAA2B;AACtD,MAAMhB,WAAWgB,KAAK,uBAAuB;AAC7C,MAAMf,cAAce,KAAK,eAAe;AACxC,MAAMd,YAAYc,KAAK,8BAA8B;AACrD,MAAMb,YAAYa,KAAK,gBAAgB;AACvC,MAAMR,iBAAiBQ;QAC5B;;;AAEK,MAAMZ,oBAAoBY,KAAK,uBAAuB;AACtD,MAAMX,kBAAkBW;QAC7B;;;AAEK,MAAM0M,eAAe1M,KAAK,SAAS;AACnC,MAAMV,iBAAiBU,KAAK,0BAA0B;;;;;;;;;;;;;;ACsB7D,MAAMpD,YAAY;QAChBnC,SAAS;QACTkL,WAAW;QACXoD,MAAM;QACN+E,cAAc;QACdC,iBAAiB;;QACjBC,YAAY;;QACZzF,wBAAwB;QACxBC,SAAS;QACT9L,UAAU;QACVuR,cAAc;QACdC,kBAAkB;QAClBC,UAAU;;;AAGZ,MAAM/R,YAAY,SAAZA,aAAY;AAChB,eAAO,OAAOF,WAAW,cAAc,OAAOA;MAChD;AAUA,MAAMwI,4BAA4B,SAA5BA,2BACJjH,cACA2Q,mBAAoC;AAEpC,YACE,OAAO3Q,iBAAiB,YACxB,OAAOA,a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","names":["unapply","func","thisArg","RegExp","lastIndex","_len3","arguments","length","args","Array","_key3","apply","unconstruct","Func","_len4","_key4","construct","addToSet","set","array","transformCaseFunc","stringToLowerCase","setPrototypeOf","l","element","lcElement","isFrozen","cleanArray","index","isPropertyExist","objectHasOwnProperty","clone","object","newObject","create","property","value","entries","isArray","constructor","Object","lookupGetter","prop","desc","getOwnPropertyDescriptor","get","getPrototypeOf","fallbackValue","createDOMPurify","window","undefined","getGlobal","DOMPurify","root","version","VERSION","removed","document","nodeType","NODE_TYPE","Element","isSupported","originalDocument","currentScript","DocumentFragment","HTMLTemplateElement","Node","NodeFilter","NamedNodeMap","MozNamedAttrMap","HTMLFormElement","DOMParser","trustedTypes","ElementPrototype","prototype","cloneNode","remove","getNextSibling","getChildNodes","getParentNode","template","createElement","content","ownerDocument","trustedTypesPolicy","emptyHTML","implementation","createNodeIterator","createDocumentFragment","getElementsByTagName","importNode","hooks","_createHooksMap","createHTMLDocument","MUSTACHE_EXPR","ERB_EXPR","TMPLIT_EXPR","DATA_ATTR","ARIA_ATTR","IS_SCRIPT_OR_DATA","ATTR_WHITESPACE","CUSTOM_ELEMENT","EXPRESSIONS","IS_ALLOWED_URI","ALLOWED_TAGS","DEFAULT_ALLOWED_TAGS","TAGS","ALLOWED_ATTR","DEFAULT_ALLOWED_ATTR","ATTRS","CUSTOM_ELEMENT_HANDLING","seal","tagNameCheck","writable","configurable","enumerable","attributeNameCheck","allowCustomizedBuiltInElements","FORBID_TAGS","FORBID_ATTR","EXTRA_ELEMENT_HANDLING","tagCheck","attributeCheck","ALLOW_ARIA_ATTR","ALLOW_DATA_ATTR","ALLOW_UNKNOWN_PROTOCOLS","ALLOW_SELF_CLOSE_IN_ATTR","SAFE_FOR_TEMPLATES","SAFE_FOR_XML","WHOLE_DOCUMENT","SET_CONFIG","FORCE_BODY","RETURN_DOM","RETURN_DOM_FRAGMENT","RETURN_TRUSTED_TYPE","SANITIZE_DOM","SANITIZE_NAMED_PROPS","SANITIZE_NAMED_PROPS_PREFIX","KEEP_CONTENT","IN_PLACE","USE_PROFILES","FORBID_CONTENTS","DEFAULT_FORBID_CONTENTS","DATA_URI_TAGS","DEFAULT_DATA_URI_TAGS","URI_SAFE_ATTRIBUTES","DEFAULT_URI_SAFE_ATTRIBUTES","MATHML_NAMESPACE","SVG_NAMESPACE","HTML_NAMESPACE","NAMESPACE","IS_EMPTY_INPUT","ALLOWED_NAMESPACES","DEFAULT_ALLOWED_NAMESPACES","stringToString","MATHML_TEXT_INTEGRATION_POINTS","HTML_INTEGRATION_POINTS","COMMON_SVG_AND_HTML_ELEMENTS","PARSER_MEDIA_TYPE","SUPPORTED_PARSER_MEDIA_TYPES","DEFAULT_PARSER_MEDIA_TYPE","CONFIG","formElement","isRegexOrFunction","testValue","Function","_parseConfig","cfg","indexOf","ADD_URI_SAFE_ATTR","ADD_DATA_URI_TAGS","ALLOWED_URI_REGEXP","html","svg","svgFilters","mathMl","ADD_TAGS","ADD_ATTR","ADD_FORBID_CONTENTS","table","tbody","TRUSTED_TYPES_POLICY","createHTML","typeErrorCreate","createScriptURL","_createTrustedTypesPolicy","freeze","ALL_SVG_TAGS","ALL_MATHML_TAGS","_checkValidNamespace","parent","tagName","namespaceURI","parentTagName","Boolean","_forceRemove","node","arrayPush","removeChild","_","_removeAttribute","name","attribute","getAttributeNode","from","removeAttribute","setAttribute","_initDocument","dirty","doc","leadingWhitespace","matches","stringMatch","dirtyPayload","parseFromString","documentElement","createDocument","innerHTML","body","insertBefore","createTextNode","childNodes","call","_createNodeIterator","SHOW_ELEMENT","SHOW_COMMENT","SHOW_TEXT","SHOW_PROCESSING_INSTRUCTION","SHOW_CDATA_SECTION","_isClobbered","nodeName","textContent","attributes","hasChildNodes","_isNode","_executeHooks","currentNode","data","arrayForEach","hook","_sanitizeElements","beforeSanitizeElements","uponSanitizeElement","allowedTags","firstElementChild","regExpTest","progressingInstruction","comment","_isBasicCustomElement","parentNode","childCount","i","childClone","__removalCount","text","expr","stringReplace","afterSanitizeElements","_isValidAttribute","lcTag","lcName","stringIndexOf","_sanitizeAttributes","beforeSanitizeAttributes","hookEvent","attrName","attrValue","keepAttr","allowedAttributes","forceKeepAttr","attr","initValue","stringTrim","uponSanitizeAttribute","getAttributeType","setAttributeNS","arrayPop","afterSanitizeAttributes","_sanitizeShadowDOM","fragment","shadowNode","shadowIterator","beforeSanitizeShadowDOM","nextNode","uponSanitizeShadowNode","afterSanitizeShadowDOM","sanitize","importedNode","returnNode","toString","appendChild","firstChild","nodeIterator","shadowroot","shadowrootmode","serializedHTML","outerHTML","doctype","setConfig","clearConfig","isValidAttribute","tag","addHook","entryPoint","hookFunction","removeHook","arrayLastIndexOf","arraySplice","removeHooks","removeAllHooks","svgDisallowed","mathMlDisallowed","xml","DOCTYPE_NAME","Reflect","x","_len","_key","_len2","_key2","forEach","lastIndexOf","pop","push","splice","String","toLowerCase","match","replace","trim","hasOwnProperty","test","TypeError","cdataSection","entityReference","entityNode","documentType","documentFragment","notation","purifyHostElement","createPolicy","suffix","ATTR_NAME","hasAttribute","getAttribute","policyName","scriptUrl","console","warn","html","clone","input","makeButton","makeSelect","makeGroup","makeSep","apply","err","newRange","li","list","getMarkedAncestors","parent","_a","_b","_c","clone"]}