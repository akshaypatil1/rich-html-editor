{"version":3,"sources":["../src/core/events.ts","../src/core/constants.ts","../src/utils/sanitize.ts","../src/core/state.ts"],"sourcesContent":["import type { EditorEventType, EditorEvent, EditorEventHandler } from \"./types\";\r\n\r\nexport class EditorEventEmitter {\r\n  private listeners: Map<EditorEventType, Set<EditorEventHandler>> = new Map();\r\n\r\n  on(type: EditorEventType, handler: EditorEventHandler): () => void {\r\n    if (!this.listeners.has(type)) {\r\n      this.listeners.set(type, new Set());\r\n    }\r\n    this.listeners.get(type)!.add(handler);\r\n    return () => this.off(type, handler);\r\n  }\r\n\r\n  once(type: EditorEventType, handler: EditorEventHandler): void {\r\n    const unsubscribe = this.on(type, (event) => {\r\n      handler(event);\r\n      unsubscribe();\r\n    });\r\n  }\r\n\r\n  off(type: EditorEventType, handler: EditorEventHandler): void {\r\n    const handlers = this.listeners.get(type);\r\n    if (handlers) {\r\n      handlers.delete(handler);\r\n      if (handlers.size === 0) this.listeners.delete(type);\r\n    }\r\n  }\r\n\r\n  emit(event: EditorEvent): void {\r\n    const handlers = this.listeners.get(event.type);\r\n    if (handlers) {\r\n      handlers.forEach((handler) => {\r\n        try {\r\n          handler(event);\r\n        } catch (error) {\r\n          console.error(\r\n            `[rich-html-editor] Error in event handler for ${event.type}:`,\r\n            error\r\n          );\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  removeAllListeners(type?: EditorEventType): void {\r\n    if (type) this.listeners.delete(type);\r\n    else this.listeners.clear();\r\n  }\r\n\r\n  listenerCount(type: EditorEventType): number {\r\n    return this.listeners.get(type)?.size ?? 0;\r\n  }\r\n}\r\n\r\nexport const editorEventEmitter = new EditorEventEmitter();\r\n\r\nexport function getEditorEventEmitter(): EditorEventEmitter {\r\n  return editorEventEmitter;\r\n}\r\n","// Shared constants for the rich-html-editor (moved to core)\r\nexport const TOOLBAR_ID = \"editor-toolbar\";\r\nexport const STYLE_ID = \"editor-styles\";\r\nexport const CLASS_EDITABLE = \"editor-editable-element\";\r\nexport const CLASS_ACTIVE = \"editor-active-element\";\r\n\r\n// Default undo/redo stack size\r\nexport const DEFAULT_MAX_STACK = 60;\r\n\r\n// Toolbar styling constants\r\nexport const TOOLBAR_BG = \"#f8fafc\";\r\nexport const TOOLBAR_BORDER = \"#e5e7eb\";\r\nexport const BUTTON_BORDER = \"#d1d5db\";\r\nexport const BUTTON_ACTIVE_BG = \"#e0e7ff\";\r\nexport const BUTTON_BG = \"#fff\";\r\nexport const BUTTON_COLOR = \"#222\";\r\nexport const INFO_COLOR = \"#888\";\r\n\r\n// Outline colors used by injected styles\r\nexport const HOVER_OUTLINE = \"#2563eb\";\r\nexport const ACTIVE_OUTLINE = \"#16a34a\";\r\n","import createDOMPurify from \"dompurify\";\r\n\r\n/**\r\n * Sanitize HTML using DOMPurify.\r\n *\r\n * Works in browser and in jsdom (tests) by accepting either a `Window`\r\n * or a `Document` (from which `defaultView` is used).\r\n */\r\nexport function sanitizeHtml(\r\n  html: string,\r\n  ctx?: Window | Document | null\r\n): string {\r\n  if (!html) return \"\";\r\n  // Try to get a Window reference\r\n  let win: Window | null = null;\r\n  if (ctx && (ctx as Document).defaultView) {\r\n    win = (ctx as Document).defaultView as Window;\r\n  } else if (ctx && (ctx as Window).document) {\r\n    win = ctx as Window;\r\n  } else if (typeof window !== \"undefined\") {\r\n    win = window as Window;\r\n  }\r\n\r\n  // If we have a window, use DOMPurify\r\n  if (win) {\r\n    try {\r\n      const DOMPurify = createDOMPurify(win as any);\r\n      return DOMPurify.sanitize(html, {\r\n        // Use sensible defaults: allow common formatting tags but strip scripts\r\n        ALLOWED_TAGS: [\r\n          \"a\",\r\n          \"b\",\r\n          \"i\",\r\n          \"em\",\r\n          \"strong\",\r\n          \"u\",\r\n          \"p\",\r\n          \"div\",\r\n          \"span\",\r\n          \"ul\",\r\n          \"ol\",\r\n          \"li\",\r\n          \"br\",\r\n          \"hr\",\r\n          \"blockquote\",\r\n          \"pre\",\r\n          \"code\",\r\n          \"h1\",\r\n          \"h2\",\r\n          \"h3\",\r\n          \"h4\",\r\n          \"h5\",\r\n          \"h6\",\r\n          \"img\",\r\n        ],\r\n        ALLOWED_ATTR: [\"href\", \"title\", \"alt\", \"src\", \"class\", \"style\"],\r\n      });\r\n    } catch (e) {\r\n      // If DOMPurify initialization fails, fall through to minimal stripping\r\n    }\r\n  }\r\n\r\n  // Minimal fallback: remove <script> tags and on* attributes\r\n  return html\r\n    .replace(/<script[\\s\\S]*?>[\\s\\S]*?<\\/script>/gi, \"\")\r\n    .replace(/on[a-z]+=\\\"[^\"]*\\\"/gi, \"\");\r\n}\r\n\r\nexport default sanitizeHtml;\r\n","import { editorEventEmitter } from \"./events\";\r\nimport { DEFAULT_MAX_STACK } from \"./constants\";\r\nimport { sanitizeHtml } from \"../utils/sanitize\";\r\n\r\nlet _doc: Document | null = null;\r\nlet _undoStack: string[] = [];\r\nlet _redoStack: string[] = [];\r\nlet _currentEditable: HTMLElement | null = null;\r\nlet _maxStackSize = DEFAULT_MAX_STACK;\r\n\r\nexport function _setDoc(doc: Document | null) {\r\n  _doc = doc;\r\n}\r\nexport function _getDoc() {\r\n  return _doc;\r\n}\r\nexport function _setUndoStack(stack: string[]) {\r\n  _undoStack = stack;\r\n  editorEventEmitter.emit({\r\n    type: \"undoStateChanged\",\r\n    timestamp: Date.now(),\r\n    data: { canUndo: _undoStack.length > 1 },\r\n  });\r\n}\r\nexport function _getUndoStack() {\r\n  return _undoStack;\r\n}\r\nexport function _setRedoStack(stack: string[]) {\r\n  _redoStack = stack;\r\n  editorEventEmitter.emit({\r\n    type: \"redoStateChanged\",\r\n    timestamp: Date.now(),\r\n    data: { canRedo: _redoStack.length > 0 },\r\n  });\r\n}\r\nexport function _getRedoStack() {\r\n  return _redoStack;\r\n}\r\nexport function _setCurrentEditable(el: HTMLElement | null) {\r\n  _currentEditable = el;\r\n  editorEventEmitter.emit({\r\n    type: \"selectionChanged\",\r\n    timestamp: Date.now(),\r\n    data: { element: el?.tagName },\r\n  });\r\n}\r\nexport function _getCurrentEditable() {\r\n  return _currentEditable;\r\n}\r\nexport function pushStandaloneSnapshot(clearRedo = true) {\r\n  if (!_doc) return;\r\n  const snapRaw = _doc.documentElement.outerHTML;\r\n  const snap = sanitizeHtml(snapRaw, _doc);\r\n  if (!_undoStack.length || _undoStack[_undoStack.length - 1] !== snap) {\r\n    _undoStack.push(snap);\r\n    if (_undoStack.length > _maxStackSize) _undoStack.shift();\r\n    editorEventEmitter.emit({\r\n      type: \"contentChanged\",\r\n      timestamp: Date.now(),\r\n      data: { htmlLength: snap.length },\r\n    });\r\n  }\r\n  if (clearRedo) {\r\n    _redoStack = [];\r\n    editorEventEmitter.emit({\r\n      type: \"redoStateChanged\",\r\n      timestamp: Date.now(),\r\n      data: { canRedo: false },\r\n    });\r\n  }\r\n}\r\nexport function setMaxStackSize(size: number) {\r\n  _maxStackSize = Math.max(1, size);\r\n}\r\n"],"mappings":"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","names":[]}