{"version":3,"sources":["../src/dom/styles.ts","../src/dom/root.ts","../src/toolbar/color.ts","../src/toolbar/overflow.ts","../src/toolbar/buttons.ts","../src/toolbar/selects.ts","../src/toolbar/navigation.ts","../src/toolbar/render.ts","../src/dom/candidates.ts","../src/dom/imageEditor.ts","../src/dom/format.ts","../src/core/sanitizeURL.ts","../src/core/history.ts","../src/core/formatActions.ts","../src/dom/handlers.ts","../src/core/editor.ts","../src/RichHtmlEditor.ts"],"sourcesContent":["/**\n * Inject CSS styles into the document for editor UI\n *\n * Adds styling for:\n * - `.editor-editable-element`: Dashed outline for hoverable elements\n * - `.editor-active-element`: Solid green outline for active editing element\n *\n * Uses a style ID to prevent duplicate injections\n *\n * @param doc - Document to inject styles into\n */\nimport {\n  STYLE_ID,\n  CLASS_EDITABLE,\n  CLASS_ACTIVE,\n  HOVER_OUTLINE,\n  ACTIVE_OUTLINE,\n  TOOLBAR_ID,\n  TOOLBAR_BG,\n  TOOLBAR_BORDER,\n  BUTTON_BORDER,\n  BUTTON_ACTIVE_BG,\n  BUTTON_BG,\n  BUTTON_COLOR,\n  INFO_COLOR,\n} from \"../core/constants\";\n\nexport function injectStyles(doc: Document): void {\n  const styleId = STYLE_ID;\n  let styleEl = doc.getElementById(styleId) as HTMLStyleElement | null;\n  const css = `\n/* Scoped conservative reset for editor UI root to prevent template styles leaking in */\n#rhe-editor-root {\n  box-sizing: border-box;\n  font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n  font-size: 14px;\n  line-height: 1.5;\n  color: #0f172a;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n#rhe-editor-root *,\n#rhe-editor-root *::before,\n#rhe-editor-root *::after {\n  box-sizing: inherit;\n}\n/* Restore user-agent defaults for native controls inside the root */\n#rhe-editor-root button,\n#rhe-editor-root input,\n#rhe-editor-root textarea,\n#rhe-editor-root select {\n  all: revert;\n  font: inherit;\n  color: inherit;\n  background: transparent;\n  border: none;\n  padding: 0;\n  margin: 0;\n}\n/* Basic focus visibility for accessibility inside root */\n#rhe-editor-root :focus {\n  outline: 2px solid Highlight;\n  outline-offset: 2px;\n}\n\n.${CLASS_EDITABLE}{outline:2px dashed ${HOVER_OUTLINE};cursor:text}\n.${CLASS_ACTIVE}{outline:2px solid ${ACTIVE_OUTLINE};cursor:text}\n#${TOOLBAR_ID} img{cursor:auto}\n/* Make images inside editable regions show a pointer to indicate click/edit */\n.${CLASS_EDITABLE} img, .${CLASS_ACTIVE} img { cursor: pointer; }\n#${TOOLBAR_ID}{\n  position: sticky;\n  top: 0;\n  left: 0;\n  right: 0;\n  z-index: 9999;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 8px 12px;\n  background: ${TOOLBAR_BG};\n  border-bottom: 1px solid ${TOOLBAR_BORDER};\n  font-family: inherit;\n  box-shadow: 0 6px 18px rgba(2,6,23,0.08);\n  backdrop-filter: blur(6px);\n  /* Allow toolbar items to wrap onto multiple lines on narrow screens */\n  flex-wrap: wrap;\n  justify-content: flex-start;\n}\n#${TOOLBAR_ID} button{\n  padding: 6px 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: ${BUTTON_BG};\n  color: ${BUTTON_COLOR};\n  border-radius: 8px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;\n  outline: none;\n  margin-right: 2px;\n}\n#${TOOLBAR_ID} button[aria-pressed=\"true\"]{\n  background: ${BUTTON_ACTIVE_BG};\n  font-weight: 600;\n  box-shadow: 0 6px 12px rgba(99,102,241,0.12);\n}\n#${TOOLBAR_ID} button:hover:not(:disabled){\n  transform: translateY(-2px);\n  box-shadow: 0 8px 20px rgba(2,6,23,0.08);\n}\n#${TOOLBAR_ID} select{\n  padding: 6px 8px;\n  border-radius: 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: #fff;\n  font-family: inherit;\n}\n#${TOOLBAR_ID} input[type=\"color\"]{\n  border-radius: 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: #fff;\n  font-family: inherit;\n}\n#${TOOLBAR_ID} .color-input-label{\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  padding: 0;\n  background: transparent;\n  border: none;\n}\n\n/* Labeled color inputs (e.g. \"Text Color <input type=color>\") */\n#${TOOLBAR_ID} .color-label{\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  padding: 0;\n  background: transparent;\n  border: none;\n}\n#${TOOLBAR_ID} .color-input-label .color-icon{\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n}\n#${TOOLBAR_ID} .text-color-icon{\n  font-weight: 700;\n  font-size: 14px;\n  line-height: 1;\n  display: inline-block;\n  padding-bottom: 2px;\n  border-bottom: 3px solid currentColor;\n  transform-origin: center;\n}\n#${TOOLBAR_ID} .highlight-icon{\n  width: 16px;\n  height: 16px;\n  display: inline-block;\n}\n#${TOOLBAR_ID} .color-icon svg{\n  width: 16px;\n  height: 16px;\n  display: block;\n}\n/* Text color wrapper: A with a small swatch on the right */\n#${TOOLBAR_ID} .text-color-wrapper{\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n}\n#${TOOLBAR_ID} .text-color-wrapper .text-A{\n  font-weight: 700;\n  font-size: 14px;\n  line-height: 1;\n}\n#${TOOLBAR_ID} .text-color-wrapper .color-swatch{\n  width: 12px;\n  height: 12px;\n  border-radius: 3px;\n  border: 1px solid rgba(0,0,0,0.12);\n  box-shadow: 0 1px 0 rgba(255,255,255,0.5) inset;\n  background: currentColor;\n}\n\n/* Highlight wrapper: small colored bar under/behind the A to mimic highlighter */\n#${TOOLBAR_ID} .highlight-wrapper{\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n  position: relative;\n}\n#${TOOLBAR_ID} .highlight-wrapper .highlight-bar{\n  position: absolute;\n  left: 0;\n  right: 0;\n  bottom: 2px;\n  height: 8px;\n  border-radius: 3px;\n  background: #ffeb3b; /* default yellow */\n  z-index: 0;\n}\n#${TOOLBAR_ID} .highlight-wrapper .text-A{\n  position: relative;\n  z-index: 1;\n  font-weight: 700;\n  font-size: 14px;\n  line-height: 1;\n  padding: 0 4px;\n}\n#${TOOLBAR_ID} span{\n  color: ${INFO_COLOR};\n  font-size: 90%;\n}\n\n/* Grouping and separators */\n#${TOOLBAR_ID} .toolbar-group{\n  display: flex;\n  align-items: center;\n  gap: 6px;\n}\n#${TOOLBAR_ID} .toolbar-group{\n  /* groups may wrap internally to avoid overflow on narrow screens */\n  flex-wrap: wrap;\n}\n/* Overflow button + menu styling */\n#${TOOLBAR_ID} .toolbar-overflow-btn{\n  display: none;\n  align-items: center;\n  justify-content: center;\n  padding: 6px 8px;\n  border-radius: 8px;\n  border: 1px solid ${BUTTON_BORDER};\n  background: ${BUTTON_BG};\n  color: ${BUTTON_COLOR};\n  font-weight: 600;\n}\n#${TOOLBAR_ID} .toolbar-overflow-menu{\n  position: absolute;\n  top: calc(100% + 6px);\n  right: 12px;\n  min-width: 160px;\n  background: #fff;\n  border: 1px solid rgba(15,23,42,0.06);\n  border-radius: 8px;\n  padding: 8px;\n  box-shadow: 0 12px 40px rgba(2,6,23,0.12);\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n  z-index: 10000;\n}\n#${TOOLBAR_ID} .toolbar-overflow-menu[hidden]{\n  display: none;\n}\n#${TOOLBAR_ID} .toolbar-sep{\n  width: 1px;\n  height: 28px;\n  background: rgba(15,23,42,0.06);\n  margin: 0 8px;\n  border-radius: 1px;\n}\n#${TOOLBAR_ID} .toolbar-spacer{\n  flex: 1 1 auto;\n}\n#${TOOLBAR_ID} button svg{\n  width: 16px;\n  height: 16px;\n  display: block;\n  /* Default icon appearance */\n  fill: none;\n}\n\n/* Active/pressed: switch to filled appearance */\n#${TOOLBAR_ID} button[aria-pressed=\"true\"] svg{\n  fill: currentColor;\n}\n\n/* Focus and accessibility */\n#${TOOLBAR_ID} button:focus{\n  outline: none;\n  box-shadow: 0 0 0 4px rgba(99,102,241,0.12);\n}\n\n/* Disabled state */\n#${TOOLBAR_ID} button:disabled{\n  opacity: 0.48;\n  cursor: not-allowed;\n}\n/* Responsive tweaks: reduce spacing and allow horizontal scroll on very small screens */\n@media (max-width: 720px){\n  #${TOOLBAR_ID}{\n    padding: 6px 8px;\n    gap: 6px;\n  }\n  #${TOOLBAR_ID} button,\n  #${TOOLBAR_ID} select,\n  #${TOOLBAR_ID} input[type=\"color\"]{\n    padding: 4px 6px;\n    border-radius: 6px;\n  }\n  /* Hide visual separators to save horizontal space */\n  #${TOOLBAR_ID} .toolbar-sep{\n    display: none;\n  }\n  /* Collapse labeled color text visually but preserve accessibility on the input */\n  #${TOOLBAR_ID} .color-label{\n    font-size: 0;\n  }\n  #${TOOLBAR_ID} .color-label input{\n    font-size: initial;\n  }\n}\n@media (max-width: 420px){\n  /* On very small screens prefer a single-line scrollable toolbar */\n  #${TOOLBAR_ID}{\n    flex-wrap: nowrap;\n    overflow-x: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n  #${TOOLBAR_ID} .toolbar-group{\n    flex: 0 0 auto;\n  }\n  #${TOOLBAR_ID} button{ margin-right: 6px; }\n  /* Show overflow button and hide the groups marked for collapse */\n  #${TOOLBAR_ID} .toolbar-overflow-btn{\n    display: inline-flex;\n  }\n  #${TOOLBAR_ID} .collapse-on-small{\n    display: none;\n  }\n}\n/* Image editor modal */\n.rhe-img-modal-overlay{\n  position: fixed;\n  inset: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(2,6,23,0.48);\n  z-index: 11000;\n}\n.rhe-img-modal{\n  background: #fff;\n  border-radius: 12px;\n  padding: 16px;\n  width: 360px;\n  max-width: calc(100% - 24px);\n  box-shadow: 0 24px 60px rgba(2,6,23,0.28);\n  font-family: inherit;\n}\n.rhe-img-modal h3{ margin: 0 0 8px 0; font-size: 16px }\n.rhe-img-tabs{ display: flex; gap: 8px; margin-bottom: 12px }\n.rhe-img-tabs button{ padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(15,23,42,0.06); background: #fff }\n.rhe-img-tabs button.active{ background: #f3f4ff }\n.rhe-img-pane{ margin-bottom: 12px }\n.rhe-img-pane input[type=\"file\"], .rhe-img-pane input[type=\"url\"]{ width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(15,23,42,0.06) }\n.rhe-img-msg{ color: #b91c1c; font-size: 13px; min-height: 18px; margin-top: 8px }\n.rhe-img-actions{ display:flex; gap:8px; justify-content:flex-end }\n.rhe-img-actions button{ padding: 8px 12px; border-radius: 8px }\n.rhe-img-actions button.primary{ background: #6366f1; color: #fff; border: none }\n\n`;\n  if (!styleEl) {\n    styleEl = doc.createElement(\"style\");\n    styleEl.id = styleId;\n    doc.head.appendChild(styleEl);\n  }\n  styleEl.textContent = css;\n}\n","export const EDITOR_ROOT_ID = \"rhe-editor-root\";\n\n/**\n * Ensure an editor root container exists in the given document and return it.\n * If not present, create it and insert as the first child of body.\n */\nexport function getEditorRoot(doc: Document): HTMLElement {\n  let root = doc.getElementById(EDITOR_ROOT_ID) as HTMLElement | null;\n  if (root) return root;\n\n  root = doc.createElement(\"div\");\n  root.id = EDITOR_ROOT_ID;\n  // Safe defaults: allow the page to position/size the root; library CSS will scope under it\n  root.setAttribute(\"data-rhe-root\", \"true\");\n  try {\n    if (doc.body && doc.body.firstChild)\n      doc.body.insertBefore(root, doc.body.firstChild);\n    else if (doc.body) doc.body.appendChild(root);\n    else doc.documentElement.appendChild(root);\n  } catch (e) {\n    // best-effort: if insertion fails, fallback to appending to documentElement\n    try {\n      doc.documentElement.appendChild(root);\n    } catch (err) {\n      /* ignore */\n    }\n  }\n  return root;\n}\n","export function makeColorInput(\n  doc: Document,\n  options: { onCommand: (command: string, value?: string) => void },\n  title: string,\n  command: string,\n  initialColor?: string,\n) {\n  const input = doc.createElement(\"input\");\n  input.type = \"color\";\n  input.className = \"toolbar-color-input\";\n  const wrapper = doc.createElement(\"label\");\n  wrapper.className = \"color-label\";\n  wrapper.appendChild(doc.createTextNode(title + \" \"));\n  wrapper.appendChild(input);\n  let savedRange: Range | null = null;\n  input.addEventListener(\"pointerdown\", () => {\n    const s = doc.getSelection();\n    if (s && s.rangeCount) savedRange = s.getRangeAt(0).cloneRange();\n  });\n  input.onchange = (e: Event) => {\n    try {\n      const s = doc.getSelection();\n      if (savedRange && s) {\n        s.removeAllRanges();\n        s.addRange(savedRange);\n      }\n    } catch (err) {\n      /* ignore */\n    }\n    options.onCommand(command, (e.target as HTMLInputElement).value);\n    savedRange = null;\n  };\n\n  function rgbToHex(input?: string | null): string | null {\n    if (!input) return null;\n    const v = input.trim();\n    if (v.startsWith(\"#\")) {\n      if (v.length === 4) {\n        return (\"#\" + v[1] + v[1] + v[2] + v[2] + v[3] + v[3]).toLowerCase();\n      }\n      return v.toLowerCase();\n    }\n    const rgbMatch = v.match(/rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)/i);\n    if (rgbMatch) {\n      const r = Number(rgbMatch[1]);\n      const g = Number(rgbMatch[2]);\n      const b = Number(rgbMatch[3]);\n      const hex =\n        \"#\" +\n        [r, g, b]\n          .map((n) => n.toString(16).padStart(2, \"0\"))\n          .join(\"\")\n          .toLowerCase();\n      return hex;\n    }\n    return null;\n  }\n\n  const setColor = (val?: string) => {\n    if (!val) return;\n    const hex = rgbToHex(val) || val;\n    try {\n      if (\n        hex &&\n        hex.startsWith(\"#\") &&\n        (input as HTMLInputElement).value !== hex\n      ) {\n        (input as HTMLInputElement).value = hex;\n      }\n    } catch (e) {\n      /* ignore */\n    }\n  };\n\n  if (initialColor) setColor(initialColor);\n  input.addEventListener(\"input\", (e: Event) => {\n    const val = (e.target as HTMLInputElement).value;\n    setColor(val);\n  });\n  input.title = title;\n  input.setAttribute(\"aria-label\", title);\n  return wrapper;\n}\n","export function setupOverflow(\n  doc: Document,\n  toolbar: HTMLElement,\n  options: {\n    onCommand: (command: string, value?: string) => void;\n    onUndo: () => void;\n    onRedo: () => void;\n    canUndo: () => boolean;\n    canRedo: () => boolean;\n  },\n  format: any,\n  helpers: {\n    makeSelect: (\n      title: string,\n      command: string,\n      optionsList: { label: string; value: string }[],\n      initialValue?: string | null,\n    ) => HTMLElement;\n    makeColorInput: (\n      title: string,\n      command: string,\n      initialColor?: string,\n    ) => HTMLElement;\n    makeButton: (\n      label: string,\n      title: string,\n      command: string,\n      value?: string,\n      isActive?: boolean,\n      disabled?: boolean,\n    ) => HTMLElement;\n    makeGroup: () => HTMLElement;\n  },\n) {\n  const overflowBtn = doc.createElement(\"button\");\n  overflowBtn.type = \"button\";\n  overflowBtn.className = \"toolbar-overflow-btn\";\n  overflowBtn.title = \"More\";\n  overflowBtn.setAttribute(\"aria-label\", \"More toolbar actions\");\n  overflowBtn.setAttribute(\"aria-haspopup\", \"true\");\n  overflowBtn.setAttribute(\"aria-expanded\", \"false\");\n  overflowBtn.tabIndex = 0;\n  overflowBtn.innerHTML = \"⋯\";\n\n  const overflowMenu = doc.createElement(\"div\");\n  overflowMenu.className = \"toolbar-overflow-menu\";\n  overflowMenu.setAttribute(\"role\", \"menu\");\n  overflowMenu.hidden = true;\n\n  function openOverflow() {\n    overflowMenu.hidden = false;\n    overflowBtn.setAttribute(\"aria-expanded\", \"true\");\n    const first = overflowMenu.querySelector<HTMLElement>(\n      \"button, select, input\",\n    );\n    first?.focus();\n  }\n  function closeOverflow() {\n    overflowMenu.hidden = true;\n    overflowBtn.setAttribute(\"aria-expanded\", \"false\");\n    overflowBtn.focus();\n  }\n\n  overflowBtn.addEventListener(\"click\", () => {\n    if (overflowMenu.hidden) openOverflow();\n    else closeOverflow();\n  });\n  overflowBtn.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n    if (e.key === \"Enter\" || e.key === \" \") {\n      e.preventDefault();\n      if (overflowMenu.hidden) openOverflow();\n      else closeOverflow();\n    }\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      if (overflowMenu.hidden) openOverflow();\n    }\n  });\n\n  overflowMenu.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n    if (e.key === \"Escape\") {\n      e.preventDefault();\n      closeOverflow();\n    }\n  });\n  doc.addEventListener(\"pointerdown\", (ev: PointerEvent) => {\n    if (\n      !overflowMenu.hidden &&\n      !overflowMenu.contains(ev.target as Node) &&\n      ev.target !== overflowBtn\n    ) {\n      closeOverflow();\n    }\n  });\n\n  // Populate overflow menu with duplicates of the collapsed controls\n  overflowMenu.appendChild(\n    helpers.makeSelect(\n      \"Format\",\n      \"formatBlock\",\n      (window as any).RHE_FORMAT_OPTIONS || [],\n      (format as any).formatBlock,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeSelect(\n      \"Font\",\n      \"fontName\",\n      (window as any).RHE_FONT_OPTIONS || [],\n      (format as any).fontName,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeSelect(\n      \"Size\",\n      \"fontSize\",\n      (window as any).RHE_SIZE_OPTIONS || [],\n      (format as any).fontSize,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeColorInput(\n      \"Text color\",\n      \"foreColor\",\n      (format as any).foreColor,\n    ),\n  );\n  overflowMenu.appendChild(\n    helpers.makeColorInput(\n      \"Highlight color\",\n      \"hiliteColor\",\n      (format as any).hiliteColor,\n    ),\n  );\n  overflowMenu.appendChild(helpers.makeButton(\"Link\", \"Insert link\", \"link\"));\n\n  const overflowWrap = helpers.makeGroup();\n  overflowWrap.className = \"toolbar-group toolbar-overflow-wrap\";\n  overflowWrap.appendChild(overflowBtn);\n  overflowWrap.appendChild(overflowMenu);\n  toolbar.appendChild(overflowWrap);\n}\n","import { _saveSelection, _restoreSelection } from \"../core/state\";\n\nexport function makeButton(\n  doc: Document,\n  options: { onCommand: (command: string, value?: string) => void },\n  label: string,\n  title: string,\n  command: string,\n  value?: string,\n  isActive?: boolean,\n  disabled?: boolean,\n) {\n  const btn = doc.createElement(\"button\");\n  btn.type = \"button\";\n  if (label && label.trim().startsWith(\"<\")) {\n    btn.innerHTML = label;\n  } else {\n    btn.textContent = label;\n  }\n  btn.title = title;\n  btn.setAttribute(\"aria-label\", title);\n  if (typeof isActive !== \"undefined\")\n    btn.setAttribute(\"aria-pressed\", String(!!isActive));\n  btn.tabIndex = 0;\n  if (disabled) btn.disabled = true;\n  btn.onclick = () => {\n    // restore any previously-saved selection before executing command\n    _restoreSelection();\n    options.onCommand(command, value);\n  };\n  // Prevent toolbar button from taking focus / collapsing selection in the editor\n  btn.addEventListener(\"mousedown\", (ev: MouseEvent) => {\n    ev.preventDefault();\n    _saveSelection();\n  });\n  btn.addEventListener(\"keydown\", (ev: KeyboardEvent) => {\n    if (ev.key === \"Enter\" || ev.key === \" \") {\n      ev.preventDefault();\n      btn.click();\n    }\n  });\n  return btn;\n}\n\nexport function makeGroup(doc: Document) {\n  const g = doc.createElement(\"div\");\n  g.className = \"toolbar-group\";\n  return g;\n}\n\nexport function makeSep(doc: Document) {\n  const s = doc.createElement(\"div\");\n  s.className = \"toolbar-sep\";\n  return s;\n}\n","export function makeSelect(\n  doc: Document,\n  options: { onCommand: (command: string, value?: string) => void },\n  title: string,\n  command: string,\n  optionsList: { label: string; value: string }[],\n  initialValue?: string | null,\n) {\n  const select = doc.createElement(\"select\");\n  select.title = title;\n  select.setAttribute(\"aria-label\", title);\n  select.appendChild(new Option(title, \"\", true, true));\n  for (const opt of optionsList) {\n    select.appendChild(new Option(opt.label, opt.value));\n  }\n  try {\n    if (initialValue) select.value = initialValue;\n  } catch (e) {\n    /* ignore invalid value */\n  }\n  select.onchange = (e: Event) => {\n    const val = (e.target as HTMLSelectElement).value;\n    options.onCommand(command, val);\n    select.selectedIndex = 0;\n  };\n  return select;\n}\n","export function setupNavigation(toolbar: HTMLElement) {\n  toolbar.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n    const focusable = Array.from(\n      toolbar.querySelectorAll<HTMLElement>(\n        \"button, select, input, [tabindex]\",\n      ),\n    ).filter((el) => !el.hasAttribute(\"disabled\"));\n    if (!focusable.length) return;\n    const idx = focusable.indexOf(document.activeElement as HTMLElement);\n    if (e.key === \"ArrowRight\") {\n      e.preventDefault();\n      const next =\n        focusable[Math.min(focusable.length - 1, Math.max(0, idx + 1))];\n      next?.focus();\n    } else if (e.key === \"ArrowLeft\") {\n      e.preventDefault();\n      const prev = focusable[Math.max(0, idx - 1)] || focusable[0];\n      prev?.focus();\n    } else if (e.key === \"Home\") {\n      e.preventDefault();\n      focusable[0].focus();\n    } else if (e.key === \"End\") {\n      e.preventDefault();\n      focusable[focusable.length - 1].focus();\n    }\n  });\n}\n","/**\n * Inject and render the formatting toolbar into the document\n *\n * Creates a sticky toolbar with:\n * - Text formatting buttons (Bold, Italic, Underline)\n * - Font and size selectors\n * - Undo/Redo buttons\n * - Link insertion button\n * - Color pickers (text and highlight)\n * - Text alignment buttons\n * - Selected element info display\n *\n * The toolbar is re-injected on every selection change to update state\n * (this is optimized for small toolbar size and few state changes)\n *\n * @param doc - Document to inject toolbar into\n * @param options - Toolbar configuration and callbacks\n */\nimport {\n  TOOLBAR_ID,\n  LABEL_BOLD,\n  LABEL_ITALIC,\n  LABEL_UNDERLINE,\n  LABEL_STRIKETHROUGH,\n  LABEL_CLEAR_FORMAT,\n  LABEL_UNORDERED_LIST,\n  LABEL_ORDERED_LIST,\n  LABEL_UNDO,\n  LABEL_REDO,\n  LABEL_LINK,\n  LABEL_ALIGN_LEFT,\n  LABEL_ALIGN_CENTER,\n  LABEL_ALIGN_RIGHT,\n  FONT_OPTIONS,\n  SIZE_OPTIONS,\n  FORMAT_OPTIONS,\n} from \"../core/constants\";\nimport { getEditorRoot } from \"../dom/root\";\nimport { makeColorInput } from \"./color\";\nimport { setupOverflow } from \"./overflow\";\nimport {\n  makeButton as _makeButton,\n  makeGroup as _makeGroup,\n  makeSep as _makeSep,\n} from \"./buttons\";\nimport { makeSelect as _makeSelect } from \"./selects\";\nimport { setupNavigation } from \"./navigation\";\n\nexport function injectToolbar(\n  doc: Document,\n  options: {\n    onCommand: (command: string, value?: string) => void;\n    canUndo: () => boolean;\n    canRedo: () => boolean;\n    onUndo: () => void;\n    onRedo: () => void;\n    getFormatState: () => {\n      bold: boolean;\n      italic: boolean;\n      underline: boolean;\n      foreColor?: string | null;\n      hiliteColor?: string | null;\n      fontName?: string | null;\n      fontSize?: string | null;\n      formatBlock?: string | null;\n    };\n    getSelectedElementInfo: () => string | null;\n  },\n) {\n  const existing = doc.getElementById(TOOLBAR_ID);\n  if (existing) existing.remove();\n\n  const toolbar = doc.createElement(\"div\");\n  toolbar.id = TOOLBAR_ID;\n  // Accessibility: expose as a toolbar region and provide a readable label\n  toolbar.setAttribute(\"role\", \"toolbar\");\n  toolbar.setAttribute(\"aria-label\", \"Rich text editor toolbar\");\n\n  // Styling moved to injected stylesheet (see src/dom/styles.ts)\n\n  const makeButton = (\n    label: string,\n    title: string,\n    command: string,\n    value?: string,\n    isActive?: boolean,\n    disabled?: boolean,\n  ) =>\n    _makeButton(\n      doc,\n      { onCommand: options.onCommand },\n      label,\n      title,\n      command,\n      value,\n      isActive,\n      disabled,\n    );\n\n  const makeSelect = (\n    title: string,\n    command: string,\n    optionsList: { label: string; value: string }[],\n    initialValue?: string | null,\n  ) =>\n    _makeSelect(\n      doc,\n      { onCommand: options.onCommand },\n      title,\n      command,\n      optionsList,\n      initialValue,\n    );\n\n  // Color input helper moved to ./color.ts\n\n  const format = options.getFormatState();\n  // Helpers: group wrapper and separator element\n  const makeGroup = () => _makeGroup(doc);\n  const makeSep = () => _makeSep(doc);\n\n  // Section 1: Undo / Redo\n  const undoBtn = makeButton(\n    LABEL_UNDO,\n    \"Undo\",\n    \"undo\",\n    undefined,\n    false,\n    !options.canUndo(),\n  );\n  // Undo/Redo are handled by the history module — call handlers directly\n  undoBtn.onclick = () => options.onUndo();\n\n  const redoBtn = makeButton(\n    LABEL_REDO,\n    \"Redo\",\n    \"redo\",\n    undefined,\n    false,\n    !options.canRedo(),\n  );\n  redoBtn.onclick = () => options.onRedo();\n\n  const grp1 = makeGroup();\n  grp1.appendChild(undoBtn);\n  grp1.appendChild(redoBtn);\n  toolbar.appendChild(grp1);\n  toolbar.appendChild(makeSep());\n\n  // Section 2: Format, Font & Size\n  const grp2 = makeGroup();\n  grp2.className = \"toolbar-group collapse-on-small\";\n  grp2.appendChild(\n    makeSelect(\n      \"Format\",\n      \"formatBlock\",\n      FORMAT_OPTIONS,\n      (format as any).formatBlock,\n    ),\n  );\n  grp2.appendChild(\n    makeSelect(\"Font\", \"fontName\", FONT_OPTIONS, (format as any).fontName),\n  );\n  grp2.appendChild(\n    makeSelect(\"Size\", \"fontSize\", SIZE_OPTIONS, (format as any).fontSize),\n  );\n  toolbar.appendChild(grp2);\n  toolbar.appendChild(makeSep());\n\n  // Section 3: Bold, Italic, Underline, Strikethrough\n  const grp3 = makeGroup();\n  grp3.appendChild(\n    makeButton(LABEL_BOLD, \"Bold\", \"bold\", undefined, format.bold),\n  );\n  grp3.appendChild(\n    makeButton(LABEL_ITALIC, \"Italic\", \"italic\", undefined, format.italic),\n  );\n  grp3.appendChild(\n    makeButton(\n      LABEL_UNDERLINE,\n      \"Underline\",\n      \"underline\",\n      undefined,\n      format.underline,\n    ),\n  );\n  grp3.appendChild(makeButton(LABEL_STRIKETHROUGH, \"Strikethrough\", \"strike\"));\n  // Clear formatting button: removes editor-applied inline/block formatting\n  grp3.appendChild(\n    makeButton(LABEL_CLEAR_FORMAT, \"Clear formatting\", \"clearFormat\"),\n  );\n  grp3.appendChild(\n    makeButton(\n      LABEL_UNORDERED_LIST,\n      \"Unordered list\",\n      \"unorderedList\",\n      undefined,\n      (format as any).listType === \"ul\",\n    ),\n  );\n  grp3.appendChild(\n    makeButton(\n      LABEL_ORDERED_LIST,\n      \"Ordered list\",\n      \"orderedList\",\n      undefined,\n      (format as any).listType === \"ol\",\n    ),\n  );\n  toolbar.appendChild(grp3);\n  toolbar.appendChild(makeSep());\n\n  // Section 4: Alignment\n  const grp4 = makeGroup();\n  grp4.appendChild(makeButton(LABEL_ALIGN_LEFT, \"Align left\", \"align\", \"left\"));\n  grp4.appendChild(\n    makeButton(LABEL_ALIGN_CENTER, \"Align center\", \"align\", \"center\"),\n  );\n  grp4.appendChild(\n    makeButton(LABEL_ALIGN_RIGHT, \"Align right\", \"align\", \"right\"),\n  );\n  toolbar.appendChild(grp4);\n  toolbar.appendChild(makeSep());\n\n  // Section 5: Colors\n  const grp5 = makeGroup();\n  grp5.className = \"toolbar-group collapse-on-small\";\n  grp5.appendChild(\n    makeColorInput(\n      doc,\n      options,\n      \"Text color\",\n      \"foreColor\",\n      (format as any).foreColor,\n    ),\n  );\n  grp5.appendChild(\n    makeColorInput(\n      doc,\n      options,\n      \"Highlight color\",\n      \"hiliteColor\",\n      (format as any).hiliteColor,\n    ),\n  );\n  toolbar.appendChild(grp5);\n  toolbar.appendChild(makeSep());\n\n  // Section 6: Link\n  const grp6 = makeGroup();\n  grp6.className = \"toolbar-group collapse-on-small\";\n  grp6.appendChild(makeButton(LABEL_LINK, \"Insert link\", \"link\"));\n  toolbar.appendChild(grp6);\n\n  // Overflow UI extracted to ./overflow.ts — set up with helper functions\n  setupOverflow(doc, toolbar, options, format, {\n    makeSelect,\n    makeColorInput: (title: string, command: string, initial?: string) =>\n      makeColorInput(doc, options, title, command, initial),\n    makeButton,\n    makeGroup,\n  });\n\n  // const info = doc.createElement(\"span\");\n  // // Info styles moved to stylesheet\n  // info.textContent = options.getSelectedElementInfo()\n  //   ? `Selected: ${options.getSelectedElementInfo()}`\n  //   : \"Click any highlighted element to edit\";\n  // toolbar.appendChild(info);\n\n  // Keyboard navigation for toolbar\n  setupNavigation(toolbar);\n\n  // Mount toolbar inside the scoped editor root so template styles cannot leak in.\n  try {\n    const root = getEditorRoot(doc);\n    root.insertBefore(toolbar, root.firstChild);\n  } catch (e) {\n    // Fallback to previous behavior if root insertion fails\n    doc.body.insertBefore(toolbar, doc.body.firstChild);\n  }\n}\n","/**\n * Check if an element can be edited\n *\n * Valid elements: Text container tags (p, div, section, etc.)\n * Invalid elements: HTML structure tags, inputs, scripts, styles\n *\n * @param el - Element to check\n * @returns True if element is a valid editable candidate\n */\nexport function isEditableCandidate(el: HTMLElement | null): boolean {\n  if (!el) return false;\n  const tag = el.tagName;\n  const DISALLOWED = [\n    \"HTML\",\n    \"HEAD\",\n    \"BODY\",\n    \"SCRIPT\",\n    \"STYLE\",\n    \"LINK\",\n    \"META\",\n    \"NOSCRIPT\",\n  ];\n  if (DISALLOWED.includes(tag)) return false;\n  if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return false;\n  return true;\n}\n","import { MAX_FILE_SIZE } from \"../core/constants\";\nimport { pushStandaloneSnapshot } from \"../core/state\";\nimport { getEditorRoot } from \"./root\";\n\nfunction createModal(doc: Document) {\n  const overlay = doc.createElement(\"div\");\n  overlay.className = \"rhe-img-modal-overlay\";\n  overlay.setAttribute(\"role\", \"dialog\");\n  overlay.setAttribute(\"aria-modal\", \"true\");\n\n  const modal = doc.createElement(\"div\");\n  modal.className = \"rhe-img-modal\";\n\n  const title = doc.createElement(\"h3\");\n  title.textContent = \"Edit image\";\n\n  const tabs = doc.createElement(\"div\");\n  tabs.className = \"rhe-img-tabs\";\n\n  const uploadBtn = doc.createElement(\"button\");\n  uploadBtn.type = \"button\";\n  uploadBtn.textContent = \"Upload file\";\n  uploadBtn.className = \"active\";\n\n  const urlBtn = doc.createElement(\"button\");\n  urlBtn.type = \"button\";\n  urlBtn.textContent = \"Image URL\";\n\n  tabs.appendChild(uploadBtn);\n  tabs.appendChild(urlBtn);\n\n  const uploadPane = doc.createElement(\"div\");\n  uploadPane.className = \"rhe-img-pane rhe-img-pane-upload\";\n  const fileInput = doc.createElement(\"input\");\n  fileInput.type = \"file\";\n  fileInput.accept = \"image/*\";\n  // Ensure the input fits inside the modal\n  fileInput.style.width = \"100%\";\n  fileInput.style.boxSizing = \"border-box\";\n  uploadPane.appendChild(fileInput);\n  const uploadMsg = doc.createElement(\"div\");\n  uploadMsg.className = \"rhe-img-msg\";\n  uploadPane.appendChild(uploadMsg);\n\n  const urlPane = doc.createElement(\"div\");\n  urlPane.className = \"rhe-img-pane rhe-img-pane-url\";\n  urlPane.style.display = \"none\";\n  const urlInput = doc.createElement(\"input\");\n  urlInput.type = \"url\";\n  urlInput.placeholder = \"https://example.com/image.jpg\";\n  // Ensure the input fits inside the modal\n  urlInput.style.width = \"100%\";\n  urlInput.style.boxSizing = \"border-box\";\n  urlPane.appendChild(urlInput);\n  const urlMsg = doc.createElement(\"div\");\n  urlMsg.className = \"rhe-img-msg\";\n  urlPane.appendChild(urlMsg);\n\n  const actions = doc.createElement(\"div\");\n  actions.className = \"rhe-img-actions\";\n  const cancel = doc.createElement(\"button\");\n  cancel.type = \"button\";\n  cancel.textContent = \"Cancel\";\n  const apply = doc.createElement(\"button\");\n  apply.type = \"button\";\n  apply.textContent = \"Apply\";\n  apply.className = \"primary\";\n  actions.appendChild(cancel);\n  actions.appendChild(apply);\n\n  modal.appendChild(title);\n  modal.appendChild(tabs);\n  modal.appendChild(uploadPane);\n  modal.appendChild(urlPane);\n  modal.appendChild(actions);\n  overlay.appendChild(modal);\n\n  // Tab behavior\n  uploadBtn.addEventListener(\"click\", () => {\n    uploadBtn.classList.add(\"active\");\n    urlBtn.classList.remove(\"active\");\n    uploadPane.style.display = \"block\";\n    urlPane.style.display = \"none\";\n  });\n  urlBtn.addEventListener(\"click\", () => {\n    urlBtn.classList.add(\"active\");\n    uploadBtn.classList.remove(\"active\");\n    uploadPane.style.display = \"none\";\n    urlPane.style.display = \"block\";\n  });\n\n  return {\n    overlay,\n    fileInput,\n    uploadMsg,\n    urlInput,\n    urlMsg,\n    cancel,\n    apply,\n  };\n}\n\nfunction validateUrl(u: string): boolean {\n  try {\n    const url = new URL(u);\n    if (url.protocol !== \"http:\" && url.protocol !== \"https:\") return false;\n    return true;\n  } catch (err) {\n    return false;\n  }\n}\n\nexport function openImageEditor(doc: Document, img: HTMLImageElement) {\n  const existing = doc.querySelector(\".rhe-img-modal-overlay\");\n  if (existing) return;\n  const { overlay, fileInput, uploadMsg, urlInput, urlMsg, cancel, apply } =\n    createModal(doc);\n\n  function close() {\n    overlay.remove();\n  }\n\n  // File input handler\n  fileInput.addEventListener(\"change\", () => {\n    uploadMsg.textContent = \"\";\n    const f = fileInput.files && fileInput.files[0];\n    if (!f) return;\n    if (!f.type.startsWith(\"image/\")) {\n      uploadMsg.textContent = \"Invalid file type\";\n      return;\n    }\n    if (f.size > MAX_FILE_SIZE) {\n      uploadMsg.textContent = \"File is larger than 1 MB\";\n      return;\n    }\n    const reader = new FileReader();\n    reader.onerror = () => {\n      uploadMsg.textContent = \"Failed to read file\";\n    };\n    reader.onload = () => {\n      const result = reader.result as string | null;\n      if (!result) {\n        uploadMsg.textContent = \"Failed to read file\";\n        return;\n      }\n      img.src = result;\n      try {\n        pushStandaloneSnapshot();\n      } catch (err) {\n        /* ignore snapshot errors */\n      }\n      close();\n    };\n    reader.readAsDataURL(f);\n  });\n\n  // URL apply handler\n  apply.addEventListener(\"click\", async () => {\n    urlMsg.textContent = \"\";\n    const val = urlInput.value.trim();\n    if (val) {\n      if (!validateUrl(val)) {\n        urlMsg.textContent = \"Enter a valid http/https URL\";\n        return;\n      }\n      // Try to fetch HEAD to validate content-type/length (best-effort, may fail due to CORS)\n      try {\n        const head = await fetch(val, { method: \"HEAD\" });\n        const ct = head.headers.get(\"content-type\");\n        const cl = head.headers.get(\"content-length\");\n        if (ct && !ct.startsWith(\"image/\")) {\n          urlMsg.textContent = \"URL does not point to an image\";\n          return;\n        }\n        if (cl && Number(cl) > MAX_FILE_SIZE) {\n          urlMsg.textContent = \"Image appears larger than 1 MB\";\n          return;\n        }\n        // OK — apply URL\n        img.src = val;\n        try {\n          pushStandaloneSnapshot();\n        } catch (err) {\n          /* ignore snapshot errors */\n        }\n        close();\n        return;\n      } catch (err) {\n        // If HEAD fails (CORS), still allow setting the URL — leave a soft warning\n        img.src = val;\n        try {\n          pushStandaloneSnapshot();\n        } catch (err) {\n          /* ignore snapshot errors */\n        }\n        close();\n        return;\n      }\n    } else {\n      // No URL entered — just close\n      close();\n    }\n  });\n\n  cancel.addEventListener(\"click\", () => close());\n\n  // Basic keyboard handling: Escape closes\n  overlay.addEventListener(\"keydown\", (e) => {\n    if (e.key === \"Escape\") close();\n  });\n\n  // Insert overlay inside the editor root so global template CSS doesn't affect modal UI\n  try {\n    const root = getEditorRoot(doc);\n    root.appendChild(overlay);\n  } catch (e) {\n    doc.body.appendChild(overlay);\n  }\n  (fileInput as HTMLInputElement).focus();\n}\n\nexport default {};\n","/**\n * Compute the current formatting state of selected text\n *\n * Detects bold, italic, and underline formatting based on:\n * - DOM element tags (strong, em, u)\n * - CSS computed styles (fontWeight, fontStyle, textDecoration)\n *\n * @param doc - Document context\n * @returns Object with boolean flags for bold, italic, underline\n */\nexport function computeFormatState(doc: Document): {\n  bold: boolean;\n  italic: boolean;\n  underline: boolean;\n  foreColor: string | null;\n  hiliteColor: string | null;\n  fontName: string | null;\n  fontSize: string | null;\n  formatBlock: string | null;\n  listType: string | null;\n} {\n  try {\n    const s = doc.getSelection();\n    let el: HTMLElement | null = null;\n    if (s && s.anchorNode)\n      el =\n        s.anchorNode.nodeType === Node.ELEMENT_NODE\n          ? (s.anchorNode as HTMLElement)\n          : (s.anchorNode.parentElement as HTMLElement);\n    if (!el)\n      return {\n        bold: false,\n        italic: false,\n        underline: false,\n        foreColor: null,\n        hiliteColor: null,\n        fontName: null,\n        fontSize: null,\n        formatBlock: null,\n        listType: null,\n      };\n    const computed = doc.defaultView?.getComputedStyle(el) as\n      | CSSStyleDeclaration\n      | undefined;\n    const bold = !!(\n      el.closest(\"strong, b\") ||\n      (computed &&\n        (computed.fontWeight === \"700\" || Number(computed.fontWeight) >= 700))\n    );\n    const italic = !!(\n      el.closest(\"em, i\") ||\n      (computed && computed.fontStyle === \"italic\")\n    );\n    const underline = !!(\n      el.closest(\"u\") ||\n      (computed && (computed.textDecorationLine || \"\").includes(\"underline\"))\n    );\n    // Try to detect text color and highlight (background) color at the selection\n    const foreColor =\n      (el.closest(\"font[color]\") as HTMLElement | null)?.getAttribute(\n        \"color\",\n      ) ||\n      (computed && computed.color) ||\n      null;\n    // Background color may come from a <mark> element or computed background-color\n    const mark = el.closest(\"mark\") as HTMLElement | null;\n    const hiliteColor =\n      (mark && (mark.getAttribute(\"style\") || \"\")) ||\n      (computed &&\n      computed.backgroundColor &&\n      computed.backgroundColor !== \"rgba(0, 0, 0, 0)\"\n        ? computed.backgroundColor\n        : null);\n\n    // detect font name + size from computed style\n    const fontName = (computed && computed.fontFamily) || null;\n    const fontSize = (computed && computed.fontSize) || null;\n    // detect block ancestor (paragraph, heading etc.)\n    let blockEl: HTMLElement | null = el;\n    while (blockEl && blockEl.parentElement) {\n      const tag = blockEl.tagName;\n      if (\n        [\n          \"P\",\n          \"DIV\",\n          \"SECTION\",\n          \"ARTICLE\",\n          \"LI\",\n          \"TD\",\n          \"BLOCKQUOTE\",\n          \"H1\",\n          \"H2\",\n          \"H3\",\n          \"H4\",\n          \"H5\",\n          \"H6\",\n        ].includes(tag)\n      ) {\n        break;\n      }\n      blockEl = blockEl.parentElement as HTMLElement | null;\n    }\n    const formatBlock = blockEl ? blockEl.tagName.toLowerCase() : null;\n    // detect if selection is inside a list and which type\n    let listType: string | null = null;\n    try {\n      if (blockEl && blockEl.tagName === \"LI\") {\n        const list = blockEl.closest(\"ul,ol\") as HTMLElement | null;\n        if (list) listType = list.tagName.toLowerCase();\n      } else {\n        const possible = el.closest(\"ul,ol\") as HTMLElement | null;\n        if (possible) listType = possible.tagName.toLowerCase();\n      }\n    } catch (e) {\n      listType = null;\n    }\n\n    return {\n      bold,\n      italic,\n      underline,\n      foreColor,\n      hiliteColor,\n      fontName,\n      fontSize,\n      formatBlock,\n      listType,\n    };\n  } catch (err) {\n    return {\n      bold: false,\n      italic: false,\n      underline: false,\n      foreColor: null,\n      hiliteColor: null,\n      fontName: null,\n      fontSize: null,\n      formatBlock: null,\n      listType: null,\n    };\n  }\n}\n\n/**\n * Get a human-readable label for an element\n *\n * Format: `tagname#id.class`\n * Example: `p#intro.highlight` or `div.container`\n *\n * @param el - HTML element to label\n * @returns Label string or null if element is null\n */\nexport function getElementLabel(el: HTMLElement | null): string | null {\n  if (!el) return null;\n  const id = el.id ? `#${el.id}` : \"\";\n  const cls = el.className ? `.${String(el.className).split(\" \")[0]}` : \"\";\n  const tag = el.tagName.toLowerCase();\n  return `${tag}${id}${cls}`;\n}\n","export function sanitizeURL(url: string): string {\n  if (!url) return \"\";\n  const trimmed = url.trim();\n  if (!trimmed) return \"\";\n  if (\n    trimmed.toLowerCase().startsWith(\"javascript:\") ||\n    trimmed.toLowerCase().startsWith(\"data:\")\n  ) {\n    console.warn(\"Blocked potentially dangerous URL protocol\");\n    return \"\";\n  }\n  if (!trimmed.startsWith(\"http\") && !trimmed.startsWith(\"#\")) {\n    return \"https://\" + trimmed;\n  }\n  return trimmed;\n}\n","import {\n  _getDoc,\n  _getUndoStack,\n  _getRedoStack,\n  _setUndoStack,\n  _setRedoStack,\n} from \"./state\";\n\nimport { sanitizeHtml } from \"../utils/sanitize\";\nimport { injectStyles } from \"../dom/styles\";\n\nexport function handleUndo() {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] handleUndo called before initialization\",\n      );\n      return;\n    }\n    if (_getUndoStack().length < 2) return;\n    const undoStack = _getUndoStack();\n    const redoStack = _getRedoStack();\n    const current = undoStack.pop()!;\n    redoStack.push(current);\n    const prev = undoStack[undoStack.length - 1];\n    if (!doc.documentElement) {\n      throw new Error(\"Document is missing documentElement\");\n    }\n    // Sanitize the snapshot and extract only the body content so we\n    // avoid overwriting head/link/style nodes that may contain page\n    // or editor styles. Replacing only `document.body` preserves those\n    // nodes while still restoring user content.\n    const safe = sanitizeHtml(prev.replace(/^<!doctype html>\\n?/i, \"\"), doc);\n    try {\n      const parser = new DOMParser();\n      const parsed = parser.parseFromString(safe, \"text/html\");\n      if (parsed && parsed.body && doc.body) {\n        // Prefer selective restoration: if the snapshot contains elements\n        // marked with `data-rhe-id`, restore only those elements so we do\n        // not clobber page-level UI (headers, tabs, carousel scripts).\n        const parsedEls = parsed.body.querySelectorAll(\"[data-rhe-id]\");\n        if (parsedEls && parsedEls.length) {\n          const loadPromises: Promise<void>[] = [];\n          parsedEls.forEach((pe) => {\n            const id = pe.getAttribute(\"data-rhe-id\");\n            if (!id) return;\n            const local = doc.body.querySelector(`[data-rhe-id=\"${id}\"]`);\n            if (!local) return;\n            // Copy non-identifying attributes from parsed element to local\n            try {\n              Array.from(local.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\") local.removeAttribute(a.name);\n              });\n              Array.from(pe.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\")\n                  local.setAttribute(a.name, a.value);\n              });\n            } catch (err) {\n              /* ignore attribute copy errors */\n            }\n            // Replace innerHTML of the editable region only\n            try {\n              local.innerHTML = pe.innerHTML;\n            } catch (err) {\n              /* ignore innerHTML set errors */\n            }\n            // Recreate preserved script placeholders inside the parsed element\n            try {\n              const placeholders = pe.querySelectorAll(\"[data-rhe-script]\");\n              placeholders.forEach((ph) => {\n                const encoded = ph.getAttribute(\"data-rhe-script\") || \"\";\n                let code = \"\";\n                try {\n                  code =\n                    typeof atob !== \"undefined\"\n                      ? decodeURIComponent(escape(atob(encoded)))\n                      : decodeURIComponent(encoded);\n                } catch (e) {\n                  try {\n                    code = decodeURIComponent(encoded);\n                  } catch (er) {\n                    code = \"\";\n                  }\n                }\n                const attrsRaw = ph.getAttribute(\"data-rhe-script-attrs\");\n                let attrs: Record<string, string> = {};\n                if (attrsRaw) {\n                  try {\n                    attrs = JSON.parse(decodeURIComponent(attrsRaw));\n                  } catch (e) {\n                    attrs = {};\n                  }\n                }\n                const parentId = ph.getAttribute(\"data-rhe-script-parent\");\n                try {\n                  const s = doc.createElement(\"script\");\n                  try {\n                    s.type = \"text/javascript\";\n                    (s as any).async = false;\n                  } catch (err) {\n                    /* ignore */\n                  }\n                  Object.keys(attrs).forEach((k) =>\n                    s.setAttribute(k, attrs[k]),\n                  );\n                  if (attrs.src) {\n                    const p = new Promise<void>((resolve) => {\n                      s.addEventListener(\"load\", () => resolve());\n                      s.addEventListener(\"error\", () => resolve());\n                    });\n                    loadPromises.push(p);\n                    s.src = attrs.src;\n                  } else {\n                    s.textContent = code;\n                  }\n                  if (parentId === \"head\") {\n                    doc.head.appendChild(s);\n                  } else {\n                    const target = doc.body.querySelector(\n                      `[data-rhe-id=\"${parentId}\"]`,\n                    );\n                    if (target) target.appendChild(s);\n                    else doc.body.appendChild(s);\n                  }\n                } catch (e) {\n                  /* ignore script injection errors */\n                }\n              });\n            } catch (e) {\n              /* ignore placeholder processing errors */\n            }\n          });\n          try {\n            if (loadPromises.length) {\n              const waiter = (Promise as any).allSettled\n                ? (Promise as any).allSettled(loadPromises)\n                : Promise.all(\n                    loadPromises.map((p) => p.catch(() => undefined)),\n                  );\n              waiter.then(() => {\n                try {\n                  doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n                } catch (e) {\n                  /* ignore */\n                }\n              });\n            } else {\n              try {\n                doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n              } catch (e) {\n                /* ignore */\n              }\n            }\n          } catch (e) {\n            /* ignore */\n          }\n        } else {\n          // No markers present — fallback to previous behavior of replacing\n          // the body contents. This preserves backward compatibility.\n          doc.body.innerHTML = parsed.body.innerHTML;\n        }\n      } else {\n        // Fallback to replacing the whole documentElement if body is missing\n        doc.documentElement.innerHTML = safe;\n      }\n    } catch (err) {\n      // On any parse error, fall back to previous behavior\n      doc.documentElement.innerHTML = safe;\n    }\n\n    // Re-inject editor styles (toolbar/style) and notify listeners so the\n    // toolbar is restored and selectionchange handlers run.\n    injectStyles(doc);\n    try {\n      doc.dispatchEvent(new Event(\"selectionchange\"));\n    } catch (err) {\n      /* ignore dispatch errors */\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Undo failed:\", message);\n  }\n}\n\nexport function handleRedo() {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] handleRedo called before initialization\",\n      );\n      return;\n    }\n    if (!_getRedoStack().length) return;\n    const undoStack = _getUndoStack();\n    const redoStack = _getRedoStack();\n    const next = redoStack.pop()!;\n    undoStack.push(next);\n    if (!doc.documentElement) {\n      throw new Error(\"Document is missing documentElement\");\n    }\n    const safeNext = sanitizeHtml(\n      next.replace(/^<!doctype html>\\n?/i, \"\"),\n      doc,\n    );\n    try {\n      const parser = new DOMParser();\n      const parsed = parser.parseFromString(safeNext, \"text/html\");\n      if (parsed && parsed.body && doc.body) {\n        const parsedEls = parsed.body.querySelectorAll(\"[data-rhe-id]\");\n        if (parsedEls && parsedEls.length) {\n          const loadPromises: Promise<void>[] = [];\n          parsedEls.forEach((pe) => {\n            const id = pe.getAttribute(\"data-rhe-id\");\n            if (!id) return;\n            const local = doc.body.querySelector(`[data-rhe-id=\"${id}\"]`);\n            if (!local) return;\n            try {\n              Array.from(local.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\") local.removeAttribute(a.name);\n              });\n              Array.from(pe.attributes).forEach((a) => {\n                if (a.name !== \"data-rhe-id\")\n                  local.setAttribute(a.name, a.value);\n              });\n            } catch (err) {\n              /* ignore */\n            }\n            try {\n              local.innerHTML = pe.innerHTML;\n            } catch (err) {\n              /* ignore */\n            }\n            try {\n              const placeholders = pe.querySelectorAll(\"[data-rhe-script]\");\n              placeholders.forEach((ph) => {\n                const encoded = ph.getAttribute(\"data-rhe-script\") || \"\";\n                let code = \"\";\n                try {\n                  code =\n                    typeof atob !== \"undefined\"\n                      ? decodeURIComponent(escape(atob(encoded)))\n                      : decodeURIComponent(encoded);\n                } catch (e) {\n                  try {\n                    code = decodeURIComponent(encoded);\n                  } catch (er) {\n                    code = \"\";\n                  }\n                }\n                const attrsRaw = ph.getAttribute(\"data-rhe-script-attrs\");\n                let attrs: Record<string, string> = {};\n                if (attrsRaw) {\n                  try {\n                    attrs = JSON.parse(decodeURIComponent(attrsRaw));\n                  } catch (e) {\n                    attrs = {};\n                  }\n                }\n                const parentId = ph.getAttribute(\"data-rhe-script-parent\");\n                try {\n                  const s = doc.createElement(\"script\");\n                  try {\n                    s.type = \"text/javascript\";\n                    (s as any).async = false;\n                  } catch (err) {\n                    /* ignore */\n                  }\n                  Object.keys(attrs).forEach((k) =>\n                    s.setAttribute(k, attrs[k]),\n                  );\n                  if (attrs.src) {\n                    const p = new Promise<void>((resolve) => {\n                      s.addEventListener(\"load\", () => resolve());\n                      s.addEventListener(\"error\", () => resolve());\n                    });\n                    loadPromises.push(p);\n                    s.src = attrs.src;\n                  } else {\n                    s.textContent = code;\n                  }\n                  if (parentId === \"head\") {\n                    doc.head.appendChild(s);\n                  } else {\n                    const target = doc.body.querySelector(\n                      `[data-rhe-id=\"${parentId}\"]`,\n                    );\n                    if (target) target.appendChild(s);\n                    else doc.body.appendChild(s);\n                  }\n                } catch (e) {\n                  /* ignore script injection errors */\n                }\n              });\n            } catch (e) {\n              /* ignore placeholder processing errors */\n            }\n          });\n          try {\n            if (loadPromises.length) {\n              const waiter = (Promise as any).allSettled\n                ? (Promise as any).allSettled(loadPromises)\n                : Promise.all(\n                    loadPromises.map((p) => p.catch(() => undefined)),\n                  );\n              waiter.then(() => {\n                try {\n                  doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n                } catch (e) {\n                  /* ignore */\n                }\n              });\n            } else {\n              try {\n                doc.dispatchEvent(new Event(\"rhe:scripts-restored\"));\n              } catch (e) {\n                /* ignore */\n              }\n            }\n          } catch (e) {\n            /* ignore */\n          }\n        } else {\n          doc.body.innerHTML = parsed.body.innerHTML;\n        }\n      } else {\n        doc.documentElement.innerHTML = safeNext;\n      }\n    } catch (err) {\n      doc.documentElement.innerHTML = safeNext;\n    }\n\n    // Re-inject styles and notify listeners so toolbar/styles are restored\n    injectStyles(doc);\n    try {\n      doc.dispatchEvent(new Event(\"selectionchange\"));\n    } catch (err) {\n      /* ignore dispatch errors */\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Redo failed:\", message);\n  }\n}\n","import { _getDoc, pushStandaloneSnapshot } from \"./state\";\nimport { sanitizeURL } from \"./sanitizeURL\";\n\nexport function handleToolbarCommand(command: string, value?: string) {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] handleToolbarCommand called before initialization\",\n      );\n      return;\n    }\n    if (command === \"undo\") return; // delegated to history module\n    if (command === \"redo\") return; // delegated to history module\n    if (command === \"link\") {\n      const url = window.prompt(\"Enter URL (https://...):\", \"https://\");\n      if (url) {\n        const sanitized = sanitizeURL(url);\n        if (sanitized) applyStandaloneCommand(\"link\", sanitized);\n      }\n      return;\n    }\n    applyStandaloneCommand(command, value);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Command handler failed:\", message);\n  }\n}\n\nexport function applyStandaloneCommand(command: string, value?: string) {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] applyStandaloneCommand called before initialization\",\n      );\n      return;\n    }\n\n    if (command === \"bold\") wrapSelectionWithElement(doc, \"strong\");\n    else if (command === \"italic\") wrapSelectionWithElement(doc, \"em\");\n    else if (command === \"underline\") wrapSelectionWithElement(doc, \"u\");\n    else if (command === \"strike\") wrapSelectionWithElement(doc, \"s\");\n    else if (command === \"fontName\")\n      wrapSelectionWithElement(doc, \"span\", { fontFamily: value as any });\n    else if (command === \"fontSize\") {\n      // Accept numeric font-size values (e.g. \"12\", \"16\") and apply as px.\n      const raw = value || \"14\";\n      const n = parseInt(raw, 10);\n      const sz = Number.isFinite(n) ? `${n}px` : raw;\n      wrapSelectionWithElement(doc, \"span\", { fontSize: sz as any });\n    } else if (command === \"link\") {\n      const sel = doc.getSelection();\n      if (!sel || !sel.rangeCount) return;\n      const range = sel.getRangeAt(0);\n      const content = range.extractContents();\n      const a = doc.createElement(\"a\");\n      a.href = sanitizeURL(value || \"#\");\n      a.appendChild(content);\n      // mark anchor as editor-created (so clearFormat can detect it)\n      a.dataset.rheFormat = \"true\";\n      range.insertNode(a);\n    } else if (command === \"foreColor\")\n      wrapSelectionWithElement(doc, \"span\", { color: value as any });\n    else if (command === \"hiliteColor\")\n      wrapSelectionWithElement(doc, \"span\", { backgroundColor: value as any });\n    else if (command === \"align\") {\n      const sel = doc.getSelection();\n      const node = sel?.anchorNode || null;\n      const block = findBlockAncestor(node);\n      if (block) block.style.textAlign = value || \"left\";\n      else wrapSelectionWithElement(doc, \"div\", { textAlign: value as any });\n    } else if (command === \"formatBlock\") {\n      // Change block-level element to selected tag (p, h1..h6)\n      const sel = doc.getSelection();\n      const node = sel?.anchorNode || null;\n      const block = findBlockAncestor(node);\n      const tag = (value || \"p\").toLowerCase();\n      if (block && block.parentElement) {\n        // Replace existing block with new block of desired tag\n        const newEl = doc.createElement(tag);\n        // Preserve inline styles?\n        newEl.className = (block as HTMLElement).className || \"\";\n        while (block.firstChild) newEl.appendChild(block.firstChild);\n        // mark as editor-created block\n        (newEl as HTMLElement).dataset.rheFormat = \"true\";\n        block.parentElement.replaceChild(newEl, block);\n      } else {\n        // Wrap selection in the block tag\n        wrapSelectionWithElement(doc, tag);\n      }\n    } else if (command === \"unorderedList\" || command === \"orderedList\") {\n      const tag = command === \"unorderedList\" ? \"ul\" : \"ol\";\n      toggleList(doc, tag);\n    } else if (command === \"clearFormat\") {\n      clearSelectionFormatting(doc);\n    }\n\n    pushStandaloneSnapshot();\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Apply command failed:\", message);\n  }\n}\n\nfunction wrapSelectionWithElement(\n  doc: Document,\n  tagName: string,\n  style?: Partial<CSSStyleDeclaration>,\n): void {\n  const sel = doc.getSelection();\n  if (!sel) return;\n  if (!sel.rangeCount) return;\n  const range = sel.getRangeAt(0);\n  if (range.collapsed) {\n    const el = doc.createElement(tagName);\n    if (style) Object.assign(el.style, style as any);\n    // mark element as created by editor for session-only clearing\n    (el as HTMLElement).dataset.rheFormat = \"true\";\n    const zw = doc.createTextNode(\"\\u200B\");\n    el.appendChild(zw);\n    range.insertNode(el);\n    const newRange = doc.createRange();\n    newRange.setStart(zw, 1);\n    newRange.collapse(true);\n    sel.removeAllRanges();\n    sel.addRange(newRange);\n    return;\n  }\n  const content = range.extractContents();\n  const wrapper = doc.createElement(tagName);\n  if (style) Object.assign(wrapper.style, style as any);\n  // mark wrapper so we can clear editor-applied formatting later\n  (wrapper as HTMLElement).dataset.rheFormat = \"true\";\n  wrapper.appendChild(content);\n  range.insertNode(wrapper);\n  sel.removeAllRanges();\n  const newRange = doc.createRange();\n  newRange.selectNodeContents(wrapper);\n  sel.addRange(newRange);\n}\n\nfunction toggleList(doc: Document, listTag: \"ul\" | \"ol\") {\n  const sel = doc.getSelection();\n  if (!sel || !sel.rangeCount) return;\n  const node = sel.anchorNode || null;\n  const block = findBlockAncestor(node);\n\n  // If we're inside an LI\n  if (block && block.tagName === \"LI\" && block.parentElement) {\n    const parentList = block.parentElement as HTMLElement;\n    const parentTag = parentList.tagName.toLowerCase();\n    if (parentTag === listTag) {\n      // unwrap list: convert each LI into a P and replace the list\n      const frag = doc.createDocumentFragment();\n      Array.from(parentList.children).forEach((li) => {\n        const p = doc.createElement(\"p\");\n        while (li.firstChild) p.appendChild(li.firstChild);\n        frag.appendChild(p);\n      });\n      parentList.parentElement?.replaceChild(frag, parentList);\n      return;\n    } else {\n      // change list type (ul <-> ol)\n      const newList = doc.createElement(listTag);\n      while (parentList.firstChild) newList.appendChild(parentList.firstChild);\n      parentList.parentElement?.replaceChild(newList, parentList);\n      return;\n    }\n  }\n\n  // Not inside an existing list: wrap selection in a new list with a single LI per block\n  const range = sel.getRangeAt(0);\n  if (range.collapsed) {\n    const list = doc.createElement(listTag);\n    const li = doc.createElement(\"li\");\n    const zw = doc.createTextNode(\"\\u200B\");\n    li.appendChild(zw);\n    list.appendChild(li);\n    range.insertNode(list);\n    // place cursor inside the zero-width text node\n    const newRange = doc.createRange();\n    newRange.setStart(zw, 1);\n    newRange.collapse(true);\n    sel.removeAllRanges();\n    sel.addRange(newRange);\n    return;\n  }\n\n  // Non-collapsed: extract contents and wrap in a single LI (preserve structure)\n  const content = range.extractContents();\n  const list = doc.createElement(listTag);\n  const li = doc.createElement(\"li\");\n  li.appendChild(content);\n  list.appendChild(li);\n  range.insertNode(list);\n  sel.removeAllRanges();\n  const newRange = doc.createRange();\n  newRange.selectNodeContents(li);\n  sel.addRange(newRange);\n}\n\nfunction findBlockAncestor(node: Node | null): HTMLElement | null {\n  let n = node as Node | null;\n  const BLOCKS = [\n    \"P\",\n    \"DIV\",\n    \"SECTION\",\n    \"ARTICLE\",\n    \"LI\",\n    \"TD\",\n    \"BLOCKQUOTE\",\n    \"H1\",\n    \"H2\",\n    \"H3\",\n    \"H4\",\n    \"H5\",\n    \"H6\",\n  ];\n  while (n) {\n    if (n.nodeType === Node.ELEMENT_NODE) {\n      const el = n as HTMLElement;\n      if (BLOCKS.includes(el.tagName)) return el;\n    }\n    n = n.parentNode;\n  }\n  return null;\n}\n\nfunction clearSelectionFormatting(doc: Document) {\n  const sel = doc.getSelection();\n  if (!sel || !sel.rangeCount) return;\n  const range = sel.getRangeAt(0);\n  if (range.collapsed) return;\n\n  // If selection is nested inside editor-created inline wrappers (strong/em/u/span),\n  // expand the range to include the outermost marked ancestor that covers the\n  // selection so extractContents contains them. Build ancestor chains for both\n  // range boundaries and choose the outermost common marked ancestor when possible.\n  try {\n    const INLINE_WRAP = [\"STRONG\", \"B\", \"EM\", \"I\", \"U\", \"S\", \"SPAN\", \"A\"];\n    function getMarkedAncestors(node: Node | null) {\n      const out: HTMLElement[] = [];\n      let n: Node | null =\n        node && node.nodeType === Node.ELEMENT_NODE\n          ? node\n          : ((node && (node as Node).parentElement) as Node | null);\n      while (n) {\n        if (n.nodeType === Node.ELEMENT_NODE) {\n          const el = n as HTMLElement;\n          if (el.dataset && el.dataset.rheFormat === \"true\") out.push(el);\n        }\n        n = (n as Node).parentNode;\n      }\n      return out; // closest first, farthest last\n    }\n\n    const startAnc = getMarkedAncestors(range.startContainer);\n    const endAnc = getMarkedAncestors(range.endContainer);\n\n    // find outermost common ancestor (farthest from leaf)\n    let outer: HTMLElement | null = null;\n    for (let i = startAnc.length - 1; i >= 0; i--) {\n      const a = startAnc[i];\n      if (endAnc.includes(a)) {\n        outer = a;\n        break;\n      }\n    }\n    // fallback: choose the outermost of either side\n    if (!outer) {\n      if (startAnc.length) outer = startAnc[startAnc.length - 1];\n      else if (endAnc.length) outer = endAnc[endAnc.length - 1];\n    }\n\n    if (outer && INLINE_WRAP.includes(outer.tagName)) {\n      try {\n        range.setStartBefore(outer);\n        range.setEndAfter(outer);\n      } catch (e) {\n        /* ignore set range errors */\n      }\n    }\n  } catch (e) {\n    /* ignore ancestor expansion errors */\n  }\n\n  const content = range.extractContents();\n\n  // Aggressive cleaning pass: unwrap any remaining marked nodes inside the\n  // extracted content by moving into a temporary container and repeatedly\n  // replacing marked elements with their children (or converting headings).\n  try {\n    const container = doc.createElement(\"div\");\n    container.appendChild(content);\n    let seen = 0;\n    while (true) {\n      const el = container.querySelector('[data-rhe-format=\"true\"]');\n      if (!el) break;\n      const tagName = el.tagName;\n      if (/^H[1-6]$/.test(tagName)) {\n        const p = doc.createElement(\"p\");\n        while (el.firstChild) p.appendChild(el.firstChild);\n        el.parentNode?.replaceChild(p, el);\n      } else {\n        // remove inline styles and unwrap\n        try {\n          (el as HTMLElement).style.cssText = \"\";\n        } catch (e) {\n          /* ignore style set errors */\n        }\n        const frag = doc.createDocumentFragment();\n        while (el.firstChild) frag.appendChild(el.firstChild);\n        el.parentNode?.replaceChild(frag, el);\n      }\n      seen++;\n      // defensive: avoid infinite loops\n      if (seen > 200) break;\n    }\n    // build a cleaned fragment to continue processing\n    const cleaned = doc.createDocumentFragment();\n    while (container.firstChild) cleaned.appendChild(container.firstChild);\n    // replace original content with cleaned fragment\n    // (content was moved into container, so use cleaned)\n    // continue using 'content' variable as the cleaned fragment\n    // by reassigning via a temporary variable\n    // (we'll use 'contentToInsert' below)\n    var contentToInsert = cleaned;\n\n    // replace content variable for downstream cleaning steps\n    // (note: content is not reused directly after this, so we will use contentToInsert)\n\n    // Use contentToInsert for the rest of the cleaning below\n    // We'll set 'content' back to contentToInsert by appending its children\n    while (contentToInsert.firstChild)\n      content.appendChild(contentToInsert.firstChild);\n  } catch (e) {\n    /* aggressive cleaning failed; ignore and continue */\n  }\n\n  // Recursively clean nodes that were created by this editor session\n  function cleanNode(node: Node) {\n    // logging removed for cleanliness\n    if (node.nodeType === Node.ELEMENT_NODE) {\n      const el = node as HTMLElement;\n\n      // If element was created by editor, unwrap or replace depending on tag\n      const isMarked = el.dataset && el.dataset.rheFormat === \"true\";\n\n      const tag = el.tagName;\n      if (\n        isMarked &&\n        (tag === \"STRONG\" ||\n          tag === \"B\" ||\n          tag === \"EM\" ||\n          tag === \"I\" ||\n          tag === \"U\" ||\n          tag === \"S\")\n      ) {\n        // replace element with its children and continue cleaning those children\n        const frag = doc.createDocumentFragment();\n        while (el.firstChild) frag.appendChild(el.firstChild);\n        const parent = el.parentNode as Node | null;\n        if (parent) parent.replaceChild(frag, el);\n        // clean any nodes that were moved up into the fragment location\n        Array.from(frag.childNodes).forEach((c) => cleanNode(c));\n        return;\n      }\n\n      if (isMarked && tag === \"SPAN\") {\n        // remove inline styles applied by editor and unwrap\n        el.style.cssText = \"\";\n        const frag = doc.createDocumentFragment();\n        while (el.firstChild) frag.appendChild(el.firstChild);\n        const parent = el.parentNode as Node | null;\n        if (parent) parent.replaceChild(frag, el);\n        Array.from(frag.childNodes).forEach((c) => cleanNode(c));\n        return;\n      }\n\n      if (isMarked && /^H[1-6]$/.test(tag)) {\n        // convert heading to paragraph\n        const p = doc.createElement(\"p\");\n        while (el.firstChild) p.appendChild(el.firstChild);\n        const parent = el.parentNode as Node | null;\n        if (parent) parent.replaceChild(p, el);\n        // continue cleaning inside the new paragraph\n        Array.from(p.childNodes).forEach((c) => cleanNode(c));\n        return;\n      }\n\n      // Otherwise, clean inline styles on marked elements\n      if (isMarked) {\n        el.style.cssText = \"\";\n      }\n\n      // Recurse into children\n      Array.from(el.childNodes).forEach((c) => cleanNode(c));\n    }\n  }\n\n  // Traverse and clean\n  Array.from(content.childNodes).forEach((n) => cleanNode(n));\n\n  // Insert cleaned content wrapped so selection can be restored\n  const wrapper = doc.createElement(\"span\");\n  wrapper.appendChild(content);\n  range.insertNode(wrapper);\n  sel.removeAllRanges();\n  const newRange = doc.createRange();\n  newRange.selectNodeContents(wrapper);\n  sel.addRange(newRange);\n\n  // Unwrap wrapper while keeping selection (selection references the nodes)\n  const parent = wrapper.parentElement;\n  if (parent) {\n    const frag = doc.createDocumentFragment();\n    while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);\n    parent.replaceChild(frag, wrapper);\n  }\n\n  // Final cleanup: ensure no leftover editor-marked elements remain\n  const root = parent || doc.body;\n  const leftover = Array.from(\n    (root as Element).querySelectorAll('[data-rhe-format=\"true\"]'),\n  );\n  leftover.forEach((el) => {\n    const tag = el.tagName;\n    if (/^H[1-6]$/.test(tag)) {\n      const p = doc.createElement(\"p\");\n      while (el.firstChild) p.appendChild(el.firstChild);\n      el.parentElement?.replaceChild(p, el);\n      return;\n    }\n    // unwrap element (move children up); if empty, just remove\n    if (el.firstChild) {\n      const frag = doc.createDocumentFragment();\n      while (el.firstChild) frag.appendChild(el.firstChild);\n      el.parentElement?.replaceChild(frag, el);\n    } else {\n      el.parentElement?.removeChild(el);\n    }\n  });\n\n  // If the selection was inside a heading element that was marked, convert it to a paragraph\n  const possibleBlock = findBlockAncestor(range.startContainer);\n  if (\n    possibleBlock &&\n    possibleBlock.dataset.rheFormat === \"true\" &&\n    /^H[1-6]$/.test(possibleBlock.tagName)\n  ) {\n    const p = doc.createElement(\"p\");\n    while (possibleBlock.firstChild) p.appendChild(possibleBlock.firstChild);\n    possibleBlock.parentElement?.replaceChild(p, possibleBlock);\n  }\n}\n","import {\n  _getCurrentEditable,\n  _setCurrentEditable,\n  pushStandaloneSnapshot,\n  _getUndoStack,\n  _getRedoStack,\n} from \"../core/state\";\nimport { isEditableCandidate } from \"./candidates\";\nimport { openImageEditor } from \"./imageEditor\";\nimport { injectToolbar } from \"../toolbar/toolbar\";\nimport { computeFormatState, getElementLabel } from \"./format\";\nimport { handleToolbarCommand, handleUndo, handleRedo } from \"../core/commands\";\nimport { CLASS_ACTIVE } from \"../core/constants\";\n\n/**\n * Attach DOM event handlers to the document\n *\n * Handles:\n * - Click: Enables editing on valid elements\n * - Selection change: Updates toolbar state\n * - Input: Creates undo/redo snapshots\n *\n * @param doc - Document to attach handlers to\n */\nexport function attachStandaloneHandlers(doc: Document) {\n  // Assign stable data-rhe-id markers to likely editable candidates so\n  // snapshots include identifiers for selective restoration. Limit the\n  // selector to common content containers to avoid a full DOM walk.\n  try {\n    const selector = [\n      \"p\",\n      \"div\",\n      \"section\",\n      \"article\",\n      \"header\",\n      \"footer\",\n      \"aside\",\n      \"nav\",\n      \"span\",\n      \"h1\",\n      \"h2\",\n      \"h3\",\n      \"h4\",\n      \"h5\",\n      \"h6\",\n      \"li\",\n      \"figure\",\n      \"figcaption\",\n      \"blockquote\",\n      \"pre\",\n      \"code\",\n    ].join(\",\");\n    const candidates = Array.from(\n      doc.querySelectorAll<HTMLElement>(selector),\n    ).filter((el) => isEditableCandidate(el));\n    candidates.forEach((target) => {\n      if (!target.hasAttribute(\"data-rhe-id\")) {\n        const uid = `rhe-init-${Date.now()}-${Math.random()\n          .toString(36)\n          .slice(2, 7)}`;\n        try {\n          target.setAttribute(\"data-rhe-id\", uid);\n        } catch (err) {\n          /* ignore */\n        }\n      }\n    });\n  } catch (err) {\n    /* ignore initialization errors */\n  }\n\n  doc.addEventListener(\n    \"click\",\n    (e) => {\n      const target = e.target as HTMLElement;\n      // If an image was clicked, open the image editor modal\n      if (target && target.tagName === \"IMG\") {\n        try {\n          openImageEditor(doc, target as HTMLImageElement);\n        } catch (err) {\n          /* ignore */\n        }\n        e.preventDefault();\n        e.stopPropagation();\n        return;\n      }\n      if (!isEditableCandidate(target)) return;\n      if (_getCurrentEditable() && _getCurrentEditable() !== target) {\n        _getCurrentEditable()?.removeAttribute(\"contenteditable\");\n        _getCurrentEditable()?.classList.remove(CLASS_ACTIVE);\n      }\n      // Ensure the editable element has a stable identifier so snapshots\n      // can restore only the editable region without touching the rest\n      // of the page (header, nav, scripts, etc.). Use a data attribute\n      // to avoid clashing with page ids.\n      if (!target.hasAttribute(\"data-rhe-id\")) {\n        const uid = `rhe-${Date.now()}-${Math.random()\n          .toString(36)\n          .slice(2, 7)}`;\n        try {\n          target.setAttribute(\"data-rhe-id\", uid);\n        } catch (err) {\n          /* ignore attribute set errors */\n        }\n      }\n      _setCurrentEditable(target);\n      target.classList.add(CLASS_ACTIVE);\n      target.setAttribute(\"contenteditable\", \"true\");\n      target.focus();\n    },\n    true,\n  );\n  doc.addEventListener(\"selectionchange\", () => {\n    injectToolbar(doc, {\n      onCommand: handleToolbarCommand,\n      canUndo: () => _getUndoStack().length > 1,\n      canRedo: () => _getRedoStack().length > 0,\n      onUndo: handleUndo,\n      onRedo: handleRedo,\n      getFormatState: () => computeFormatState(doc),\n      getSelectedElementInfo: () => getElementLabel(_getCurrentEditable()),\n    });\n  });\n  doc.addEventListener(\"input\", () => pushStandaloneSnapshot(), true);\n\n  // Keyboard shortcuts for common formatting and undo/redo\n  doc.addEventListener(\n    \"keydown\",\n    (e) => {\n      const meta = e.ctrlKey || e.metaKey;\n      if (!meta) return;\n      const key = e.key.toLowerCase();\n      // Bold: Ctrl/Cmd+B\n      if (key === \"b\") {\n        e.preventDefault();\n        handleToolbarCommand(\"bold\");\n        return;\n      }\n      // Italic: Ctrl/Cmd+I\n      if (key === \"i\") {\n        e.preventDefault();\n        handleToolbarCommand(\"italic\");\n        return;\n      }\n      // Underline: Ctrl/Cmd+U\n      if (key === \"u\") {\n        e.preventDefault();\n        handleToolbarCommand(\"underline\");\n        return;\n      }\n      // Undo: Ctrl/Cmd+Z\n      if (key === \"z\") {\n        e.preventDefault();\n        // If Shift is pressed, treat as redo\n        if (e.shiftKey) {\n          handleRedo();\n        } else {\n          handleUndo();\n        }\n        return;\n      }\n      // Redo: Ctrl/Cmd+Y\n      if (key === \"y\") {\n        e.preventDefault();\n        handleRedo();\n        return;\n      }\n    },\n    true,\n  );\n\n  // Ensure Enter in lists creates a new list item (consistent across browsers)\n  doc.addEventListener(\n    \"keydown\",\n    (e) => {\n      if (e.key !== \"Enter\") return;\n      // Let Shift+Enter behave as a soft-break\n      if (e.shiftKey) return;\n      const sel = doc.getSelection();\n      if (!sel || !sel.rangeCount) return;\n      const node = sel.anchorNode;\n      const el =\n        node && node.nodeType === Node.ELEMENT_NODE\n          ? (node as HTMLElement)\n          : (node && (node as Node).parentElement) || null;\n      if (!el) return;\n      const li = el.closest(\"li\") as HTMLElement | null;\n      if (!li || !li.parentElement) return;\n      // Prevent default behavior and insert a new empty <li>\n      e.preventDefault();\n      const list = li.parentElement;\n      const newLi = doc.createElement(\"li\");\n      const zw = doc.createTextNode(\"\\u200B\");\n      newLi.appendChild(zw);\n      if (li.nextSibling) list.insertBefore(newLi, li.nextSibling);\n      else list.appendChild(newLi);\n      // place caret inside the new li\n      const range = doc.createRange();\n      range.setStart(zw, 1);\n      range.collapse(true);\n      sel.removeAllRanges();\n      sel.addRange(range);\n      // push snapshot will be triggered by input event after typing\n    },\n    true,\n  );\n}\n","import {\n  _setDoc,\n  _getDoc,\n  _setUndoStack,\n  _getUndoStack,\n  _setRedoStack,\n  _getRedoStack,\n  _setCurrentEditable,\n  _getCurrentEditable,\n  pushStandaloneSnapshot,\n} from \"./state\";\nimport { injectStyles } from \"../dom/styles\";\nimport { injectToolbar } from \"../toolbar/toolbar\";\nimport { attachStandaloneHandlers } from \"../dom/handlers\";\nimport { computeFormatState, getElementLabel } from \"../dom/format\";\nimport { handleUndo, handleRedo, handleToolbarCommand } from \"./commands\";\nimport type { EditorConfig } from \"./types\";\nimport { sanitizeHtml } from \"../utils/sanitize\";\nimport {\n  TOOLBAR_ID,\n  STYLE_ID,\n  CLASS_EDITABLE,\n  CLASS_ACTIVE,\n} from \"./constants\";\n\n/**\n * Initialize the rich HTML editor on an iframe element\n */\nexport function initRichEditor(\n  iframe: HTMLIFrameElement,\n  config?: EditorConfig,\n) {\n  try {\n    if (!iframe || !(iframe instanceof HTMLIFrameElement)) {\n      throw new Error(\"Invalid iframe element provided to initRichEditor\");\n    }\n\n    const doc = iframe.contentDocument;\n    if (!doc) {\n      throw new Error(\n        \"Unable to access iframe contentDocument. Ensure iframe src is same-origin.\",\n      );\n    }\n\n    _setDoc(doc);\n    injectStyles(doc);\n    _setUndoStack([]);\n    _setRedoStack([]);\n    _setCurrentEditable(null);\n    if (config?.maxStackSize) {\n      import(\"./state\")\n        .then((m) => m.setMaxStackSize(config.maxStackSize!))\n        .catch(() => {\n          /* ignore */\n        });\n    }\n    attachStandaloneHandlers(doc);\n    pushStandaloneSnapshot();\n    injectToolbar(doc, {\n      onCommand: handleToolbarCommand,\n      canUndo: () => _getUndoStack().length > 1,\n      canRedo: () => _getRedoStack().length > 0,\n      onUndo: handleUndo,\n      onRedo: handleRedo,\n      getFormatState: () => computeFormatState(doc),\n      getSelectedElementInfo: () => getElementLabel(_getCurrentEditable()),\n    });\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Failed to initialize editor:\", message);\n    throw error;\n  }\n}\n\nexport function getCleanHTML(): string {\n  try {\n    const doc = _getDoc();\n    if (!doc) {\n      console.warn(\n        \"[rich-html-editor] getCleanHTML called before editor initialization\",\n      );\n      return \"\";\n    }\n    if (!doc.documentElement) {\n      throw new Error(\"Document is missing documentElement\");\n    }\n\n    const clone = doc.documentElement.cloneNode(true) as HTMLElement;\n\n    // Remove injected toolbar and style elements if present\n    const toolbarNode = clone.querySelector(`#${TOOLBAR_ID}`);\n    if (toolbarNode && toolbarNode.parentNode)\n      toolbarNode.parentNode.removeChild(toolbarNode);\n    const styleNode = clone.querySelector(`#${STYLE_ID}`);\n    if (styleNode && styleNode.parentNode)\n      styleNode.parentNode.removeChild(styleNode);\n\n    // Recursively clean root and descendants\n    try {\n      const cleanElement = (el: Element) => {\n        try {\n          // remove boolean/content attributes explicitly\n          if (el.hasAttribute(\"contenteditable\"))\n            el.removeAttribute(\"contenteditable\");\n          if (el.hasAttribute(\"tabindex\")) el.removeAttribute(\"tabindex\");\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          const attrs = Array.from(el.attributes || []);\n          attrs.forEach((a) => {\n            const rawName = a.name;\n            const name = rawName.toLowerCase();\n\n            // remove inline event handlers\n            if (name.startsWith(\"on\")) {\n              try {\n                el.removeAttribute(rawName);\n              } catch (e) {\n                /* ignore */\n              }\n              return;\n            }\n\n            // remove any data-rhe-* attributes (including data-rhe-id)\n            if (\n              name === \"data-rhe-id\" ||\n              name.startsWith(\"data-rhe-\") ||\n              name === \"data-rhe\"\n            ) {\n              try {\n                el.removeAttribute(rawName);\n              } catch (e) {\n                /* ignore */\n              }\n              return;\n            }\n          });\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          if (el.id) {\n            const id = el.id;\n            if (\n              id === TOOLBAR_ID ||\n              id === STYLE_ID ||\n              id.startsWith(\"editor-\") ||\n              id.startsWith(\"rhe-\")\n            ) {\n              el.removeAttribute(\"id\");\n            }\n          }\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          const cls = Array.from(el.classList || []);\n          cls.forEach((c) => {\n            if (\n              c === CLASS_EDITABLE ||\n              c === CLASS_ACTIVE ||\n              c.startsWith(\"editor-\") ||\n              c.startsWith(\"rhe-\")\n            ) {\n              try {\n                el.classList.remove(c);\n              } catch (e) {\n                /* ignore */\n              }\n            }\n          });\n\n          // remove empty class attributes left behind\n          if (\n            el.hasAttribute(\"class\") &&\n            (el.getAttribute(\"class\") || \"\").trim() === \"\"\n          ) {\n            try {\n              el.removeAttribute(\"class\");\n            } catch (e) {\n              /* ignore */\n            }\n          }\n        } catch (e) {\n          /* ignore */\n        }\n\n        try {\n          const children = Array.from(el.children || []);\n          children.forEach((child) => cleanElement(child as Element));\n        } catch (e) {\n          /* ignore */\n        }\n      };\n\n      // `instanceof Element` can fail across window/iframe boundaries\n      // because each iframe has its own global `Element` constructor.\n      // Use a cross-realm-safe check instead.\n      if ((clone as Node).nodeType === Node.ELEMENT_NODE) {\n        cleanElement(clone as Element);\n      }\n    } catch (e) {\n      /* ignore traversal errors */\n    }\n\n    // Preserve original scripts intentionally.\n    return \"<!doctype html>\\n\" + clone.outerHTML;\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Failed to get clean HTML:\", message);\n    throw error;\n  }\n}\n\nexport function getSanitizedHTML(): string {\n  try {\n    const doc = _getDoc();\n    if (!doc) return \"\";\n    if (!doc.documentElement)\n      throw new Error(\"Document is missing documentElement\");\n    const raw = \"<!doctype html>\\n\" + doc.documentElement.outerHTML;\n    return sanitizeHtml(raw, doc);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[rich-html-editor] Failed to get sanitized HTML:\", message);\n    throw error;\n  }\n}\n","import { initRichEditor, getCleanHTML } from \"./core/editor\";\nimport type { EditorConfig } from \"./core/types\";\n\nexport default class RichHtmlEditor {\n  private iframeWindow!: Window;\n  private iframeEl?: HTMLIFrameElement;\n  private config?: EditorConfig;\n\n  constructor(\n    options: {\n      iframe: Window | HTMLIFrameElement | string;\n    } & Partial<EditorConfig>,\n  ) {\n    const { iframe, ...cfg } = options as any;\n    this.config = Object.keys(cfg).length ? (cfg as EditorConfig) : undefined;\n\n    if (typeof iframe === \"string\") {\n      const el = document.querySelector(iframe);\n      if (!el) throw new Error(`Iframe selector \"${iframe}\" not found`);\n      if (!(el instanceof HTMLIFrameElement))\n        throw new Error(`Selector \"${iframe}\" did not resolve to an iframe`);\n      if (!el.contentWindow) throw new Error(\"Iframe has no contentWindow\");\n      this.iframeEl = el;\n      this.iframeWindow = el.contentWindow;\n    } else if (iframe && (iframe as HTMLIFrameElement).contentWindow) {\n      const el = iframe as HTMLIFrameElement;\n      if (!el.contentWindow) throw new Error(\"Iframe has no contentWindow\");\n      this.iframeEl = el;\n      this.iframeWindow = el.contentWindow;\n    } else if (iframe && (iframe as Window).document) {\n      this.iframeWindow = iframe as Window;\n      // Try to locate the corresponding iframe element in the current document\n      try {\n        const candidates = Array.from(\n          document.querySelectorAll(\"iframe\"),\n        ) as HTMLIFrameElement[];\n        const found = candidates.find(\n          (f) => f.contentWindow === this.iframeWindow,\n        );\n        if (found) this.iframeEl = found;\n      } catch (e) {\n        /* ignore cross-origin or DOM errors */\n      }\n    } else {\n      throw new Error(\n        \"Invalid `iframe` option. Provide a `Window`, `HTMLIFrameElement`, or selector string.\",\n      );\n    }\n  }\n\n  init() {\n    if (!this.iframeEl) {\n      throw new Error(\n        \"Unable to initialize: iframe element not available. Provide an iframe element or selector.\",\n      );\n    }\n    initRichEditor(this.iframeEl, this.config);\n  }\n\n  getHTML() {\n    return getCleanHTML();\n  }\n\n  static attachToWindow(force = false) {\n    if (typeof window === \"undefined\") return;\n    if (!(window as any).RichHtmlEditor || force) {\n      (window as any).RichHtmlEditor = RichHtmlEditor;\n    }\n  }\n}\n\ndeclare global {\n  interface Window {\n    RichHtmlEditor?: typeof RichHtmlEditor;\n  }\n}\n\nif (typeof window !== \"undefined\") {\n  RichHtmlEditor.attachToWindow();\n}\n"],"mappings":"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","names":["input","makeButton","makeSelect","makeGroup","makeSep","err","newRange","li","list","getMarkedAncestors","parent","_a","_b","_c"]}